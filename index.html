<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#050510">
<meta name="robots" content="noindex,nofollow">
<title>Sports Analysis v6.1</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600;700;900&display=swap');
:root {
  --primary:#1a472a;--primary-light:#00c851;--secondary:#07071a;--accent:#ff6b35;
  --gold:#ffd700;--gold2:#ffaa00;--danger:#ff3547;--bg:#050510;
  --card:#0d0d20;--card2:#13132a;--card3:#18183a;
  --text:#e8e8f5;--text2:#7878a0;--border:#22224a;--green:#00c851;--red:#ff3547;
  --blue:#4a9eff;--orange:#ff9800;--purple:#a855f7;--ml:#00bcd4;
  --giant:#00c851;--chaos:#ff9800;--blanket:#ff3547;--neutral:#7878a0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;font-size:13px;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 0%,rgba(0,200,81,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(255,215,0,.05) 0%,transparent 50%);pointer-events:none;z-index:0;}

.header{background:linear-gradient(135deg,#0f0f2a,#07071a);border-bottom:2px solid rgba(255,215,0,.4);padding:10px 15px;text-align:center;position:sticky;top:0;z-index:1000;}
.header-title{font-family:'Rajdhani',sans-serif;font-size:19px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:3px;}
.header-sub{font-size:9px;color:var(--text2);margin-top:2px;}
.accuracy-badge{display:inline-block;background:linear-gradient(135deg,var(--green),#007a30);color:#000;padding:3px 12px;border-radius:20px;font-size:9px;font-weight:700;margin-top:5px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

.data-quality-bar{background:linear-gradient(90deg,#0a0a1f,#0f102a,#0a0a1f);border-bottom:1px solid var(--purple);padding:5px 12px;display:flex;align-items:center;justify-content:space-between;font-size:9px;gap:6px;flex-wrap:wrap;}
.dq-item{display:flex;align-items:center;gap:4px;}
.dq-dot{width:6px;height:6px;border-radius:50%;}
.dq-dot.real{background:var(--green);box-shadow:0 0 6px var(--green);}
.dq-dot.static{background:var(--orange);}
.dq-dot.loading{background:var(--blue);animation:blink .8s infinite;}
.dq-label{color:var(--text2)}.dq-value{color:var(--text);font-weight:700}

.live-status-bar{background:linear-gradient(90deg,#060f06,#0a1a0a,#060f06);border-bottom:1px solid rgba(0,200,81,.3);padding:7px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 1s infinite;}
.live-dot.offline{background:var(--red);animation:none;}
.live-dot.loading{background:var(--blue);animation:blink .5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.countdown-box{background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.4);border-radius:6px;padding:4px 10px;font-size:12px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif;min-width:75px;text-align:center;}
.refresh-btn{background:rgba(0,200,81,.1);border:1px solid var(--green);border-radius:5px;color:var(--green);font-size:9px;font-weight:700;padding:4px 9px;cursor:pointer;transition:all .2s;}
.refresh-btn:hover{background:var(--green);color:#000;}

.tabs{display:flex;background:var(--secondary);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex:0 0 auto;padding:9px 10px;font-size:9px;font-weight:700;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-1px;text-align:center;text-transform:uppercase;letter-spacing:.5px;transition:all .2s;white-space:nowrap;}
.tab.active{color:var(--primary-light);border-bottom-color:var(--primary-light);background:rgba(0,200,81,.07);}
.badge-count{background:var(--red);color:#fff;font-size:8px;font-weight:900;padding:1px 4px;border-radius:7px;min-width:14px;text-align:center;display:none;}
.badge-count.show{display:inline-block;}

.section{display:none;padding:10px;padding-bottom:90px;}
.section.active{display:block;}

.stats-loader{background:linear-gradient(135deg,rgba(168,85,247,.08),rgba(0,200,81,.04));border:1px solid rgba(168,85,247,.3);border-radius:8px;padding:10px;margin-bottom:10px;display:flex;align-items:center;gap:10px;}
.stats-loader-icon{font-size:20px;}
.stats-loader-title{font-size:11px;font-weight:700;color:var(--purple);margin-bottom:2px;}
.stats-loader-text{font-size:10px;color:var(--text2);}
.stats-progress-bar{height:4px;background:var(--card3);border-radius:2px;margin-top:5px;overflow:hidden;}
.stats-progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--green));border-radius:2px;transition:width .5s ease;width:0%;}

.alert{background:rgba(255,53,71,.1);border:1px solid var(--red);border-radius:7px;padding:8px 10px;margin:6px 0;font-size:10px;color:var(--red);}
.alert-warning{background:rgba(255,152,0,.1);border-color:var(--orange);color:var(--orange);}
.alert-success{background:rgba(0,200,81,.1);border-color:var(--green);color:var(--green);}
.alert-info{background:rgba(74,158,255,.1);border-color:var(--blue);color:var(--blue);}
.alert-purple{background:rgba(168,85,247,.1);border-color:var(--purple);color:var(--purple);}
.alert-gold{background:rgba(255,215,0,.08);border-color:rgba(255,215,0,.4);color:var(--gold);}

.obr-badge{display:inline-flex;align-items:center;gap:3px;font-size:8px;font-weight:900;padding:2px 7px;border-radius:4px;text-transform:uppercase;}
.obr-giant{background:rgba(0,200,81,.2);color:var(--green);border:1px solid rgba(0,200,81,.3);}
.obr-chaos{background:rgba(255,152,0,.2);color:var(--orange);border:1px solid rgba(255,152,0,.3);}
.obr-blanket{background:rgba(255,53,71,.2);color:var(--red);border:1px solid rgba(255,53,71,.3);}
.obr-neutral{background:rgba(120,120,160,.2);color:var(--text2);border:1px solid rgba(120,120,160,.2);}

/* PRED CARDS */
.pred-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;position:relative;overflow:hidden;}
.pred-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--green),transparent);}
.pred-card.ultra{border-color:rgba(255,215,0,.5);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(0,0,0,0));box-shadow:0 0 20px rgba(255,215,0,.1);}
.pred-card.ultra::before{background:linear-gradient(90deg,transparent,var(--gold),transparent);}

.pred-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
.pred-match-name{font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:900;color:var(--gold);}
.pred-league-tag{font-size:9px;color:var(--text2);background:var(--card2);padding:2px 6px;border-radius:4px;margin-top:3px;display:inline-block;}
.pred-conf-badge{font-size:15px;font-weight:900;padding:5px 12px;border-radius:10px;font-family:'Rajdhani',sans-serif;}
.conf-ultra{background:rgba(255,215,0,.15);color:var(--gold);border:1px solid rgba(255,215,0,.3);}
.conf-high{background:rgba(0,200,81,.15);color:var(--green);border:1px solid rgba(0,200,81,.3);}

.gate-banner{border-radius:7px;padding:8px 12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;border:1px solid;}
.gate-pass{border-color:rgba(0,200,81,.5);background:rgba(0,200,81,.06);}
.gate-fail{border-color:rgba(255,53,71,.5);background:rgba(255,53,71,.06);}
.gate-label{font-size:10px;font-weight:900;font-family:'Rajdhani',sans-serif;letter-spacing:1px;text-transform:uppercase;}
.gate-detail{font-size:8px;margin-top:1px;opacity:.8;}

.pred-main-bet{background:linear-gradient(135deg,rgba(0,200,81,.1),rgba(0,100,40,.05));border:1px solid rgba(0,200,81,.3);border-radius:8px;padding:10px 14px;text-align:center;margin-bottom:10px;}
.pred-bet-label{font-size:8px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.pred-bet-value{font-size:20px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif;}

.obr-panel{background:linear-gradient(135deg,rgba(74,158,255,.06),rgba(0,200,81,.03));border:1px solid rgba(74,158,255,.25);border-radius:8px;padding:10px;margin-bottom:8px;}
.obr-panel-title{font-size:9px;font-weight:900;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.obr-team-row{display:flex;justify-content:space-between;align-items:center;background:var(--card2);border-radius:6px;padding:7px 10px;margin-bottom:5px;}
.obr-team-name{font-size:11px;font-weight:700;color:var(--gold);font-family:'Rajdhani',sans-serif;}
.obr-stats-row{display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-top:3px;}
.obr-stat-pill{font-size:7.5px;font-weight:700;padding:2px 5px;border-radius:3px;}
.osp-gs{background:rgba(0,200,81,.15);color:var(--green);}
.osp-gc{background:rgba(255,53,71,.15);color:var(--red);}
.osp-obr{background:rgba(255,215,0,.15);color:var(--gold);}
.osp-wr{background:rgba(74,158,255,.15);color:var(--blue);}

/* PREVENTION PANEL */
.prevention-panel{background:linear-gradient(135deg,rgba(168,85,247,.07),rgba(0,188,212,.03));border:1px solid rgba(168,85,247,.3);border-radius:8px;padding:10px;margin-bottom:8px;}
.prevention-title{font-size:9px;font-weight:900;color:var(--purple);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.prev-check{display:flex;align-items:flex-start;gap:7px;padding:4px 0;border-bottom:1px solid rgba(34,34,74,.3);}
.prev-check:last-child{border-bottom:none;}
.prev-icon{font-size:10px;min-width:14px;padding-top:1px;}
.prev-body{flex:1;}
.prev-name{font-size:8px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;}
.prev-result{font-size:7.5px;line-height:1.4;margin-top:1px;}
.prev-pill{font-size:7.5px;font-weight:900;padding:2px 5px;border-radius:3px;white-space:nowrap;}
.pp-safe{background:rgba(0,200,81,.15);color:var(--green);}
.pp-warn{background:rgba(255,152,0,.15);color:var(--orange);}
.pp-block{background:rgba(255,53,71,.15);color:var(--red);}

.failstate-panel{background:rgba(255,152,0,.06);border:1px solid rgba(255,152,0,.3);border-radius:8px;padding:10px;margin-bottom:8px;}
.failstate-panel.all-clear{background:rgba(0,200,81,.05);border-color:rgba(0,200,81,.3);}
.failstate-title{font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.fs-check{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid rgba(34,34,74,.3);}
.fs-check:last-child{border-bottom:none;}
.fs-icon{font-size:11px;min-width:16px;padding-top:1px;}
.fs-body{flex:1;}
.fs-name{font-size:8px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;}
.fs-formula{font-size:7.5px;color:var(--text2);font-family:monospace;margin:2px 0;word-break:break-all;line-height:1.4;}
.fs-result{font-size:8px;font-weight:700;}
.fs-explanation{font-size:7.5px;line-height:1.4;margin-top:2px;}
.fs-value-pill{font-size:8px;font-weight:900;padding:2px 6px;border-radius:4px;white-space:nowrap;font-family:'Rajdhani',sans-serif;}
.fvp-pass{background:rgba(0,200,81,.15);color:var(--green);border:1px solid rgba(0,200,81,.2);}
.fvp-fail{background:rgba(255,53,71,.15);color:var(--red);border:1px solid rgba(255,53,71,.2);}
.fvp-na{background:rgba(120,120,160,.1);color:var(--text2);}

.analysis-panel{background:linear-gradient(135deg,rgba(74,158,255,.05),rgba(0,200,81,.03));border:1px solid rgba(74,158,255,.25);border-radius:8px;padding:9px;margin-bottom:8px;}
.analysis-title{font-size:9px;font-weight:900;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.analysis-row{display:flex;justify-content:space-between;align-items:center;font-size:9px;padding:3px 0;border-bottom:1px solid rgba(34,34,74,.4);}
.analysis-row:last-child{border-bottom:none;}
.al{color:var(--text2);}.av{font-weight:700;color:var(--text);}
.analysis-verdict{border-radius:6px;padding:7px 10px;margin-top:7px;font-size:10px;font-weight:600;line-height:1.5;}
.av-safe{background:rgba(0,200,81,.1);border:1px solid rgba(0,200,81,.3);color:var(--green);}
.av-caution{background:rgba(255,152,0,.1);border:1px solid rgba(255,152,0,.3);color:var(--orange);}
.av-danger{background:rgba(255,53,71,.1);border:1px solid rgba(255,53,71,.3);color:var(--red);}

.form-row{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px;}
.form-box{width:18px;height:18px;border-radius:3px;font-size:8px;font-weight:900;display:flex;align-items:center;justify-content:center;}
.fb-over{background:rgba(0,200,81,.3);color:var(--green);}
.fb-under{background:rgba(255,53,71,.3);color:var(--red);}
.fb-na{background:rgba(100,100,130,.3);color:var(--text2);}

.card-countdown{display:flex;align-items:center;justify-content:center;gap:5px;font-size:10px;color:var(--text2);background:var(--card2);border-radius:6px;padding:6px;}
.cc-time{color:var(--orange);font-weight:700;font-family:'Rajdhani',sans-serif;font-size:13px;}
.cc-time.urgent{color:var(--red);animation:pulse 1s infinite;}
.cc-time.live{color:var(--green);animation:pulse 1s infinite;}

/* RESULTS */
.results-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;}
.res-stat{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;}
.res-stat-val{font-size:22px;font-weight:900;font-family:'Rajdhani',sans-serif;}
.res-stat-lbl{font-size:7px;color:var(--text2);text-transform:uppercase;margin-top:2px;}
.res-accuracy-bar{height:8px;background:var(--card3);border-radius:4px;overflow:hidden;margin-bottom:10px;}
.res-accuracy-fill{height:100%;border-radius:4px;transition:width .5s ease;}

.result-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px;position:relative;}
.result-card.correct{border-color:rgba(0,200,81,.4);border-left:4px solid var(--green);}
.result-card.incorrect{border-color:rgba(255,53,71,.4);border-left:4px solid var(--red);}
.result-card.pending{border-color:rgba(255,152,0,.4);border-left:4px solid var(--orange);}
.result-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.result-match{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:900;color:var(--gold);}
.result-outcome-badge{font-size:12px;font-weight:900;padding:3px 10px;border-radius:8px;font-family:'Rajdhani',sans-serif;}
.rob-correct{background:rgba(0,200,81,.2);color:var(--green);border:1px solid rgba(0,200,81,.3);}
.rob-incorrect{background:rgba(255,53,71,.2);color:var(--red);border:1px solid rgba(255,53,71,.3);}
.rob-pending{background:rgba(255,152,0,.2);color:var(--orange);border:1px solid rgba(255,152,0,.3);}
.result-scores{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.score-box{background:var(--card2);border-radius:6px;padding:6px 8px;text-align:center;}
.score-label{font-size:8px;color:var(--text2);text-transform:uppercase;margin-bottom:2px;}
.score-value{font-size:15px;font-weight:900;font-family:'Rajdhani',sans-serif;}
.result-detail{font-size:9px;color:var(--text2);line-height:1.5;}
.failure-insight{font-size:8px;color:var(--orange);background:rgba(255,152,0,.08);border:1px solid rgba(255,152,0,.2);border-radius:5px;padding:5px 8px;margin-top:6px;}

/* STATS TAB */
.team-stats-table{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;overflow-x:auto;}
.table-title{font-size:11px;font-weight:700;color:var(--purple);margin-bottom:8px;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center;}
table{width:100%;border-collapse:collapse;font-size:10px;}
th{color:var(--text2);font-size:8px;text-transform:uppercase;padding:4px 6px;text-align:center;border-bottom:1px solid var(--border);white-space:nowrap;}
td{padding:5px 6px;text-align:center;border-bottom:1px solid rgba(34,34,74,.5);}
tr:hover td{background:rgba(255,255,255,.02);}
.td-team{text-align:left;font-weight:700;color:var(--gold);font-family:'Rajdhani',sans-serif;}
.td-good{color:var(--green);font-weight:700;}
.td-bad{color:var(--red);font-weight:700;}
.td-mid{color:var(--orange);font-weight:700;}

/* ML */
.ml-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;}
.ml-panel-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--ml);text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;}
.ml-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.ml-stat{background:var(--card2);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(0,188,212,.2);}
.ml-stat-value{font-size:22px;font-weight:900;color:var(--ml);font-family:'Rajdhani',sans-serif;}
.ml-stat-label{font-size:8px;color:var(--text2);text-transform:uppercase;margin-top:2px;}
.learn-adj{display:flex;justify-content:space-between;align-items:center;background:var(--card2);border-radius:6px;padding:6px 10px;margin-bottom:5px;}
.learn-adj-name{font-size:10px;color:var(--text2);}
.learn-adj-val{font-size:12px;font-weight:700;font-family:'Rajdhani',sans-serif;}
.learn-log{background:var(--card2);border-radius:6px;padding:8px;max-height:150px;overflow-y:auto;font-size:8px;color:var(--text2);font-family:monospace;line-height:1.5;}
.download-btn{width:100%;padding:11px;background:linear-gradient(135deg,var(--ml),var(--purple));border:none;border-radius:8px;color:#000;font-size:12px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;font-family:'Rajdhani',sans-serif;transition:all .2s;margin-bottom:8px;}
.download-btn:hover{transform:scale(1.02);}
.clear-ml-btn{width:100%;padding:8px;background:rgba(255,53,71,.1);border:1px solid var(--red);border-radius:6px;color:var(--red);font-size:10px;font-weight:700;cursor:pointer;}

/* STRATEGIES */
.strategy-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px;}
.strategy-title{font-size:11px;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;}
.strategy-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.strategy-card{background:var(--card2);padding:8px;border-radius:6px;border-left:3px solid var(--primary-light);}
.strategy-name{font-size:9px;font-weight:700;color:var(--primary-light);margin-bottom:3px;}
.strategy-desc{font-size:8px;color:var(--text2);line-height:1.5;}

/* ACCA */
.acca-panel{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,152,0,.05));border:2px solid rgba(255,215,0,.5);border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 0 20px rgba(255,215,0,.08);}
.acca-title{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:900;color:var(--gold);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;text-align:center;}
.acca-legs{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
.acca-leg{background:var(--card2);border:1px solid rgba(0,200,81,.3);border-radius:7px;padding:8px;display:flex;justify-content:space-between;align-items:center;}
.acca-leg-match{font-size:12px;font-weight:700;color:var(--gold);font-family:'Rajdhani',sans-serif;}
.acca-leg-bet{font-size:10px;color:var(--green);font-weight:700;}
.acca-totals{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.3);border-radius:8px;padding:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;}
.acca-total-label{font-size:8px;color:var(--text2);text-transform:uppercase;}
.acca-total-value{font-size:18px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif;}

.empty-state{text-align:center;padding:40px 20px;color:var(--text2);}
.empty-icon{font-size:44px;margin-bottom:12px;}
.empty-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:6px;}
.empty-desc{font-size:11px;line-height:1.6;}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--secondary);border-top:1px solid var(--border);display:flex;z-index:1000;padding-bottom:env(safe-area-inset-bottom,0);overflow-x:auto;}
.bottom-nav-item{flex:0 0 auto;min-width:65px;display:flex;flex-direction:column;align-items:center;padding:7px 4px;cursor:pointer;color:var(--text2);font-size:7px;transition:all .2s;gap:2px;}
.bottom-nav-item .nav-icon{font-size:16px;}
.bottom-nav-item.active{color:var(--primary-light);background:rgba(0,200,81,.08);}
@keyframes spin{to{transform:rotate(360deg)}}

/* RESET CONFIRM BUTTON PULSE */
@keyframes resetPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,53,71,.4)}70%{box-shadow:0 0 0 6px rgba(255,53,71,0)}}
.reset-active{animation:resetPulse 1s ease-out;}

/* SESSION RESTORE BANNER */
#restoreBanner{animation:slideDown .3s ease-out;}
@keyframes slideDown{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}

/* SESSION STATUS PILL STATES */
#sessionPill{transition:all .3s ease;font-family:'Rajdhani',sans-serif;letter-spacing:.5px;}

/* ANTI-BOT: Prevent right-click context menu to reduce automated fingerprinting */
/* (JS handles this in the BOT object) */
</style>
</head>
<body>

<!-- SESSION RESTORE BANNER -->
<div id="restoreBanner" style="display:none;background:linear-gradient(90deg,rgba(74,158,255,.15),rgba(168,85,247,.1));border-bottom:2px solid rgba(74,158,255,.4);padding:8px 14px;text-align:center;">
  <div style="font-size:10px;font-weight:700;color:var(--blue)">üì± SESSION RESTORED ‚Äî Resuming from last active state</div>
  <div style="font-size:8px;color:var(--text2);margin-top:2px" id="restoreInfo">Loading saved data...</div>
</div>

<div class="header">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
    <button onclick="hardReset()" style="background:rgba(255,53,71,.12);border:1px solid rgba(255,53,71,.4);border-radius:6px;color:var(--red);font-size:8px;font-weight:700;padding:5px 9px;cursor:pointer;letter-spacing:.5px" title="Reset all data and start from zero">üîÑ RESET</button>
    <div class="header-title" style="font-size:16px">‚ö° OBR-X Engine <span style="background:linear-gradient(135deg,var(--purple),#6a0dad);color:#fff;padding:2px 6px;border-radius:8px;font-size:8px;margin-left:4px;">v6.1</span></div>
    <div id="sessionPill" style="background:rgba(0,200,81,.1);border:1px solid rgba(0,200,81,.3);border-radius:6px;padding:4px 8px;font-size:8px;font-weight:700;color:var(--green)">üü¢ LIVE</div>
  </div>
  <div class="header-sub">OBR-X ¬∑ 9 Formulas ¬∑ 6 Shields ¬∑ Persistent Session ¬∑ Anti-Detection</div>
  <div class="accuracy-badge" id="engineStatus">üß† Initializing OBR-X Engine...</div>
</div>

<div class="data-quality-bar">
  <div class="dq-item"><div class="dq-dot loading" id="dqDot"></div><span class="dq-label">Data:</span><span class="dq-value" id="dqStatus">Loading...</span></div>
  <div class="dq-item"><span class="dq-label">Teams:</span><span class="dq-value" id="dqTeams">0</span></div>
  <div class="dq-item"><span class="dq-label">Matches:</span><span class="dq-value" id="dqMatches">0</span></div>
  <div class="dq-item"><span class="dq-label">Giants:</span><span class="dq-value" style="color:var(--green)" id="dqGiants">0</span></div>
  <div class="dq-item"><span class="dq-label">Accuracy:</span><span class="dq-value" style="color:var(--gold)" id="dqAccuracy">‚Äî</span></div>
</div>

<div class="live-status-bar">
  <div style="display:flex;align-items:center;gap:5px;font-size:10px;font-weight:700"><div class="live-dot" id="liveDot"></div><span id="liveStatus">Connecting...</span></div>
  <div style="font-size:11px;font-weight:700;color:var(--gold)" id="seasonDisplay">Season --</div>
  <div style="font-size:11px;color:var(--text2)" id="matchdayDisplay">MD --</div>
  <div class="countdown-box" id="countdownDisplay">--:--</div>
  <button class="refresh-btn" onclick="initWithPersistence()">üîÑ Refresh</button>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('live')" id="tab-btn-live">üî¥ Live <span class="badge-count" id="liveBadge">0</span></div>
  <div class="tab" onclick="showTab('results')" id="tab-btn-results">üìã Results <span class="badge-count" id="resultsBadge">0</span></div>
  <div class="tab" onclick="showTab('stats')" id="tab-btn-stats">üìä OBR Stats</div>
  <div class="tab" onclick="showTab('mldata')" id="tab-btn-mldata">üß† ML</div>
  <div class="tab" onclick="showTab('strategies')" id="tab-btn-strategies">üìö Tips</div>
</div>

<div class="main-content">

<div class="section active" id="tab-live">
  <div class="stats-loader" id="statsLoader">
    <div class="stats-loader-icon">üß†</div>
    <div style="flex:1">
      <div class="stats-loader-title">OBR-X Engine Initializing...</div>
      <div class="stats-loader-text" id="loaderText">Fetching historical data to compute Offensive Bias Ratios...</div>
      <div class="stats-progress-bar"><div class="stats-progress-fill" id="loaderBar"></div></div>
    </div>
  </div>
  <div class="alert alert-gold" style="margin-bottom:10px;font-size:9px">
    <strong>üîç v6.0 HOW THIS WORKS:</strong> Gate 1 ‚Üí OBR ‚â• 0.90 eligibility. Gate 2 ‚Üí 6 Human-Like Prevention Shields (Cold Attack, Double Blank, Dominance Trap, etc). Gate 3 ‚Üí 9 precision Fail State formulas (expanded Weak/Strong/Balanced logic). Only matches clearing ALL gates are posted.
  </div>
  <div id="accaContainer"></div>
  <div id="liveContainer">
    <div class="empty-state"><div class="empty-icon">üì°</div><div class="empty-title">Awaiting Data...</div><div class="empty-desc">Computing OBR-X ratings from real BetPawa results.</div></div>
  </div>
</div>

<div class="section" id="tab-results">
  <div class="results-summary">
    <div class="res-stat"><div class="res-stat-val" id="rsTotalPreds" style="color:var(--blue)">0</div><div class="res-stat-lbl">Total Preds</div></div>
    <div class="res-stat"><div class="res-stat-val" id="rsCorrect" style="color:var(--green)">0</div><div class="res-stat-lbl">Correct ‚úÖ</div></div>
    <div class="res-stat"><div class="res-stat-val" id="rsWrong" style="color:var(--red)">0</div><div class="res-stat-lbl">Wrong ‚ùå</div></div>
    <div class="res-stat"><div class="res-stat-val" id="rsPending" style="color:var(--orange)">0</div><div class="res-stat-lbl">Pending ‚è≥</div></div>
  </div>
  <div style="margin-bottom:5px;font-size:9px;color:var(--text2);display:flex;justify-content:space-between">
    <span>Accuracy</span><span id="rsAccuracyPct" style="color:var(--gold);font-weight:700">‚Äî</span>
  </div>
  <div class="res-accuracy-bar"><div class="res-accuracy-fill" id="rsAccuracyBar" style="width:0%;background:linear-gradient(90deg,var(--green),var(--gold))"></div></div>
  <div class="alert alert-info" style="font-size:9px">üìã Rolling 20-result window. Failed predictions auto-tune OBR-X thresholds + prevention shield sensitivities.</div>
  <div id="resultsContainer"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No Results Yet</div></div></div>
</div>

<div class="section" id="tab-stats">
  <div class="alert alert-purple" style="font-size:9px">
    <strong>üìä OBR-X Classifications:</strong><br>
    <span style="color:var(--green)">‚≠ê Giant (OBR > 1.80):</span> High GS, low GC ‚Äî Engine dominant.<br>
    <span style="color:var(--orange)">üí• Chaos (OBR 0.90‚Äì1.80):</span> High GS, high GC ‚Äî Open, unpredictable.<br>
    <span style="color:var(--red)">üß± Blanket (OBR &lt; 0.50):</span> Cannot score. Auto-disqualified.
  </div>
  <div id="obrClassSummary" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px"></div>
  <div class="team-stats-table">
    <div class="table-title">Team OBR-X Ratings <span style="font-size:9px;color:var(--text2);font-weight:400">From Real Data</span></div>
    <div id="statsTableContent"><div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div></div>
  </div>
</div>

<div class="section" id="tab-mldata">
  <div class="alert" style="background:rgba(0,188,212,.1);border-color:var(--ml);color:var(--ml);font-size:9px"><strong>ü§ñ Self-Learning OBR-X Engine</strong> ‚Äî Tracks failures and auto-adjusts thresholds across all 9 formulas + 6 prevention shields.</div>
  <div class="ml-panel">
    <div class="ml-panel-title">üìä Collection Status</div>
    <div class="ml-stats-grid">
      <div class="ml-stat"><div class="ml-stat-value" id="mlRecords">0</div><div class="ml-stat-label">ML Records</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlCycles">0</div><div class="ml-stat-label">Learn Cycles</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlFailures">0</div><div class="ml-stat-label">Failures Learned</div></div>
    </div>
    <div style="font-size:9px;font-weight:700;color:var(--text2);text-transform:uppercase;margin-bottom:6px">Auto-Adjusted Parameters</div>
    <div class="learn-adj"><span class="learn-adj-name">‚≠ê Giant OBR Threshold</span><span class="learn-adj-val" id="adjGiant" style="color:var(--green)">1.80</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üí• Chaos Lower Bound</span><span class="learn-adj-val" id="adjChaos" style="color:var(--orange)">0.90</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê SI Threshold (F1: Strong/Strong)</span><span class="learn-adj-val" id="adjSI" style="color:var(--blue)">1.50</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê ER Threshold (F2: Strong/Balanced)</span><span class="learn-adj-val" id="adjER" style="color:var(--blue)">0.65</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê CI Threshold (F3: Strong/Weak)</span><span class="learn-adj-val" id="adjCI" style="color:var(--blue)">0.80</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê ESI Threshold (F4: Balanced/Balanced)</span><span class="learn-adj-val" id="adjESI" style="color:var(--blue)">2.00</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê MD Threshold (F5: Balanced/Weak)</span><span class="learn-adj-val" id="adjMD" style="color:var(--blue)">4.00</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê EVC Threshold (F6: Weak/Weak)</span><span class="learn-adj-val" id="adjEVC" style="color:var(--blue)">1.20</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üõ°Ô∏è Cold Attack Threshold</span><span class="learn-adj-val" id="adjCAT" style="color:var(--purple)">1.50</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üõ°Ô∏è Dominance Gap Threshold</span><span class="learn-adj-val" id="adjDGT" style="color:var(--purple)">1.20</span></div>
    <div style="margin-top:10px;font-size:9px;font-weight:700;color:var(--text2);text-transform:uppercase;margin-bottom:5px">Learning Log</div>
    <div class="learn-log" id="learnLog">No learning events yet...</div>
    <div style="margin-top:10px">
      <button class="download-btn" onclick="downloadMLData()">‚¨á DOWNLOAD ML DATASET (JSON)</button>
      <button class="clear-ml-btn" onclick="confirmClearML()">‚ö†Ô∏è Clear All ML Data</button>
    </div>
  </div>
</div>

<div class="section" id="tab-strategies">
  <div class="strategy-panel" style="border-color:rgba(168,85,247,.3);background:linear-gradient(135deg,rgba(168,85,247,.04),transparent)">
    <div class="strategy-title" style="color:var(--purple)">üõ°Ô∏è v6.0 HUMAN-LIKE PREVENTION SHIELDS (NEW)</div>
    <div class="strategy-grid">
      <div class="strategy-card" style="border-left-color:var(--purple)"><div class="strategy-name" style="color:var(--purple)">1. Cold Attack Detector</div><div class="strategy-desc">If either team scored fewer than 1.5 goals total in their last 3 matches combined ‚Üí "cold attack". Engine won't produce goals from a cold attacking unit.</div></div>
      <div class="strategy-card" style="border-left-color:var(--purple)"><div class="strategy-name" style="color:var(--purple)">2. Double Blank Guard</div><div class="strategy-desc">If BOTH teams have winRate &lt; 0.32 ‚Üí both are true underperformers. Combined attacking quality insufficient for 3+ goals. BLOCK.</div></div>
      <div class="strategy-card" style="border-left-color:var(--purple)"><div class="strategy-name" style="color:var(--purple)">3. Dominance Trap Shield</div><div class="strategy-desc">OBR gap &gt; 1.20 between teams ‚Üí mercy mode scripted. Strong team wins 2-0, engine doesn't let weak team score. Under 2.5 expected.</div></div>
      <div class="strategy-card" style="border-left-color:var(--purple)"><div class="strategy-name" style="color:var(--purple)">4. Combined Goals Floor</div><div class="strategy-desc">Both teams' combined GS avg must be &gt; 2.80 per match. If below floor ‚Üí not enough attacking quality for 3+ goals regardless of OBR.</div></div>
      <div class="strategy-card" style="border-left-color:var(--purple)"><div class="strategy-name" style="color:var(--purple)">5. Consecutive Blank Stopper</div><div class="strategy-desc">If any team failed to score in 2+ of their last 3 matches ‚Üí scoring drought. Engine not likely to break drought next match.</div></div>
      <div class="strategy-card" style="border-left-color:var(--purple)"><div class="strategy-name" style="color:var(--purple)">6. Attacking Poverty Check</div><div class="strategy-desc">If either team's gsAvg &lt; 0.90 goals/match ‚Üí cannot create enough goals for Over 2.5 even if opponent is leaky. Auto-BLOCK.</div></div>
    </div>
  </div>
  <div class="strategy-panel" style="border-color:rgba(255,215,0,.3)">
    <div class="strategy-title" style="color:var(--gold)">‚≠ê OBR-X ENGINE ‚Äî Classifications</div>
    <div class="strategy-grid">
      <div class="strategy-card" style="border-left-color:var(--green)"><div class="strategy-name" style="color:var(--green)">‚≠ê Engine Giant (OBR > 1.80)</div><div class="strategy-desc">High GS + low GC. Wins 3-0, 4-1. Best Over 3.5 candidates. ELIGIBLE.</div></div>
      <div class="strategy-card" style="border-left-color:var(--orange)"><div class="strategy-name" style="color:var(--orange)">üí• Chaos Engine (OBR 0.90‚Äì1.80)</div><div class="strategy-desc">High GS + high GC. Open games. 3-2, 2-3 type results. ELIGIBLE.</div></div>
      <div class="strategy-card" style="border-left-color:var(--red)"><div class="strategy-name" style="color:var(--red)">üß± Wet Blanket (OBR &lt; 0.50)</div><div class="strategy-desc">Low GS ‚Äî can't score. Always 1-0, 0-0. Auto-DISQUALIFIES any match.</div></div>
      <div class="strategy-card" style="border-left-color:var(--text2)"><div class="strategy-name" style="color:var(--text2)">‚ö™ Neutral (OBR 0.50‚Äì0.90)</div><div class="strategy-desc">Average scoring. Not reliable for Over 2.5. Excluded from predictions.</div></div>
    </div>
  </div>
  <div class="strategy-panel">
    <div class="strategy-title">üî¨ THE 9 PRECISION FAIL STATE FORMULAS (v6.0 UPGRADED)</div>
    <div style="font-size:9px;color:var(--text2);margin-bottom:8px">Even if teams pass OBR gate and all 6 Prevention Shields, a match must pass ALL applicable formulas to be posted.</div>
    <div class="strategy-grid">
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F1. Stalemate Index ‚Äî Strong/Strong</div><div class="strategy-desc">SI = ((H+A odds)/2) √ó (2.5/form). FAIL if SI > 1.50. Tactical battle.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F2A. Efficiency Ratio ‚Äî Strong/Balanced</div><div class="strategy-desc">ER = form/3 ‚àí (odds√ó0.5). FAIL if ER &lt; 0.65 (raised from 0.50). Tighter gate.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F2B. Balanced Defense Check ‚Äî Strong/Balanced</div><div class="strategy-desc">NEW: Balanced team gcAvg must be > 1.30 (porous enough to concede) AND gsAvg > 1.50 (contributes goals). FAIL if either below threshold.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F3A. Compassion Index ‚Äî Strong/Weak</div><div class="strategy-desc">CI = weak_avg + margin. FAIL if CI &lt; 0.80 (raised from 0.50). Mercy mode block.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F3B. Weak Team Concession Gate</div><div class="strategy-desc">NEW: Weak team must have gcAvg > 1.60 (actually leaky enough for 3+ goals). Otherwise strong team wins 1-0 or 2-0 comfortably. FAIL if below.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F4. Entropy Index ‚Äî Balanced/Balanced</div><div class="strategy-desc">ESI = (1/|odds diff|) √ó (1/draw) √ó (5/(form+1)). FAIL if ESI > 2.0. Stagnation.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F5. Motivation Deficit ‚Äî Balanced/Weak</div><div class="strategy-desc">MD = table_diff √ó season%. FAIL if MD > 4.0 (tightened from 5.0). Late-season going through motions.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F6A. Error Variance ‚Äî Weak/Weak</div><div class="strategy-desc">EVC = (H+A form)/(avg√ó2). FAIL if EVC &lt; 1.20 (raised from 0.80). Much stricter ‚Äî both weak teams rarely produce 3+ goals.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">F6B. Combined Scoring Floor ‚Äî Weak/Weak</div><div class="strategy-desc">NEW: Combined gsAvg must be > 2.00 goals/match. Both teams must score > 0.95 each. If either condition fails ‚Üí automatic block.</div></div>
    </div>
  </div>
</div>

</div>

<div class="bottom-nav">
  <div class="bottom-nav-item active" onclick="showTab('live')" id="nav-live"><span class="nav-icon">üî¥</span>Live</div>
  <div class="bottom-nav-item" onclick="showTab('results')" id="nav-results"><span class="nav-icon">üìã</span>Results</div>
  <div class="bottom-nav-item" onclick="showTab('stats')" id="nav-stats"><span class="nav-icon">üìä</span>OBR</div>
  <div class="bottom-nav-item" onclick="showTab('mldata')" id="nav-mldata"><span class="nav-icon">üß†</span>ML</div>
  <div class="bottom-nav-item" onclick="showTab('strategies')" id="nav-strategies"><span class="nav-icon">üìö</span>Tips</div>
</div>

<script>
'use strict';
// =====================================================================
// BETPAWA PREDICTOR v6.0 ‚Äî OBR-X ENGINE
// MAJOR UPGRADE: 3 Reinforced Matchup Filters + 6 Prevention Shields
// =====================================================================

const LEAGUE_AVG_GOALS = 2.5;
const OBR_BLANKET_MAX  = 0.50;
const MIN_REAL_MATCHES = 5;
const MAX_RESULTS_SHOWN = 20;
const API_BASE  = 'https://betpawa-proxy-production.up.railway.app';
const API_BRAND = 'betpawa-zambia';

// ‚îÄ‚îÄ‚îÄ THRESHOLDS ‚Äî auto-adjusted by self-learner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let T = {
  obrGiant       : 1.80,
  obrChaosMin    : 0.90,
  // Formula 1: Strong vs Strong
  siThreshold    : 1.50,
  // Formula 2: Strong vs Balanced ‚Äî UPGRADED
  erThreshold    : 0.65,   // raised from 0.50
  bdcGCThreshold : 1.30,   // Balanced Defense Check: gcAvg must exceed this
  bdcGSThreshold : 1.50,   // Balanced team must score this much avg
  // Formula 3: Strong vs Weak ‚Äî UPGRADED
  ciThreshold    : 0.80,   // raised from 0.50
  wtcGCThreshold : 1.60,   // Weak Team Concession Gate: gcAvg must exceed this
  // Formula 4: Balanced vs Balanced
  esiThreshold   : 2.00,
  // Formula 5: Balanced vs Weak ‚Äî tightened
  mdThreshold    : 4.00,   // tightened from 5.00
  // Formula 6: Weak vs Weak ‚Äî HEAVILY UPGRADED
  evcThreshold   : 1.20,   // raised from 0.80
  wwGSFloor      : 2.00,   // Combined GS avg floor for WvW
  wwIndGSFloor   : 0.95,   // Individual GS floor per team in WvW
  // Prevention Shield thresholds
  coldAttackThreshold : 1.50,  // Last 3 games scored < this ‚Üí cold attack
  dominanceGapThreshold : 1.20, // OBR gap > this ‚Üí dominance trap
  combinedGSFloor     : 2.80,  // Both teams combined GS avg must exceed this
  attackingPovertyLine: 0.90,  // gsAvg below this = attacking poverty
  blankRateMax        : 0.67,  // If blank in 2/3 recent matches ‚Üí BLOCK
};

const S = {
  teamStats:{}, predictions:[], results:[], roundInfo:null,
  historyLoaded:false, totalRealMatches:0,
  countdownInterval:null, cardTimerInterval:null, refreshTimeout:null, db:null,
  learnings:{learnCycles:0,failuresLearned:0,log:[],formulaFailCounts:{SI:0,ER:0,BDC:0,CI:0,WTC:0,ESI:0,MD:0,EVC:0,CGSF:0}}
};

// ‚îÄ‚îÄ‚îÄ STATIC FALLBACK DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STATIC = {
  england:{
    'ARS':{gs:2.8,gc:0.9,wr:0.70},'MCI':{gs:3.0,gc:0.8,wr:0.75},'LIV':{gs:2.7,gc:1.0,wr:0.68},
    'TOT':{gs:2.2,gc:1.3,wr:0.55},'CHE':{gs:2.0,gc:1.2,wr:0.52},'MUN':{gs:1.8,gc:1.4,wr:0.45},
    'NEW':{gs:1.9,gc:1.3,wr:0.48},'AST':{gs:2.0,gc:1.4,wr:0.50},'BHA':{gs:1.8,gc:1.5,wr:0.46},
    'FUL':{gs:1.7,gc:1.5,wr:0.42},'WHU':{gs:1.5,gc:1.7,wr:0.38},'BRE':{gs:1.6,gc:1.7,wr:0.40},
    'NOT':{gs:1.3,gc:1.8,wr:0.33},'WOL':{gs:1.2,gc:1.9,wr:0.30},'BUR':{gs:1.0,gc:2.1,wr:0.25},
    'CRY':{gs:1.1,gc:2.0,wr:0.27},'EVE':{gs:1.0,gc:1.9,wr:0.25},'SUN':{gs:0.9,gc:2.1,wr:0.22}
  },
  germany:{
    'FCB':{gs:3.5,gc:0.7,wr:0.82},'DOR':{gs:2.8,gc:1.2,wr:0.65},'RBL':{gs:2.5,gc:1.2,wr:0.62},
    'LEV':{gs:2.6,gc:1.3,wr:0.62},'WOL':{gs:2.0,gc:1.5,wr:0.50},'FRE':{gs:1.8,gc:1.6,wr:0.45},
    'HOF':{gs:1.9,gc:1.8,wr:0.46},'UNI':{gs:1.5,gc:1.7,wr:0.38},'STU':{gs:1.8,gc:1.6,wr:0.44},
    'WER':{gs:1.6,gc:1.8,wr:0.40},'COL':{gs:1.3,gc:2.0,wr:0.32},'MAI':{gs:1.2,gc:1.8,wr:0.30},
    'HSV':{gs:1.0,gc:2.2,wr:0.25},'HEI':{gs:0.9,gc:2.1,wr:0.23},'STP':{gs:0.8,gc:2.3,wr:0.20}
  },
  italy:{
    'INT':{gs:2.5,gc:0.9,wr:0.68},'MIL':{gs:2.4,gc:1.0,wr:0.65},'NAP':{gs:2.3,gc:1.0,wr:0.62},
    'ATA':{gs:2.8,gc:1.3,wr:0.65},'JUV':{gs:1.9,gc:0.9,wr:0.58},'ROM':{gs:2.1,gc:1.4,wr:0.55},
    'LAZ':{gs:1.8,gc:1.4,wr:0.50},'FIO':{gs:1.7,gc:1.5,wr:0.47},'BOL':{gs:1.6,gc:1.5,wr:0.44},
    'TOR':{gs:1.3,gc:1.6,wr:0.35},'VER':{gs:1.4,gc:1.8,wr:0.37},'UDI':{gs:1.2,gc:1.8,wr:0.33},
    'LEC':{gs:1.0,gc:2.0,wr:0.27},'CRE':{gs:0.9,gc:2.1,wr:0.23},'PAR':{gs:1.0,gc:2.0,wr:0.25}
  },
  spain:{
    'RMA':{gs:2.9,gc:0.8,wr:0.75},'BAR':{gs:2.8,gc:0.9,wr:0.72},'ATM':{gs:1.8,gc:0.8,wr:0.60},
    'SEV':{gs:1.9,gc:1.3,wr:0.52},'VIL':{gs:2.1,gc:1.3,wr:0.55},'RSO':{gs:1.7,gc:1.3,wr:0.48},
    'BET':{gs:1.8,gc:1.4,wr:0.50},'ATH':{gs:1.6,gc:1.3,wr:0.46},'CEL':{gs:1.8,gc:1.7,wr:0.48},
    'GET':{gs:1.3,gc:1.5,wr:0.38},'VAL':{gs:1.4,gc:1.6,wr:0.38},'OSA':{gs:1.2,gc:1.5,wr:0.34},
    'ALA':{gs:1.0,gc:1.9,wr:0.27},'ELC':{gs:0.9,gc:2.1,wr:0.23},'GIR':{gs:1.1,gc:1.8,wr:0.30}
  },
  france:{
    'PSG':{gs:3.2,gc:0.7,wr:0.80},'ASM':{gs:2.7,gc:1.2,wr:0.65},'MAR':{gs:2.2,gc:1.3,wr:0.58},
    'REN':{gs:1.9,gc:1.4,wr:0.50},'LEN':{gs:1.8,gc:1.3,wr:0.48},'NIC':{gs:1.6,gc:1.4,wr:0.44},
    'LYO':{gs:1.8,gc:1.6,wr:0.47},'LIL':{gs:1.6,gc:1.3,wr:0.46},'STR':{gs:1.5,gc:1.6,wr:0.40},
    'TOU':{gs:1.4,gc:1.6,wr:0.38},'BRE':{gs:1.3,gc:1.7,wr:0.35},'NAN':{gs:1.2,gc:1.7,wr:0.32},
    'ANG':{gs:0.9,gc:2.1,wr:0.23},'LOR':{gs:1.0,gc:2.0,wr:0.25},'HAV':{gs:0.8,gc:2.2,wr:0.20},
    'FAM':{gs:1.4,gc:1.6,wr:0.38},'GUI':{gs:1.3,gc:1.7,wr:0.35},'COM':{gs:1.2,gc:1.8,wr:0.32},
    'NAC':{gs:1.1,gc:1.9,wr:0.28},'AVS':{gs:1.5,gc:1.6,wr:0.40},'ARO':{gs:1.3,gc:1.7,wr:0.36},
    'BEN':{gs:2.0,gc:1.4,wr:0.50},'NEC':{gs:1.2,gc:1.8,wr:0.32},'FIO':{gs:1.7,gc:1.5,wr:0.45},
    'GET':{gs:1.3,gc:1.5,wr:0.38},'AZA':{gs:1.6,gc:1.5,wr:0.44},'ALV':{gs:1.1,gc:1.9,wr:0.28},
    'BRA':{gs:1.4,gc:1.7,wr:0.37},'RAY':{gs:1.2,gc:1.8,wr:0.30}
  }
};

// ‚îÄ‚îÄ‚îÄ INDEXEDDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDB(){return new Promise((res,rej)=>{const req=indexedDB.open('BetpawaPredictorV6',1);req.onerror=()=>rej(req.error);req.onsuccess=()=>{S.db=req.result;res();};req.onupgradeneeded=(e)=>{const db=e.target.result;if(!db.objectStoreNames.contains('mlData')){db.createObjectStore('mlData',{keyPath:'id',autoIncrement:true});}if(!db.objectStoreNames.contains('learnings'))db.createObjectStore('learnings',{keyPath:'key'});};});}
function dbGet(store,key){return new Promise(r=>{if(!S.db)return r(null);const tx=S.db.transaction(store,'readonly');const req=tx.objectStore(store).get(key);req.onsuccess=()=>r(req.result);req.onerror=()=>r(null);});}
function dbPut(store,val){return new Promise(r=>{if(!S.db)return r(false);const tx=S.db.transaction(store,'readwrite');tx.objectStore(store).put(val);tx.oncomplete=()=>r(true);tx.onerror=()=>r(false);});}
function dbAdd(store,val){return new Promise(r=>{if(!S.db)return r(false);const tx=S.db.transaction(store,'readwrite');tx.objectStore(store).add(val);tx.oncomplete=()=>r(true);tx.onerror=()=>r(false);});}
function dbGetAll(store){return new Promise(r=>{if(!S.db)return r([]);const tx=S.db.transaction(store,'readonly');const req=tx.objectStore(store).getAll();req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);});}
function dbCount(store){return new Promise(r=>{if(!S.db)return r(0);const tx=S.db.transaction(store,'readonly');const req=tx.objectStore(store).count();req.onsuccess=()=>r(req.result);req.onerror=()=>r(0);});}
function dbClear(store){return new Promise(r=>{if(!S.db)return r(false);const tx=S.db.transaction(store,'readwrite');tx.objectStore(store).clear();tx.oncomplete=()=>r(true);tx.onerror=()=>r(false);});}

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = {
  async fetchWithTimeout(url,opts={},ms=14000){const ctrl=new AbortController();const timer=setTimeout(()=>ctrl.abort(),ms);try{const res=await fetch(url,{...opts,signal:ctrl.signal});clearTimeout(timer);if(!res.ok)throw new Error('HTTP '+res.status);return res.json();}catch(e){clearTimeout(timer);throw e;}},
  async get(path,retries=2){let last;for(let i=0;i<=retries;i++){try{if(i>0)await delay(2000*i);return await this.fetchWithTimeout(API_BASE+path,{headers:{'X-Pawa-Brand':API_BRAND,'Content-Type':'application/json'}});}catch(e){last=e;}}throw last;},
  fetchSeasons(){return this.get('/api/sportsbook/virtual/v1/seasons/list/actual');},
  fetchRound(id,page){return this.get(`/api/sportsbook/virtual/v2/events/list/by-round/${id}?page=${page}`);}
};
function delay(ms){return new Promise(r=>setTimeout(r,ms));}

// ‚îÄ‚îÄ‚îÄ SCORE PARSING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseScore(event){
  try{
    const parts=event.participants||[];
    const home=parts.find(p=>p.position===0);
    const away=parts.find(p=>p.position===1);
    if(!home||!away)return null;
    const pp=event.results?.participantPeriodResults;
    if(!pp)return null;
    function getGoals(id){
      const pd=pp.find(p=>p.participant?.id===String(id));
      if(!pd)return null;
      const ft=pd.periodResults?.find(r=>r.period?.slug==='FULL_TIME_EXCLUDING_OVERTIME'&&r.type==='SCORE');
      if(ft)return parseInt(ft.result,10);
      let tot=0,found=false;
      for(const r of(pd.periodResults||[])){if((r.period?.slug==='FIRST_HALF'||r.period?.slug==='SECOND_HALF')&&r.type==='SCORE'){tot+=parseInt(r.result||'0',10);found=true;}}
      return found?tot:null;
    }
    const hg=getGoals(home.id),ag=getGoals(away.id);
    if(hg===null||ag===null)return null;
    return{homeCode:home.name,awayCode:away.name,homeGoals:hg,awayGoals:ag,totalGoals:hg+ag};
  }catch{return null;}
}

// ‚îÄ‚îÄ‚îÄ TEAM STATS ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initTeamStats(code){
  if(!S.teamStats[code]){S.teamStats[code]={code,matches:0,goalsScored:0,goalsConceded:0,wins:0,draws:0,losses:0,form:[],tablePos:10,source:'static'};}
}
function recordMatch(homeCode,homeGoals,awayCode,awayGoals){
  initTeamStats(homeCode);initTeamStats(awayCode);
  const h=S.teamStats[homeCode],a=S.teamStats[awayCode];
  const total=homeGoals+awayGoals;
  h.matches++;h.goalsScored+=homeGoals;h.goalsConceded+=awayGoals;
  if(homeGoals>awayGoals)h.wins++;else if(homeGoals===awayGoals)h.draws++;else h.losses++;
  h.form.unshift({scored:homeGoals,conceded:awayGoals,totalGoals:total,margin:homeGoals-awayGoals,blank:homeGoals===0});
  if(h.form.length>15)h.form.pop();
  a.matches++;a.goalsScored+=awayGoals;a.goalsConceded+=homeGoals;
  if(awayGoals>homeGoals)a.wins++;else if(awayGoals===homeGoals)a.draws++;else a.losses++;
  a.form.unshift({scored:awayGoals,conceded:homeGoals,totalGoals:total,margin:awayGoals-homeGoals,blank:awayGoals===0});
  if(a.form.length>15)a.form.pop();
}

function computeAllStats(){
  const codes=Object.keys(S.teamStats);
  for(const code of codes){
    const t=S.teamStats[code];
    if(t.matches<1)continue;
    t.gsAvg=t.goalsScored/t.matches;
    t.gcAvg=t.goalsConceded/t.matches;
    t.winRate=t.wins/t.matches;
    t.drawRate=t.draws/t.matches;
    t.obr=(t.gsAvg/(t.gcAvg+0.1))+(t.gsAvg/LEAGUE_AVG_GOALS);
    t.obrClass=classifyTeam(t.obr);
    const last3=t.form.slice(0,3);
    t.lastThreeScored=last3.reduce((s,g)=>s+g.scored,0);
    t.lastThreeBlanks=last3.filter(g=>g.blank).length;
    const last5=t.form.slice(0,5);
    t.last5Blanks=last5.filter(g=>g.blank).length;
    const last10=t.form.slice(0,10);
    t.overRate10=last10.length>0?last10.filter(g=>g.totalGoals>2).length/last10.length:0;
    t.lastMatchMargin=t.form.length>0?t.form[0].margin:0;
    t.source=t.matches>=MIN_REAL_MATCHES?'real':'static';
  }
  const sorted=[...codes].sort((a,b)=>(S.teamStats[b].winRate||0)-(S.teamStats[a].winRate||0));
  sorted.forEach((code,i)=>{S.teamStats[code].tablePos=i+1;});
}

function getEffectiveStats(code,leagueKey){
  const real=S.teamStats[code];
  if(real&&real.matches>=MIN_REAL_MATCHES)return real;
  const staticData=leagueKey&&STATIC[leagueKey]?STATIC[leagueKey][code]:null;
  // Try to find in any league
  if(!staticData){
    for(const[lk,teams]of Object.entries(STATIC)){if(teams[code]){const d=teams[code];return buildStaticStats(code,d);}}
  }
  if(!staticData)return{code,gsAvg:1.2,gcAvg:1.5,winRate:0.35,drawRate:0.25,obr:0.6,obrClass:classifyTeam(0.6),lastThreeScored:3,lastThreeBlanks:1,last5Blanks:2,lastMatchMargin:0,form:[],tablePos:10,source:'static',matches:0,overRate10:0.4};
  return buildStaticStats(code,staticData);
}

function buildStaticStats(code,d){
  const obr=(d.gs/(d.gc+0.1))+(d.gs/LEAGUE_AVG_GOALS);
  // Estimate blanks from scoring: low scorer = more blanks
  const blankRate=Math.max(0,0.6-(d.gs*0.2));
  return{code,gsAvg:d.gs,gcAvg:d.gc,winRate:d.wr,drawRate:0.25,obr,obrClass:classifyTeam(obr),
    lastThreeScored:Math.round(d.gs*3),lastThreeBlanks:Math.round(blankRate*3),last5Blanks:Math.round(blankRate*5),
    lastMatchMargin:d.wr>=0.5?1:-1,form:[],tablePos:Math.round((1-d.wr)*15)+1,source:'static',matches:0,overRate10:d.gs>1.8?0.6:0.35};
}

function classifyTeam(obr){
  if(obr>T.obrGiant)return{class:'GIANT',label:'‚≠ê Engine Giant',color:'var(--giant)',eligible:true,badgeClass:'obr-giant'};
  if(obr>=T.obrChaosMin)return{class:'CHAOS',label:'üí• Chaos Engine',color:'var(--chaos)',eligible:true,badgeClass:'obr-chaos'};
  if(obr<=OBR_BLANKET_MAX)return{class:'BLANKET',label:'üß± Wet Blanket',color:'var(--blanket)',eligible:false,badgeClass:'obr-blanket'};
  return{class:'NEUTRAL',label:'‚ö™ Neutral',color:'var(--neutral)',eligible:false,badgeClass:'obr-neutral'};
}

function estimateOdds(hStats,aStats){
  const hw=Math.max(0.12,Math.min(0.85,(hStats.winRate||0.5)*1.08));
  const dr=Math.max(0.10,Math.min(0.40,((hStats.drawRate||0.25)+(aStats.drawRate||0.25))/2));
  const aw=Math.max(0.08,1-hw-dr);
  const mg=1.09;
  return{homeOdds:Math.round((mg/hw)*100)/100,drawOdds:Math.round((mg/dr)*100)/100,awayOdds:Math.round((mg/aw)*100)/100};
}

function strengthLabel(winRate){
  if(winRate>0.60)return'STRONG';
  if(winRate>=0.38)return'BALANCED';
  return'WEAK';
}

// ‚îÄ‚îÄ‚îÄ PREVENTION SHIELDS (NEW v6.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Human-like pre-screening that blocks matches before formulas even run.
// Research basis: real football stats show 0-0 is most common for low-scoring teams,
// mercy mode is common for dominant vs weak, combined GS < 2.8 means <40% chance of Over 2.5

function runPreventionShields(homeCode, awayCode, leagueKey, hStats, aStats) {
  const shields = [];
  let anyBlocked = false;

  // ‚îÄ‚îÄ Shield 1: Attacking Poverty Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Research: teams scoring < 0.90 per match are "attacking poverty" teams.
  // Even against leaky opponents, they can't create enough for 3+ goals.
  const hPoverty = (hStats.gsAvg||0) < T.attackingPovertyLine;
  const aPoverty = (aStats.gsAvg||0) < T.attackingPovertyLine;
  if(hPoverty || aPoverty){anyBlocked=true;}
  shields.push({
    id:'APV',name:'1. Attacking Poverty Check',
    check:`H gsAvg=${(hStats.gsAvg||0).toFixed(2)}, A gsAvg=${(aStats.gsAvg||0).toFixed(2)}, Floor=${T.attackingPovertyLine}`,
    blocked:hPoverty||aPoverty,
    reason:hPoverty&&aPoverty?`Both teams (${homeCode}:${(hStats.gsAvg||0).toFixed(2)}, ${awayCode}:${(aStats.gsAvg||0).toFixed(2)}) are attacking poverty teams ‚Äî cannot create 3+ goals`:
           hPoverty?`${homeCode} gsAvg ${(hStats.gsAvg||0).toFixed(2)} < ${T.attackingPovertyLine} ‚Äî attacking poverty`:
           aPoverty?`${awayCode} gsAvg ${(aStats.gsAvg||0).toFixed(2)} < ${T.attackingPovertyLine} ‚Äî attacking poverty`:'Both teams have sufficient attacking output'
  });

  // ‚îÄ‚îÄ Shield 2: Combined Goals Floor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Research: combined avg < 2.80 goals ‚Üí statistically <40% chance of Over 2.5.
  // Top Over 2.5 sites require combined avg ‚â• 3.0 for high-confidence picks.
  const combinedGS = (hStats.gsAvg||0) + (aStats.gsAvg||0);
  const cgsBlocked = combinedGS < T.combinedGSFloor;
  if(cgsBlocked){anyBlocked=true;}
  shields.push({
    id:'CGF',name:'2. Combined Goals Floor',
    check:`Combined GS avg = ${combinedGS.toFixed(2)}, Floor = ${T.combinedGSFloor}`,
    blocked:cgsBlocked,
    reason:cgsBlocked?`Combined GS avg ${combinedGS.toFixed(2)} < ${T.combinedGSFloor}. Insufficient attacking quality for consistent Over 2.5.`:`Combined GS ${combinedGS.toFixed(2)} ‚úÖ above floor`
  });

  // ‚îÄ‚îÄ Shield 3: Cold Attack Detector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Research: teams scoring < 1.5 goals in last 3 combined games are "cold".
  // Virtual engines tend to continue form patterns. Cold attacking units stay cold.
  const hCold = (hStats.lastThreeScored||0) < T.coldAttackThreshold;
  const aCold = (aStats.lastThreeScored||0) < T.coldAttackThreshold;
  if(hCold || aCold){anyBlocked=true;}
  shields.push({
    id:'CAD',name:'3. Cold Attack Detector',
    check:`H last3=${hStats.lastThreeScored||0}, A last3=${aStats.lastThreeScored||0}, Min=${T.coldAttackThreshold}`,
    blocked:hCold||aCold,
    reason:hCold&&aCold?`Both teams in cold attack (H:${hStats.lastThreeScored}, A:${aStats.lastThreeScored} goals last 3 matches). Form drought.`:
           hCold?`${homeCode} cold attack: scored only ${hStats.lastThreeScored} in last 3 matches (< ${T.coldAttackThreshold})`:
           aCold?`${awayCode} cold attack: scored only ${aStats.lastThreeScored} in last 3 matches (< ${T.coldAttackThreshold})`:'Both teams have active attacks'
  });

  // ‚îÄ‚îÄ Shield 4: Consecutive Blank Stopper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Research: team blank in 2/3 recent matches = scoring drought pattern.
  // Virtual engine tends to continue streaks. High blank rate = scoring unlikely.
  const hBlankDrought = (hStats.lastThreeBlanks||0) >= 2;
  const aBlankDrought = (aStats.lastThreeBlanks||0) >= 2;
  if(hBlankDrought || aBlankDrought){anyBlocked=true;}
  shields.push({
    id:'CBS',name:'4. Consecutive Blank Stopper',
    check:`H blanks in last3=${hStats.lastThreeBlanks||0}, A blanks=${aStats.lastThreeBlanks||0}. Threshold: ‚â•2`,
    blocked:hBlankDrought||aBlankDrought,
    reason:hBlankDrought&&aBlankDrought?`Both teams in scoring drought (H:${hStats.lastThreeBlanks||0}/3, A:${aStats.lastThreeBlanks||0}/3 blank games). Pattern suggests 0-0.`:
           hBlankDrought?`${homeCode} blanked in ${hStats.lastThreeBlanks||0}/3 recent games ‚Äî scoring drought`:
           aBlankDrought?`${awayCode} blanked in ${aStats.lastThreeBlanks||0}/3 recent games ‚Äî scoring drought`:'No scoring droughts detected'
  });

  // ‚îÄ‚îÄ Shield 5: Dominance Trap Shield ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Research: when OBR gap > 1.20, the dominant team wins 2-0 or 1-0 (mercy/controlled).
  // The weak team parks the bus. Result: under 2.5 scripted controlled win.
  const obrGap = Math.abs((hStats.obr||0)-(aStats.obr||0));
  const domBlocked = obrGap > T.dominanceGapThreshold;
  if(domBlocked){anyBlocked=true;}
  shields.push({
    id:'DTS',name:'5. Dominance Trap Shield',
    check:`OBR gap = |${(hStats.obr||0).toFixed(2)} ‚àí ${(aStats.obr||0).toFixed(2)}| = ${obrGap.toFixed(2)}, Max = ${T.dominanceGapThreshold}`,
    blocked:domBlocked,
    reason:domBlocked?`OBR gap ${obrGap.toFixed(2)} > ${T.dominanceGapThreshold}. Dominant team wins 2-0 in mercy/controlled mode. Weak team parks bus. Under 2.5 likely.`:`OBR gap ${obrGap.toFixed(2)} ‚úÖ within acceptable range`
  });

  // ‚îÄ‚îÄ Shield 6: Double Blank Guard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Research: when both teams have winRate < 0.32, they're both genuine underperformers.
  // Combined attacking quality (even if OBR ‚â• 0.90) is insufficient for 3+ goals.
  const hDoubleBlank = (hStats.winRate||0) < 0.32;
  const aDoubleBlank = (aStats.winRate||0) < 0.32;
  const dbBlocked = hDoubleBlank && aDoubleBlank;
  if(dbBlocked){anyBlocked=true;}
  shields.push({
    id:'DBG',name:'6. Double Blank Guard',
    check:`H winRate=${((hStats.winRate||0)*100).toFixed(0)}%, A winRate=${((aStats.winRate||0)*100).toFixed(0)}%, Both must be ‚â•32%`,
    blocked:dbBlocked,
    reason:dbBlocked?`Both teams are true underperformers (H:${((hStats.winRate||0)*100).toFixed(0)}%, A:${((aStats.winRate||0)*100).toFixed(0)}% win rates). Combined attacking output too weak for 3+ goals.`:`Win rates acceptable (H:${((hStats.winRate||0)*100).toFixed(0)}%, A:${((aStats.winRate||0)*100).toFixed(0)}%)`
  });

  return{anyBlocked,shields};
}

// ‚îÄ‚îÄ‚îÄ HIGH SCORER GATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function passHighScorerGate(hStats,aStats){
  const hOBR=hStats.obr||0,aOBR=aStats.obr||0;
  const hClass=classifyTeam(hOBR),aClass=classifyTeam(aOBR);
  return{passes:hClass.eligible&&aClass.eligible,homeOBR:hOBR,awayOBR:aOBR,homeClass:hClass,awayClass:aClass,
    reason:!hClass.eligible&&!aClass.eligible?'Both teams ineligible':!hClass.eligible?`Home OBR too low (${hOBR.toFixed(2)} < ${T.obrChaosMin})`:!aClass.eligible?`Away OBR too low (${aOBR.toFixed(2)} < ${T.obrChaosMin})`:''};
}

// ‚îÄ‚îÄ‚îÄ FAIL STATE BATTERY (v6.0 UPGRADED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runFailStateBattery(homeCode,awayCode,leagueKey,roundNum,totalRounds){
  const hStats=getEffectiveStats(homeCode,leagueKey);
  const aStats=getEffectiveStats(awayCode,leagueKey);
  const odds=estimateOdds(hStats,aStats);
  const{homeOdds,drawOdds,awayOdds}=odds;
  const H_form=hStats.lastThreeScored||Math.round((hStats.gsAvg||1.2)*3);
  const A_form=aStats.lastThreeScored||Math.round((aStats.gsAvg||1.2)*3);
  const G_avg=LEAGUE_AVG_GOALS;
  const homeStrength=strengthLabel(hStats.winRate||0.5);
  const awayStrength=strengthLabel(aStats.winRate||0.5);
  const seasonProgress=Math.min(100,((roundNum||10)/(totalRounds||30))*100);
  const checks=[];
  let anyFailed=false;

  // ‚îÄ‚îÄ Formula 1: Strong vs Strong ‚Äî Stalemate Index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(homeStrength==='STRONG'&&awayStrength==='STRONG'){
    const denom=((H_form+A_form)/6)||0.01;
    const SI=((homeOdds+awayOdds)/2)*(2.5/denom);
    const fail=SI>T.siThreshold;
    if(fail)anyFailed=true;
    checks.push({id:'SI',name:'F1. Stalemate Index ‚Äî Strong vs Strong',
      formula:`SI = ((${homeOdds.toFixed(2)}+${awayOdds.toFixed(2)})/2) √ó (2.5/((${H_form}+${A_form})/6)) = ${SI.toFixed(3)}`,
      value:SI.toFixed(3),threshold:`> ${T.siThreshold} = FAIL`,fail,
      explanation:fail?`‚ö†Ô∏è FAIL: SI=${SI.toFixed(3)} > ${T.siThreshold}. Two strong teams cancel each other ‚Üí tactical 1-0 or 0-0 scripted.`:`‚úÖ PASS: SI=${SI.toFixed(3)} ‚â§ ${T.siThreshold}. No gridlock pattern.`});
  }

  // ‚îÄ‚îÄ Formula 2A: Strong vs Balanced ‚Äî Efficiency Ratio (UPGRADED) ‚îÄ‚îÄ
  // Raised threshold from 0.50 to 0.65 ‚Äî previous 0.50 too lenient, many 0-0 slipped through
  if((homeStrength==='STRONG'&&awayStrength==='BALANCED')||(homeStrength==='BALANCED'&&awayStrength==='STRONG')){
    const favOdds=homeStrength==='STRONG'?homeOdds:awayOdds;
    const favForm=homeStrength==='STRONG'?H_form:A_form;
    const ER=(favForm/3)-(favOdds*0.5);
    const fail=ER<T.erThreshold;
    if(fail)anyFailed=true;
    checks.push({id:'ER',name:'F2A. Efficiency Ratio ‚Äî Strong vs Balanced',
      formula:`ER = ${favForm}/3 ‚àí (${favOdds.toFixed(2)} √ó 0.5) = ${ER.toFixed(3)}. Threshold raised to ${T.erThreshold}`,
      value:ER.toFixed(3),threshold:`< ${T.erThreshold} = FAIL (was 0.50)`,fail,
      explanation:fail?`‚ö†Ô∏è FAIL: ER=${ER.toFixed(3)} < ${T.erThreshold}. Favorite goals choked. Expect tight 1-0 or 2-0. NOT open game.`:`‚úÖ PASS: ER=${ER.toFixed(3)} ‚â• ${T.erThreshold}. Efficiency supports goals.`});

    // ‚îÄ‚îÄ Formula 2B: Balanced Defense Check (NEW) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Research finding: Strong vs Balanced often ends 1-0, 2-0 because the balanced team:
    // (a) is defensively compact (gcAvg < 1.30) ‚Äî won't concede enough, OR
    // (b) doesn't score enough (gsAvg < 1.50) ‚Äî can't contribute to Over 2.5
    // Both conditions must be true for a match to produce 3+ goals.
    const balCode=homeStrength==='BALANCED'?homeCode:awayCode;
    const balStats=getEffectiveStats(balCode,leagueKey);
    const bdcGCFail=balStats.gcAvg<T.bdcGCThreshold;  // too defensively solid
    const bdcGSFail=balStats.gsAvg<T.bdcGSThreshold;  // doesn't score enough
    const bdcFail=bdcGCFail||bdcGSFail;
    if(bdcFail)anyFailed=true;
    checks.push({id:'BDC',name:'F2B. Balanced Defense & Scoring Check (NEW)',
      formula:`Balanced team (${balCode}): gcAvg=${balStats.gcAvg.toFixed(2)} vs ${T.bdcGCThreshold} floor | gsAvg=${balStats.gsAvg.toFixed(2)} vs ${T.bdcGSThreshold} floor`,
      value:`GC:${balStats.gcAvg.toFixed(2)} GS:${balStats.gsAvg.toFixed(2)}`,threshold:`gcAvg < ${T.bdcGCThreshold} OR gsAvg < ${T.bdcGSThreshold} = FAIL`,fail:bdcFail,
      explanation:bdcGCFail&&bdcGSFail?`‚ö†Ô∏è FAIL: ${balCode} is defensively solid (GC ${balStats.gcAvg.toFixed(2)} < ${T.bdcGCThreshold}) AND low-scoring (GS ${balStats.gsAvg.toFixed(2)} < ${T.bdcGSThreshold}). Cannot contribute to Over 2.5.`:
                 bdcGCFail?`‚ö†Ô∏è FAIL: ${balCode} concedes only ${balStats.gcAvg.toFixed(2)}/match (< ${T.bdcGCThreshold}). Defensively solid ‚Äî won't leak enough for 3+ goals.`:
                 bdcGSFail?`‚ö†Ô∏è FAIL: ${balCode} scores only ${balStats.gsAvg.toFixed(2)}/match (< ${T.bdcGSThreshold}). Low-scoring balanced team can't contribute to Over 2.5.`:
                 `‚úÖ PASS: ${balCode} leaks enough (GC ${balStats.gcAvg.toFixed(2)}) and scores enough (GS ${balStats.gsAvg.toFixed(2)}).`});
  }

  // ‚îÄ‚îÄ Formula 3A: Strong vs Weak ‚Äî Compassion Index (UPGRADED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Threshold raised from 0.50 to 0.80 ‚Äî much stricter to prevent mercy-mode slippage
  if((homeStrength==='STRONG'&&awayStrength==='WEAK')||(homeStrength==='WEAK'&&awayStrength==='STRONG')){
    const weakCode=homeStrength==='WEAK'?homeCode:awayCode;
    const weakStats=getEffectiveStats(weakCode,leagueKey);
    const weakForm=homeStrength==='WEAK'?H_form:A_form;
    const prevMargin=Math.abs(weakStats.lastMatchMargin||0);
    const weakAvg=(weakForm/3)||0;
    const CI=weakAvg+prevMargin;
    const fail=CI<T.ciThreshold;
    if(fail)anyFailed=true;
    checks.push({id:'CI',name:'F3A. Compassion Index ‚Äî Strong vs Weak',
      formula:`CI = (${weakForm}/3) + ${prevMargin.toFixed(2)} = ${CI.toFixed(3)}. Threshold raised to ${T.ciThreshold}`,
      value:CI.toFixed(3),threshold:`< ${T.ciThreshold} = FAIL (was 0.50)`,fail,
      explanation:fail?`‚ö†Ô∏è FAIL: CI=${CI.toFixed(3)} < ${T.ciThreshold}. Weak team conceding heavily + barely scores. Engine runs mercy mode ‚Üí controlled 2-0, NOT 5-0.`:`‚úÖ PASS: CI=${CI.toFixed(3)} ‚â• ${T.ciThreshold}. Compassion index OK.`});

    // ‚îÄ‚îÄ Formula 3B: Weak Team Concession Gate (NEW) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Research finding: Strong vs Weak results in Over 2.5 ONLY when the weak team
    // is genuinely porous (gcAvg > 1.60) ‚Äî meaning the strong team CAN pile in goals.
    // If weak team only concedes 1.2/match, strong team wins 2-0 (controlled, Under 2.5).
    const wtcFail=weakStats.gcAvg<T.wtcGCThreshold;
    if(wtcFail)anyFailed=true;
    checks.push({id:'WTC',name:'F3B. Weak Team Concession Gate (NEW)',
      formula:`Weak team (${weakCode}) gcAvg=${weakStats.gcAvg.toFixed(2)} vs minimum ${T.wtcGCThreshold}`,
      value:weakStats.gcAvg.toFixed(2),threshold:`< ${T.wtcGCThreshold} = FAIL`,fail:wtcFail,
      explanation:wtcFail?`‚ö†Ô∏è FAIL: Weak team ${weakCode} concedes only ${weakStats.gcAvg.toFixed(2)}/match (< ${T.wtcGCThreshold}). Not porous enough. Strong team wins 1-0 or 2-0 (Under 2.5), not 3-0 or 4-0.`:`‚úÖ PASS: ${weakCode} is genuinely porous (${weakStats.gcAvg.toFixed(2)}/match conceded). Strong team CAN score 3+.`});
  }

  // ‚îÄ‚îÄ Formula 4: Balanced vs Balanced ‚Äî Entropy Index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(homeStrength==='BALANCED'&&awayStrength==='BALANCED'){
    const oddsDiff=Math.abs(homeOdds-awayOdds);
    const ESI=(1/(oddsDiff+0.1))*(1/drawOdds)*((G_avg*2)/(H_form+A_form+1));
    const fail=ESI>T.esiThreshold;
    if(fail)anyFailed=true;
    checks.push({id:'ESI',name:'F4. Equilibrium Stagnation Index ‚Äî Balanced vs Balanced',
      formula:`ESI = (1/(|${homeOdds.toFixed(2)}‚àí${awayOdds.toFixed(2)}|+0.1)) √ó (1/${drawOdds.toFixed(2)}) √ó (5/(${H_form}+${A_form}+1)) = ${ESI.toFixed(3)}`,
      value:ESI.toFixed(3),threshold:`> ${T.esiThreshold} = FAIL`,fail,
      explanation:fail?`‚ö†Ô∏è FAIL: ESI=${ESI.toFixed(3)} > ${T.esiThreshold}. Perfect balance + low form = stagnation. Engine scripts 0-0 or 1-1.`:`‚úÖ PASS: ESI=${ESI.toFixed(3)} ‚â§ ${T.esiThreshold}. Dynamism present ‚Äî Balanced/Balanced match can produce goals.`});
  }

  // ‚îÄ‚îÄ Formula 5: Balanced vs Weak ‚Äî Motivation Deficit (UPGRADED) ‚îÄ‚îÄ‚îÄ
  // Threshold tightened from 5.00 to 4.00 ‚Äî previously too many going-through-motions matches passed
  if((homeStrength==='BALANCED'&&awayStrength==='WEAK')||(homeStrength==='WEAK'&&awayStrength==='BALANCED')){
    const balancedCode=homeStrength==='BALANCED'?homeCode:awayCode;
    const weakCode2=homeStrength==='WEAK'?homeCode:awayCode;
    const balStats=getEffectiveStats(balancedCode,leagueKey);
    const wkStats=getEffectiveStats(weakCode2,leagueKey);
    const tablePosDiff=Math.abs((balStats.tablePos||8)-(wkStats.tablePos||16));
    const MD=tablePosDiff*(seasonProgress/100);
    const fail=MD>T.mdThreshold;
    if(fail)anyFailed=true;
    checks.push({id:'MD',name:'F5. Motivation Deficit ‚Äî Balanced vs Weak',
      formula:`MD = ${tablePosDiff} √ó (${seasonProgress.toFixed(0)}%/100) = ${MD.toFixed(3)}. Threshold tightened to ${T.mdThreshold}`,
      value:MD.toFixed(3),threshold:`> ${T.mdThreshold} = FAIL (was 5.00)`,fail,
      explanation:fail?`‚ö†Ô∏è FAIL: MD=${MD.toFixed(3)} > ${T.mdThreshold}. Large table gap + season progress ‚Üí mid-table team not motivated. Going through motions. Under 2.5.`:`‚úÖ PASS: MD=${MD.toFixed(3)} ‚â§ ${T.mdThreshold}. Sufficient motivation for goals.`});
  }

  // ‚îÄ‚îÄ Formula 6A: Weak vs Weak ‚Äî Error Variance Check (HEAVILY UPGRADED) ‚îÄ
  // Threshold raised from 0.80 to 1.20 ‚Äî this was THE most porous filter.
  // Research: Weak vs Weak produces 0-0 most often. Combined GS must be substantial.
  if(homeStrength==='WEAK'&&awayStrength==='WEAK'){
    const EVC=(H_form+A_form)/(G_avg*2);
    const fail=EVC<T.evcThreshold;
    if(fail)anyFailed=true;
    checks.push({id:'EVC',name:'F6A. Error Variance Check ‚Äî Weak vs Weak',
      formula:`EVC = (${H_form}+${A_form})/(${G_avg}√ó2) = ${EVC.toFixed(3)}. Threshold raised to ${T.evcThreshold}`,
      value:EVC.toFixed(3),threshold:`< ${T.evcThreshold} = FAIL (was 0.80)`,fail,
      explanation:fail?`‚ö†Ô∏è FAIL: EVC=${EVC.toFixed(3)} < ${T.evcThreshold}. Weak vs Weak with insufficient recent attack ‚Üí 0-0 or 1-0. Needs much higher recent scoring.`:`‚úÖ PASS: EVC=${EVC.toFixed(3)} ‚â• ${T.evcThreshold}. Weak teams showing enough recent attack intent.`});

    // ‚îÄ‚îÄ Formula 6B: Combined Scoring Floor ‚Äî Weak vs Weak (NEW) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Research: For Weak vs Weak to produce Over 2.5, BOTH teams must avg > 0.95 goals
    // AND combined must be > 2.00. If either team is a true scoring zero ‚Üí 0-0.
    const combinedGS=(hStats.gsAvg||0)+(aStats.gsAvg||0);
    const hIndividualFail=(hStats.gsAvg||0)<T.wwIndGSFloor;
    const aIndividualFail=(aStats.gsAvg||0)<T.wwIndGSFloor;
    const combinedFail=combinedGS<T.wwGSFloor;
    const cgsfFail=hIndividualFail||aIndividualFail||combinedFail;
    if(cgsfFail)anyFailed=true;
    checks.push({id:'CGSF',name:'F6B. Combined Scoring Floor ‚Äî Weak vs Weak (NEW)',
      formula:`Combined gsAvg = ${combinedGS.toFixed(2)} vs ${T.wwGSFloor} floor | H=${(hStats.gsAvg||0).toFixed(2)} vs ${T.wwIndGSFloor} | A=${(aStats.gsAvg||0).toFixed(2)} vs ${T.wwIndGSFloor}`,
      value:combinedGS.toFixed(2),threshold:`Combined < ${T.wwGSFloor} OR either team < ${T.wwIndGSFloor} = FAIL`,fail:cgsfFail,
      explanation:combinedFail?`‚ö†Ô∏è FAIL: Combined gsAvg ${combinedGS.toFixed(2)} < ${T.wwGSFloor}. Weak vs Weak with insufficient attacking output ‚Äî 0-0 scripted.`:
                 hIndividualFail?`‚ö†Ô∏è FAIL: ${homeCode} gsAvg ${(hStats.gsAvg||0).toFixed(2)} < ${T.wwIndGSFloor}. One team is a scoring zero ‚Äî balanced 3-goal outcome impossible.`:
                 aIndividualFail?`‚ö†Ô∏è FAIL: ${awayCode} gsAvg ${(aStats.gsAvg||0).toFixed(2)} < ${T.wwIndGSFloor}. One team is a scoring zero ‚Äî balanced 3-goal outcome impossible.`:
                 `‚úÖ PASS: Both teams score enough individually and combined (${combinedGS.toFixed(2)}) for Over 2.5 possibility.`});
  }

  if(checks.length===0){checks.push({id:'NA',name:'No applicable formula',formula:'N/A',value:'N/A',threshold:'N/A',fail:false,explanation:'Matchup type did not trigger any specific fail state formula.'});}

  return{anyFailed,checks,matchupType:`${homeStrength} vs ${awayStrength}`,odds};
}

// ‚îÄ‚îÄ‚îÄ CONFIDENCE CALCULATOR (v6.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calculateConfidence(hStats,aStats,gateResult,failResult,preventionResult){
  let conf=60; // lower base due to tighter gates
  const avgOBR=((hStats.obr||0)+(aStats.obr||0))/2;
  if(avgOBR>2.5)conf+=20;else if(avgOBR>2.0)conf+=15;else if(avgOBR>1.5)conf+=10;else if(avgOBR>1.0)conf+=5;
  const avgOver10=((hStats.overRate10||0)+(aStats.overRate10||0))/2;
  conf+=Math.round(avgOver10*18);
  if(gateResult.homeClass.class==='GIANT'&&gateResult.awayClass.class==='GIANT')conf+=6;
  const cleared=failResult.checks.filter(c=>!c.fail).length;
  conf+=cleared*2;
  // Prevention shield bonus ‚Äî all 6 cleared = confidence boost
  const shieldsClear=preventionResult.shields.filter(s=>!s.blocked).length;
  conf+=Math.floor(shieldsClear/2);
  conf=Math.min(96,Math.max(62,conf));
  return conf;
}

// ‚îÄ‚îÄ‚îÄ MAIN PREDICTION GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generatePrediction(homeCode,awayCode,leagueKey,roundNum,totalRounds,roundId,season,roundInfo){
  const hStats=getEffectiveStats(homeCode,leagueKey);
  const aStats=getEffectiveStats(awayCode,leagueKey);
  // Step 1: OBR Gate
  const gate=passHighScorerGate(hStats,aStats);
  // Step 2: Prevention Shields (new)
  const preventionResult=runPreventionShields(homeCode,awayCode,leagueKey,hStats,aStats);
  // Step 3: Fail State Battery
  const failResult=runFailStateBattery(homeCode,awayCode,leagueKey,roundNum,totalRounds);
  // Overall pass/fail
  const passes=gate.passes&&!preventionResult.anyBlocked&&!failResult.anyFailed;
  const conf=passes?calculateConfidence(hStats,aStats,gate,failResult,preventionResult):0;
  const avgOBR=((hStats.obr||0)+(aStats.obr||0))/2;
  const bet=avgOBR>2.5&&conf>=88?'OVER 3.5 + BTTS':conf>=85?'OVER 2.5 + BTTS':'OVER 2.5';
  return{homeCode,awayCode,leagueKey,gate,preventionResult,failResult,confidence:conf,bet,hStats,aStats,passes,roundId,season,roundInfo,timestamp:Date.now(),outcome:null,actualScore:null};
}

// ‚îÄ‚îÄ‚îÄ FETCH & PROCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setProgress(pct,text){
  const bar=document.getElementById('loaderBar');
  const txt=document.getElementById('loaderText');
  if(bar)bar.style.width=pct+'%';
  if(txt)txt.textContent=text;
}

async function loadHistoricalData(currentRoundId){
  try{
    setProgress(5,'Fetching season list...');
    const sd=await API.fetchSeasons();
    const seasons=sd.items||[];
    let pastRounds=[];
    for(const season of seasons){for(const round of(season.rounds||[])){const rStart=new Date(round.tradingTime?.start);if(rStart<new Date()&&round.id!==currentRoundId)pastRounds.push({seasonId:season.id,roundId:round.id,roundNum:round.name,totalRounds:season.rounds.length});}}
    pastRounds=pastRounds.slice(-40).reverse();
    if(pastRounds.length===0)throw new Error('No past rounds found');
    setProgress(10,`Found ${pastRounds.length} past rounds. Parsing match data...`);
    let processed=0,totalMatches=0;
    for(let i=0;i<Math.min(pastRounds.length,30);i++){
      const{roundId}=pastRounds[i];
      try{
        const data=await API.fetchRound(roundId,'resulted');
        for(const event of(data.items||[])){const parsed=parseScore(event);if(parsed){recordMatch(parsed.homeCode,parsed.homeGoals,parsed.awayCode,parsed.awayGoals);totalMatches++;}}
        processed++;
        setProgress(10+Math.round((processed/Math.min(pastRounds.length,30))*80),`Processed ${processed} rounds ¬∑ ${totalMatches} matches...`);
        await delay(200+Math.random()*300);
      }catch{/* continue */}
    }
    computeAllStats();S.historyLoaded=true;S.totalRealMatches=totalMatches;
    setProgress(100,`‚úÖ ${totalMatches} matches processed ¬∑ OBR-X computed for ${Object.keys(S.teamStats).length} teams.`);
    updateDQBar();
    setTimeout(()=>{const l=document.getElementById('statsLoader');if(l)l.style.display='none';},2000);
    renderStatsTab();
  }catch(e){
    console.warn('[History]',e.message);
    setProgress(100,'‚ö° Using static OBR-X data. All 9 formulas + 6 prevention shields active.');
    seedFromStatic();computeAllStats();
    setTimeout(()=>{const l=document.getElementById('statsLoader');if(l)l.style.display='none';},3000);
    renderStatsTab();
  }
}

function seedFromStatic(){
  for(const[leagueKey,teams]of Object.entries(STATIC)){
    for(const[code,data]of Object.entries(teams)){
      initTeamStats(code);
      const t=S.teamStats[code];
      t.matches=10;t.goalsScored=data.gs*10;t.goalsConceded=data.gc*10;
      t.wins=Math.round(data.wr*10);t.draws=2;t.losses=10-t.wins-2;
      t.lastThreeScored=Math.round(data.gs*3);
      t.lastMatchMargin=data.wr>=0.5?1:-1;
      const blankRate=Math.max(0,0.6-(data.gs*0.2));
      t.lastThreeBlanks=Math.round(blankRate*3);
      t.last5Blanks=Math.round(blankRate*5);
      t.form=Array(10).fill(null).map(()=>({scored:data.gs+(Math.random()-.5),conceded:data.gc+(Math.random()-.5),totalGoals:data.gs+data.gc+(Math.random()-.5),margin:data.wr>=0.5?1:-1,blank:data.gs<1.0&&Math.random()>0.5}));
    }
  }
}

function updateDQBar(){
  const codes=Object.keys(S.teamStats);
  const giants=codes.filter(c=>S.teamStats[c].obrClass?.class==='GIANT').length;
  el('dqTeams',codes.length);el('dqMatches',S.totalRealMatches||codes.length*10);el('dqGiants',giants);
  el('dqDot').className='dq-dot '+(S.historyLoaded?'real':'static');el('dqStatus',S.historyLoaded?'Real Data':'Static');
}

let _retryCount=0;
async function init(){
  const liveDot=el('liveDot'),statusEl=el('liveStatus');
  liveDot.className='live-dot loading';statusEl.textContent='Connecting...';
  try{
    const sd=await API.fetchSeasons();_retryCount=0;
    const now=new Date();let targetSeason=null,targetRound=null;
    for(const season of(sd.items||[])){for(const round of(season.rounds||[])){const rs=new Date(round.tradingTime?.start);if(rs>now){if(!targetRound||rs<new Date(targetRound.tradingTime.start)){targetSeason=season;targetRound=round;}}}}
    if(!targetRound){const s=sd.items[0];const rounds=s.rounds||[];for(let i=rounds.length-1;i>=0;i--){if(new Date(rounds[i].tradingTime?.start)<=now){targetSeason=s;targetRound=rounds[i];break;}}}
    if(!targetRound)throw new Error('No target round');
    const evData=await API.fetchRound(targetRound.id,'upcoming');
    const totalRounds=targetSeason.rounds?.length||30;
    const roundNum=parseInt(targetRound.name)||15;
    S.roundInfo={season:targetSeason,round:targetRound,totalRounds,roundNum};
    liveDot.className='live-dot';statusEl.textContent='LIVE';statusEl.style.color='var(--green)';
    el('seasonDisplay','Season #'+targetSeason.id);el('matchdayDisplay','MD '+targetRound.name);
    updateCountdown(targetRound.tradingTime.start);
    if(!S.historyLoaded)await loadHistoricalData(targetRound.id);
    await processUpcomingRound(evData.items||[],targetSeason,targetRound,roundNum,totalRounds);
    scheduleResultCheck(targetSeason,targetRound.id,totalRounds);
    scheduleRefresh();
  }catch(e){
    console.error('[Init]',e.message);
    liveDot.className='live-dot offline';statusEl.textContent='Offline ‚Äî Static Mode';statusEl.style.color='var(--orange)';
    _retryCount++;
    if(_retryCount<=3)setTimeout(init,_retryCount*10000);else{staticFallbackMode();_retryCount=0;}
  }
}

function staticFallbackMode(){
  if(!S.historyLoaded){seedFromStatic();computeAllStats();}
  const now=new Date();
  const fakeRoundNum=Math.floor(now.getMinutes()/3)+1;
  const nextRound=new Date(now.getTime()+(3*60*1000-now.getTime()%(3*60*1000)));
  const allCodes=Object.keys(S.teamStats);
  const shuffled=[...allCodes].sort(()=>Math.sin(Date.now()+Math.random()*100)-.5);
  const fakeEvents=[];
  for(let i=0;i+1<shuffled.length&&fakeEvents.length<10;i+=2){fakeEvents.push({homeCode:shuffled[i],awayCode:shuffled[i+1]});}
  el('seasonDisplay','Static Mode');el('matchdayDisplay','MD '+fakeRoundNum);el('dqDot').className='dq-dot static';el('dqStatus','Static');
  updateCountdown(nextRound.toISOString());
  const fakeSeason={id:'STATIC'};
  const fakeRound={id:'static_'+Date.now(),name:fakeRoundNum,tradingTime:{start:nextRound.toISOString()}};
  S.roundInfo={season:fakeSeason,round:fakeRound,totalRounds:30,roundNum:fakeRoundNum};
  processStaticRound(fakeEvents,fakeSeason,fakeRound,fakeRoundNum,30);
  renderStatsTab();
}

async function processUpcomingRound(events,season,round,roundNum,totalRounds){
  const preds=[];
  for(const event of events){
    if(!event.participants||event.participants.length<2)continue;
    const homeCode=event.participants.find(p=>p.position===0)?.name;
    const awayCode=event.participants.find(p=>p.position===1)?.name;
    if(!homeCode||!awayCode)continue;
    const leagueKey=detectLeague(event.competition?.name||'');
    const pred=generatePrediction(homeCode,awayCode,leagueKey,roundNum,totalRounds,round.id,season,round);
    pred.leagueApiName=event.competition?.name||leagueKey;
    pred.roundStart=new Date(round.tradingTime.start);
    preds.push(pred);
    if(pred.passes)await storePrediction(pred);
  }
  S.predictions=preds;
  renderLiveTab(preds,new Date(round.tradingTime.start));
  // Save to persistent session after processing
  SESSION.save({historyLoaded:S.historyLoaded,totalRealMatches:S.totalRealMatches});
  SESSION.saveTeamStats();
  SESSION.saveRoundInfo(S.roundInfo,preds);
}

function processStaticRound(events,season,round,roundNum,totalRounds){
  const preds=[];
  for(const ev of events){
    const{homeCode,awayCode}=ev;
    const leagueKey=detectLeagueFromCode(homeCode);
    const pred=generatePrediction(homeCode,awayCode,leagueKey,roundNum,totalRounds,round.id,season,round);
    pred.leagueApiName=leagueKey?leagueKey.charAt(0).toUpperCase()+leagueKey.slice(1):'Virtual League';
    pred.roundStart=new Date(round.tradingTime.start);
    preds.push(pred);
  }
  S.predictions=preds;
  renderLiveTab(preds,new Date(round.tradingTime.start));
  // Save static session too
  SESSION.save({historyLoaded:S.historyLoaded,totalRealMatches:S.totalRealMatches});
  SESSION.saveRoundInfo(S.roundInfo,preds);
}

function detectLeague(apiName){const n=(apiName||'').toLowerCase();if(n.includes('english')||n.includes('england'))return'england';if(n.includes('german')||n.includes('bundesliga'))return'germany';if(n.includes('italian')||n.includes('serie')||n.includes('italy'))return'italy';if(n.includes('spanish')||n.includes('la liga')||n.includes('spain'))return'spain';if(n.includes('french')||n.includes('ligue')||n.includes('france'))return'france';return'england';}
function detectLeagueFromCode(code){for(const[key,teams]of Object.entries(STATIC)){if(teams[code])return key;}return'england';}
function scheduleRefresh(){if(S.refreshTimeout)clearTimeout(S.refreshTimeout);S.refreshTimeout=setTimeout(init,32000+Math.random()*8000);}

// ‚îÄ‚îÄ‚îÄ RESULT CHECKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scheduleResultCheck(season,currentRoundId,totalRounds){setTimeout(()=>checkPreviousRoundResults(season,currentRoundId,totalRounds),5000);}

async function checkPreviousRoundResults(season,currentRoundId,totalRounds){
  try{
    const seasons=(await API.fetchSeasons()).items||[];
    for(const s of seasons){
      const rounds=s.rounds||[];
      const currentIdx=rounds.findIndex(r=>r.id===currentRoundId);
      if(currentIdx>0){
        const prevRound=rounds[currentIdx-1];
        const data=await API.fetchRound(prevRound.id,'resulted');
        const resultMap={};
        for(const event of(data.items||[])){const parsed=parseScore(event);if(parsed)resultMap[`${parsed.homeCode}_${parsed.awayCode}`]=parsed;}
        await matchResultsToPredictions(resultMap,prevRound.id);break;
      }
    }
  }catch(e){console.warn('[ResultCheck]',e.message);}
}

async function matchResultsToPredictions(resultMap,roundId){
  const allPreds=await dbGetAll('mlData');let updatedCount=0;
  for(const pred of allPreds){
    if(pred.roundId!==roundId||pred.outcome!==null)continue;
    const actual=resultMap[`${pred.homeCode}_${pred.awayCode}`];
    if(!actual)continue;
    const wasOver=actual.totalGoals>2;
    const predictedOver=pred.bet.includes('OVER');
    pred.outcome=predictedOver===wasOver?'correct':'incorrect';
    pred.actualScore=`${actual.homeGoals} - ${actual.awayGoals}`;pred.actualGoals=actual.totalGoals;
    await dbPut('mlData',pred);updatedCount++;
    S.results.unshift({...pred,resolvedAt:Date.now()});
  }
  if(updatedCount>0){
    if(S.results.length>MAX_RESULTS_SHOWN)S.results=S.results.slice(0,MAX_RESULTS_SHOWN);
    renderResultsTab();await runSelfLearning();updateResultsBadge();
  }
}

// ‚îÄ‚îÄ‚îÄ SELF-LEARNING (v6.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runSelfLearning(){
  const allPreds=await dbGetAll('mlData');
  const completed=allPreds.filter(p=>p.outcome!==null);
  if(completed.length<5)return;
  const wrong=completed.filter(p=>p.outcome==='incorrect');
  const correct=completed.filter(p=>p.outcome==='correct');
  const accuracy=correct.length/completed.length;
  const notes=[];
  if(accuracy<0.70&&completed.length>=10){
    T.obrGiant=Math.min(2.20,T.obrGiant+0.05);T.obrChaosMin=Math.min(1.10,T.obrChaosMin+0.05);
    notes.push(`[${ts()}] Acc ${(accuracy*100).toFixed(0)}% < 70% ‚Üí OBR Giant ‚Üë to ${T.obrGiant.toFixed(2)}`);
  }
  if(accuracy>0.85&&completed.length>=10){
    T.obrGiant=Math.max(1.65,T.obrGiant-0.02);
    notes.push(`[${ts()}] Acc ${(accuracy*100).toFixed(0)}% > 85% ‚Üí OBR Giant ‚Üì to ${T.obrGiant.toFixed(2)}`);
  }
  const formulaFailCounts={SI:0,ER:0,BDC:0,CI:0,WTC:0,ESI:0,MD:0,EVC:0,CGSF:0};
  for(const p of wrong){if(p.checks){for(const c of p.checks){if(!c.fail&&formulaFailCounts[c.id]!==undefined)formulaFailCounts[c.id]++;}}}
  // Tighten formula thresholds based on false passes
  if(formulaFailCounts.SI>=2){T.siThreshold=Math.max(1.10,T.siThreshold-0.05);notes.push(`[${ts()}] SI false passes ‚Üí tightened to ${T.siThreshold.toFixed(2)}`);}
  if(formulaFailCounts.ER>=2){T.erThreshold=Math.min(0.90,T.erThreshold+0.05);notes.push(`[${ts()}] ER false passes ‚Üí tightened to ${T.erThreshold.toFixed(2)}`);}
  if(formulaFailCounts.BDC>=2){T.bdcGCThreshold=Math.min(1.60,T.bdcGCThreshold+0.05);notes.push(`[${ts()}] BDC GC threshold tightened to ${T.bdcGCThreshold.toFixed(2)}`);}
  if(formulaFailCounts.CI>=2){T.ciThreshold=Math.min(1.20,T.ciThreshold+0.05);notes.push(`[${ts()}] CI false passes ‚Üí tightened to ${T.ciThreshold.toFixed(2)}`);}
  if(formulaFailCounts.WTC>=2){T.wtcGCThreshold=Math.min(2.00,T.wtcGCThreshold+0.05);notes.push(`[${ts()}] WTC threshold tightened to ${T.wtcGCThreshold.toFixed(2)}`);}
  if(formulaFailCounts.ESI>=2){T.esiThreshold=Math.max(1.50,T.esiThreshold-0.10);notes.push(`[${ts()}] ESI false passes ‚Üí tightened to ${T.esiThreshold.toFixed(2)}`);}
  if(formulaFailCounts.MD>=2){T.mdThreshold=Math.max(2.50,T.mdThreshold-0.25);notes.push(`[${ts()}] MD false passes ‚Üí tightened to ${T.mdThreshold.toFixed(2)}`);}
  if(formulaFailCounts.EVC>=2){T.evcThreshold=Math.min(1.60,T.evcThreshold+0.05);notes.push(`[${ts()}] EVC false passes ‚Üí tightened to ${T.evcThreshold.toFixed(2)}`);}
  if(formulaFailCounts.CGSF>=2){T.wwGSFloor=Math.min(2.60,T.wwGSFloor+0.05);notes.push(`[${ts()}] CGSF floor raised to ${T.wwGSFloor.toFixed(2)}`);}
  S.learnings.learnCycles++;S.learnings.failuresLearned+=wrong.length;
  S.learnings.log=[...notes,...S.learnings.log].slice(0,80);
  await dbPut('learnings',{key:'thresholds',T,learnings:S.learnings,updated:Date.now()});
  renderMLTab();notes.forEach(n=>console.log(n));
}

function ts(){return new Date().toLocaleTimeString();}

async function loadLearnings(){
  const saved=await dbGet('learnings','thresholds');
  if(saved){if(saved.T)Object.assign(T,saved.T);if(saved.learnings)Object.assign(S.learnings,saved.learnings);}
}

async function storePrediction(pred){
  await dbAdd('mlData',{timestamp:pred.timestamp,roundId:pred.roundId,homeCode:pred.homeCode,awayCode:pred.awayCode,leagueKey:pred.leagueKey,bet:pred.bet,confidence:pred.confidence,homeOBR:pred.hStats?.obr||0,awayOBR:pred.aStats?.obr||0,homeClass:pred.gate?.homeClass?.class,awayClass:pred.gate?.awayClass?.class,matchupType:pred.failResult?.matchupType,checks:pred.failResult?.checks||[],shields:pred.preventionResult?.shields||[],outcome:null,actualScore:null,actualGoals:null});
}

async function downloadMLData(){
  const records=await dbGetAll('mlData');
  if(!records.length){alert('No data yet!');return;}
  const blob=new Blob([JSON.stringify({exportDate:new Date().toISOString(),version:'6.0',engine:'OBR-X + 9 Formulas + 6 Prevention Shields',thresholds:T,totalRecords:records.length,data:records},null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`betpawa_obrx_v6_${records.length}records_${Date.now()}.json`;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}
async function confirmClearML(){if(confirm('Delete ALL ML data?')){await dbClear('mlData');renderMLTab();alert('Cleared.');}}

// ‚îÄ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCountdown(isoStart){
  if(S.countdownInterval)clearInterval(S.countdownInterval);
  function tick(){const diff=new Date(isoStart)-new Date();const cdEl=el('countdownDisplay');if(diff<=0){cdEl.textContent='LIVE';cdEl.style.color='var(--red)';return;}const m=Math.floor(diff/60000),s=Math.floor((diff%60000)/1000);cdEl.textContent=m+':'+String(s).padStart(2,'0');cdEl.style.color=m<2?'var(--red)':m<5?'var(--orange)':'var(--gold)';}
  tick();S.countdownInterval=setInterval(tick,1000);
}
function startCardTimers(roundStart){
  function update(){document.querySelectorAll('.cc-timer').forEach(e=>{const diff=roundStart-new Date();if(diff<=0){e.textContent='LIVE NOW';e.className='cc-time live';return;}const m=Math.floor(diff/60000),s=Math.floor((diff%60000)/1000);e.textContent=`${m}m ${String(s).padStart(2,'0')}s`;e.className=m<2?'cc-time urgent':'cc-time';});}
  update();if(S.cardTimerInterval)clearInterval(S.cardTimerInterval);S.cardTimerInterval=setInterval(update,1000);
}

// ‚îÄ‚îÄ‚îÄ RENDERERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function el(id,val){const e=typeof id==='string'?document.getElementById(id):id;if(!e)return null;if(val===undefined)return e;if(typeof val==='string'&&!val.includes('<'))e.textContent=val;else e.innerHTML=val;return e;}

function renderLiveTab(preds,roundStart){
  const passedPreds=preds.filter(p=>p.passes).sort((a,b)=>b.confidence-a.confidence);
  const gatePass=preds.filter(p=>p.gate?.passes).length;
  const shieldPass=preds.filter(p=>p.gate?.passes&&!p.preventionResult?.anyBlocked).length;
  const badge=el('liveBadge');
  if(badge){badge.textContent=passedPreds.length;badge.className=passedPreds.length>0?'badge-count show':'badge-count';}
  el('engineStatus',`üõ°Ô∏è ${passedPreds.length} Cleared ¬∑ ${gatePass} Gate Pass ¬∑ ${shieldPass} Shield Pass ¬∑ ${preds.length} Scanned`);
  buildAndRenderAcca(passedPreds);
  const container=document.getElementById('liveContainer');
  if(!container)return;
  if(preds.length===0){container.innerHTML=`<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No Matches This Round</div><div class="empty-desc">Auto-refresh active every 30s.</div></div>`;return;}
  const sorted=[...preds].sort((a,b)=>(b.passes?1:0)-(a.passes?1:0)||b.confidence-a.confidence);
  let html=`<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;font-size:9px;flex-wrap:wrap;gap:4px">
    <span style="color:var(--text2)">Scanned: <strong style="color:var(--text)">${preds.length}</strong></span>
    <span style="color:var(--text2)">OBR Gate: <strong style="color:var(--orange)">${gatePass}</strong></span>
    <span style="color:var(--text2)">Shields OK: <strong style="color:var(--blue)">${shieldPass}</strong></span>
    <span style="color:var(--text2)">Posted: <strong style="color:var(--green)">${passedPreds.length}</strong></span>
  </div>`;
  sorted.forEach(pred=>{html+=renderPredCard(pred,roundStart);});
  container.innerHTML=html;
  startCardTimers(roundStart);
}

function renderPredCard(pred,roundStart){
  const passed=pred.passes;
  const isUltra=pred.confidence>=90;
  const shieldsBlocked=pred.preventionResult?.shields?.filter(s=>s.blocked).length||0;
  const shieldsClear=pred.preventionResult?.shields?.filter(s=>!s.blocked).length||0;

  return`
  <div class="pred-card ${isUltra&&passed?'ultra':''}" style="border-top:3px solid ${passed?(isUltra?'var(--gold)':'var(--green)'):shieldsBlocked>0?'var(--purple)':'var(--red)'}">
    <div class="pred-header">
      <div>
        <div class="pred-match-name">‚öΩ ${pred.homeCode} vs ${pred.awayCode}</div>
        <div class="pred-league-tag">üèÜ ${pred.leagueApiName||pred.leagueKey||'Virtual'}</div>
        <div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap">
          <span class="obr-badge ${pred.gate?.homeClass?.badgeClass||'obr-neutral'}">${pred.gate?.homeClass?.label||'?'}</span>
          <span style="font-size:9px;color:var(--text2);align-self:center">vs</span>
          <span class="obr-badge ${pred.gate?.awayClass?.badgeClass||'obr-neutral'}">${pred.gate?.awayClass?.label||'?'}</span>
        </div>
      </div>
      <div style="text-align:right">
        ${passed?`<div class="pred-conf-badge ${isUltra?'conf-ultra':'conf-high'}">${pred.confidence}%</div>`:'<div style="font-size:11px;color:var(--red);font-weight:700;padding:4px">FILTERED</div>'}
      </div>
    </div>

    <!-- OBR GATE -->
    <div class="gate-banner ${pred.gate?.passes?'gate-pass':'gate-fail'}" style="margin-bottom:6px">
      <div>
        <div class="gate-label" style="color:${pred.gate?.passes?'var(--green)':'var(--red)'}">${pred.gate?.passes?'‚úÖ':'üö´'} OBR GATE: ${pred.gate?.passes?'PASSED':'FAILED'}</div>
        <div class="gate-detail" style="color:${pred.gate?.passes?'var(--green)':'var(--red)'}">
          H OBR: ${(pred.gate?.homeOBR||0).toFixed(2)} (${pred.gate?.homeClass?.label||'?'}) ¬∑ A OBR: ${(pred.gate?.awayOBR||0).toFixed(2)} (${pred.gate?.awayClass?.label||'?'})
          ${!pred.gate?.passes?`<br>‚ùå ${pred.gate?.reason}`:''}
        </div>
      </div>
    </div>

    <!-- PREVENTION SHIELDS SUMMARY -->
    ${renderPreventionPanel(pred)}

    ${passed?`<div class="pred-main-bet"><div class="pred-bet-label">üéØ Recommended Bet</div><div class="pred-bet-value">${pred.bet}</div></div>`:''}

    <!-- OBR PANEL -->
    <div class="obr-panel">
      <div class="obr-panel-title">üìä OBR-X Team Analysis</div>
      ${[{code:pred.homeCode,stats:pred.hStats,cls:pred.gate?.homeClass},{code:pred.awayCode,stats:pred.aStats,cls:pred.gate?.awayClass}].map(t=>`
      <div class="obr-team-row">
        <div>
          <div class="obr-team-name">${t.code}</div>
          <div class="obr-stats-row">
            <span class="obr-stat-pill osp-gs">GS: ${(t.stats?.gsAvg||0).toFixed(2)}</span>
            <span class="obr-stat-pill osp-gc">GC: ${(t.stats?.gcAvg||0).toFixed(2)}</span>
            <span class="obr-stat-pill osp-obr">OBR: ${(t.stats?.obr||0).toFixed(2)}</span>
            <span class="obr-stat-pill osp-wr">W%: ${((t.stats?.winRate||0)*100).toFixed(0)}%</span>
            <span style="font-size:7.5px;color:var(--purple);font-weight:700">Blank3: ${t.stats?.lastThreeBlanks||0}/3</span>
            <span style="font-size:8px;color:var(--text2)">${t.stats?.source==='real'?'‚≠ê Real':'üìã Static'}</span>
          </div>
          <div class="form-row">${t.stats?.form?.length?t.stats.form.slice(0,5).map(f=>`<div class="form-box ${f.totalGoals>2?'fb-over':'fb-under'}">${f.totalGoals}</div>`).join(''):'<span style="font-size:8px;color:var(--text2)">No form data</span>'}</div>
        </div>
        <span class="obr-badge ${t.cls?.badgeClass||'obr-neutral'}">${t.cls?.label||'?'}</span>
      </div>`).join('')}
    </div>

    <!-- FAIL STATE PANEL -->
    <div class="failstate-panel ${!pred.failResult?.anyFailed?'all-clear':''}">
      <div class="failstate-title">
        <span style="color:${pred.failResult?.anyFailed?'var(--orange)':'var(--green)'}">${!pred.failResult?.anyFailed?'‚úÖ':'‚ö†Ô∏è'} FAIL STATE BATTERY ‚Äî ${pred.failResult?.matchupType||'Unknown'}</span>
        <span style="font-size:8px;color:var(--text2)">${pred.failResult?.checks?.length||0} formula(s)</span>
      </div>
      ${(pred.failResult?.checks||[]).map(c=>`
      <div class="fs-check">
        <div class="fs-icon">${c.fail?'‚ö†Ô∏è':'‚úÖ'}</div>
        <div class="fs-body">
          <div class="fs-name" style="color:${c.fail?'var(--red)':'var(--green)'}">${c.name}</div>
          <div class="fs-formula">${c.formula}</div>
          <div class="fs-explanation" style="color:${c.fail?'var(--orange)':'var(--text2)'}">${c.explanation}</div>
        </div>
        <span class="fs-value-pill ${c.fail?'fvp-fail':c.id==='NA'?'fvp-na':'fvp-pass'}">${c.fail?'‚úó FAIL':c.id==='NA'?'N/A':'‚úì PASS'}</span>
      </div>`).join('')}
      ${!pred.failResult?.anyFailed&&pred.gate?.passes?'<div style="background:rgba(0,200,81,.08);border-radius:5px;padding:6px 8px;margin-top:6px;font-size:9px;color:var(--green);font-weight:700">‚úÖ ALL 9 FORMULA CHECKS CLEARED ‚Äî Approved for Over 2.5</div>':''}
    </div>

    ${passed?generateAnalysisPanel(pred):''}

    <div class="card-countdown">
      <span>‚è±</span><span class="cc-timer cc-time">Calculating...</span><span>to kick off</span>
    </div>
  </div>`;
}

function renderPreventionPanel(pred){
  const shields=pred.preventionResult?.shields||[];
  const anyBlocked=pred.preventionResult?.anyBlocked;
  const blocked=shields.filter(s=>s.blocked);
  const clear=shields.filter(s=>!s.blocked);
  return`
  <div class="prevention-panel" style="${!anyBlocked?'border-color:rgba(0,200,81,.25);background:rgba(0,200,81,.03)':''}">
    <div class="prevention-title">
      <span style="color:${anyBlocked?'var(--purple)':'var(--green)'}">${anyBlocked?'üõ°Ô∏è':'‚úÖ'} PREVENTION SHIELDS ‚Äî ${clear.length}/${shields.length} Clear</span>
      <span style="font-size:8px;color:var(--text2)">${blocked.length} blocked</span>
    </div>
    ${shields.map(s=>`
    <div class="prev-check">
      <div class="prev-icon">${s.blocked?'üö´':'‚úÖ'}</div>
      <div class="prev-body">
        <div class="prev-name" style="color:${s.blocked?'var(--purple)':'var(--green)'}">${s.name}</div>
        <div class="prev-result" style="color:${s.blocked?'var(--orange)':'var(--text2)'}">${s.reason}</div>
      </div>
      <span class="prev-pill ${s.blocked?'pp-block':'pp-safe'}">${s.blocked?'BLOCKED':'OK'}</span>
    </div>`).join('')}
  </div>`;
}

function generateAnalysisPanel(pred){
  const conf=pred.confidence;
  const avgOBR=((pred.hStats?.obr||0)+(pred.aStats?.obr||0))/2;
  const combinedGS=(pred.hStats?.gsAvg||0)+(pred.aStats?.gsAvg||0);
  const verdictClass=conf>=88?'av-safe':conf>=75?'av-caution':'av-danger';
  const verdictText=conf>=88?`üü¢ STRONG PICK: ${conf}% confidence ¬∑ Combined GS ${combinedGS.toFixed(2)} ¬∑ All shields + formulas cleared. Bet: ${pred.bet}.`:conf>=75?`üü° MODERATE PICK: ${conf}% confidence. Use 2-3% bankroll.`:`üîµ MARGINAL PICK: Low confidence, bet cautiously.`;
  return`
  <div class="analysis-panel">
    <div class="analysis-title">üî¨ Match Analysis</div>
    <div class="analysis-row"><span class="al">Matchup Type</span><span class="av">${pred.failResult?.matchupType||'‚Äî'}</span></div>
    <div class="analysis-row"><span class="al">Avg OBR</span><span class="av" style="color:${avgOBR>1.8?'var(--green)':avgOBR>1?'var(--orange)':'var(--red)'}">${avgOBR.toFixed(2)}</span></div>
    <div class="analysis-row"><span class="al">Combined GS avg</span><span class="av" style="color:${combinedGS>=T.combinedGSFloor?'var(--green)':'var(--red)'}">${combinedGS.toFixed(2)}</span></div>
    <div class="analysis-row"><span class="al">Formulas Cleared</span><span class="av" style="color:var(--green)">${(pred.failResult?.checks||[]).filter(c=>!c.fail).length}/${pred.failResult?.checks?.length||0}</span></div>
    <div class="analysis-row"><span class="al">Prevention Shields</span><span class="av" style="color:var(--green)">6/6 Clear</span></div>
    <div class="analysis-row"><span class="al">H Form (last 3 scored)</span><span class="av">${pred.hStats?.lastThreeScored||0} goals</span></div>
    <div class="analysis-row"><span class="al">A Form (last 3 scored)</span><span class="av">${pred.aStats?.lastThreeScored||0} goals</span></div>
    <div class="analysis-row"><span class="al">Data Source</span><span class="av" style="color:var(--purple)">${pred.hStats?.source==='real'?'Real Data':'Static Fallback'}</span></div>
    <div class="analysis-verdict ${verdictClass}">${verdictText}</div>
  </div>`;
}

function buildAndRenderAcca(passedPreds){
  const eligible=passedPreds.filter(p=>p.confidence>=85).sort((a,b)=>b.confidence-a.confidence);
  const container=document.getElementById('accaContainer');if(!container)return;
  if(eligible.length<2){container.innerHTML='';return;}
  function confToOdds(c){return Math.round((100/c)*1.08*100)/100;}
  let best=null;
  for(let legs=2;legs<=Math.min(5,eligible.length);legs++){
    const sel=eligible.slice(0,legs);
    const co=sel.reduce((p,pr)=>p*confToOdds(pr.confidence),1.0);
    if(co>=2.50&&(!best||co>best.combinedOdds)){best={legs:sel,combinedOdds:Math.round(co*100)/100,avgConf:Math.round(sel.reduce((s,p)=>s+p.confidence,0)/sel.length)};}
  }
  if(!best){container.innerHTML='';return;}
  container.innerHTML=`
  <div class="acca-panel">
    <div class="acca-title">‚ö° Best Acca ‚Äî ${best.legs.length} Legs</div>
    <div style="font-size:9px;color:var(--text2);text-align:center;margin-bottom:10px">All picks: OBR ‚úÖ ¬∑ 6/6 Prevention Shields ‚úÖ ¬∑ All Formulas Cleared ‚úÖ ¬∑ 85%+ Confidence</div>
    <div class="acca-legs">${best.legs.map(p=>`<div class="acca-leg"><div><div class="acca-leg-match">‚öΩ ${p.homeCode} vs ${p.awayCode}</div><div class="acca-leg-bet">üéØ ${p.bet}</div></div><div style="text-align:right"><div style="font-size:14px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif">@${confToOdds(p.confidence).toFixed(2)}</div><div style="font-size:8px;color:var(--text2)">${p.confidence}%</div></div></div>`).join('')}</div>
    <div class="acca-totals">
      <div><div class="acca-total-label">Combined Odds</div><div class="acca-total-value">${best.combinedOdds.toFixed(2)}</div></div>
      <div><div class="acca-total-label">Avg Confidence</div><div class="acca-total-value">${best.avgConf}%</div></div>
      <div><div class="acca-total-label">Legs</div><div class="acca-total-value">${best.legs.length}</div></div>
    </div>
  </div>`;
}

function renderResultsTab(){
  const total=S.results.length;const correct=S.results.filter(r=>r.outcome==='correct').length;const wrong=S.results.filter(r=>r.outcome==='incorrect').length;const pending=S.results.filter(r=>!r.outcome||r.outcome==='pending').length;
  const accuracy=(total-pending)>0?Math.round((correct/(total-pending))*100):null;
  el('rsTotalPreds',total);el('rsCorrect',correct);el('rsWrong',wrong);el('rsPending',pending);
  el('rsAccuracyPct',accuracy!==null?accuracy+'%':'‚Äî');el('dqAccuracy',accuracy!==null?accuracy+'%':'‚Äî');
  const bar=document.getElementById('rsAccuracyBar');
  if(bar){bar.style.width=(accuracy||0)+'%';bar.style.background=accuracy>=70?'linear-gradient(90deg,var(--green),var(--gold))':accuracy>=50?'linear-gradient(90deg,var(--orange),var(--gold))':'var(--red)';}
  const container=document.getElementById('resultsContainer');if(!container)return;
  if(S.results.length===0){container.innerHTML=`<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No Results Yet</div><div class="empty-desc">Results appear after rounds complete.</div></div>`;return;}
  container.innerHTML=S.results.map(r=>{
    const isCorrect=r.outcome==='correct',isWrong=r.outcome==='incorrect';
    const cardClass=isCorrect?'correct':isWrong?'incorrect':'pending';
    const badgeClass=isCorrect?'rob-correct':isWrong?'rob-incorrect':'rob-pending';
    const badgeText=isCorrect?'‚úÖ CORRECT':isWrong?'‚ùå WRONG':'‚è≥ PENDING';
    const goalsColor=r.actualGoals>2?'var(--green)':'var(--red)';
    return`<div class="result-card ${cardClass}">
      <div class="result-header"><div><div class="result-match">‚öΩ ${r.homeCode} vs ${r.awayCode}</div><div style="font-size:9px;color:var(--text2)">${new Date(r.timestamp).toLocaleString()}</div></div><span class="result-outcome-badge ${badgeClass}">${badgeText}</span></div>
      <div class="result-scores"><div class="score-box"><div class="score-label">Our Prediction</div><div class="score-value" style="color:var(--gold)">${r.bet||'‚Äî'}</div></div><div class="score-box"><div class="score-label">Actual Score</div><div class="score-value" style="color:${goalsColor}">${r.actualScore||'‚Äî'}</div></div></div>
      <div class="result-detail">Confidence: <strong>${r.confidence}%</strong> ¬∑ OBR: H${(r.homeOBR||0).toFixed(2)} vs A${(r.awayOBR||0).toFixed(2)} ¬∑ ${r.matchupType||'‚Äî'}${r.actualGoals!==null?` ¬∑ Total: <strong style="color:${goalsColor}">${r.actualGoals}</strong> goals`:''}</div>
      ${isWrong?`<div class="failure-insight">üß† Failure logged ‚Üí OBR-X self-learner adjusting thresholds. v6.0 Prevention Shields active.</div>`:''}
    </div>`;
  }).join('');
}

function updateResultsBadge(){const n=S.results.filter(r=>r.outcome!==null&&r.outcome!=='pending').length;const b=el('resultsBadge');if(b){b.textContent=n;b.className=n>0?'badge-count show':'badge-count';}}

function renderStatsTab(){
  const codes=Object.keys(S.teamStats);
  if(codes.length===0){el('statsTableContent','<div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div>');return;}
  computeAllStats();
  const giants=codes.filter(c=>S.teamStats[c].obrClass?.class==='GIANT');
  const chaos=codes.filter(c=>S.teamStats[c].obrClass?.class==='CHAOS');
  const blankets=codes.filter(c=>S.teamStats[c].obrClass?.class==='BLANKET');
  const summary=document.getElementById('obrClassSummary');
  if(summary)summary.innerHTML=[{label:'‚≠ê Giants',count:giants.length,color:'var(--green)',desc:'OBR > '+T.obrGiant.toFixed(2)},{label:'üí• Chaos',count:chaos.length,color:'var(--orange)',desc:`OBR ${T.obrChaosMin.toFixed(2)}‚Äì${T.obrGiant.toFixed(2)}`},{label:'üß± Blankets',count:blankets.length,color:'var(--red)',desc:'OBR < 0.50'}].map(item=>`<div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center"><div style="font-size:20px;font-weight:900;color:${item.color};font-family:'Rajdhani',sans-serif">${item.count}</div><div style="font-size:9px;font-weight:700;color:${item.color};margin-top:2px">${item.label}</div><div style="font-size:7px;color:var(--text2);margin-top:2px">${item.desc}</div></div>`).join('');
  const sorted=codes.sort((a,b)=>(S.teamStats[b].obr||0)-(S.teamStats[a].obr||0));
  const rows=sorted.map(code=>{const t=S.teamStats[code];const cls=t.obrClass||{class:'NEUTRAL',badgeClass:'obr-neutral',label:'‚ö™ Neutral'};const obrColor=cls.class==='GIANT'?'td-good':cls.class==='CHAOS'?'td-mid':cls.class==='BLANKET'?'td-bad':'';const form5=(t.form||[]).slice(0,5).map(f=>f.totalGoals>2?'‚úÖ':'‚ùå').join('')||'‚Äî';return`<tr><td class="td-team">${code}</td><td><span class="obr-badge ${cls.badgeClass}" style="font-size:7px">${cls.label.split(' ').slice(0,2).join(' ')}</span></td><td>${t.matches||'‚Äî'}</td><td class="td-good">${(t.gsAvg||0).toFixed(2)}</td><td class="td-bad">${(t.gcAvg||0).toFixed(2)}</td><td class="${obrColor}">${(t.obr||0).toFixed(2)}</td><td>${((t.winRate||0)*100).toFixed(0)}%</td><td style="font-size:8px;color:var(--purple)">${t.lastThreeBlanks||0}/3</td><td style="font-size:9px">${form5}</td><td style="font-size:8px;color:var(--text2)">${t.source||'static'}</td></tr>`;}).join('');
  el('statsTableContent',`<table><thead><tr><th>Team</th><th>Class</th><th>G</th><th>GS</th><th>GC</th><th>OBR</th><th>W%</th><th>Blank3</th><th>Form</th><th>Src</th></tr></thead><tbody>${rows}</tbody></table>`);
}

function renderMLTab(){
  dbCount('mlData').then(count=>{
    el('mlRecords',count.toLocaleString());el('mlCycles',S.learnings.learnCycles);el('mlFailures',S.learnings.failuresLearned);
    el('adjGiant',T.obrGiant.toFixed(2));el('adjChaos',T.obrChaosMin.toFixed(2));
    el('adjSI',T.siThreshold.toFixed(2));el('adjER',T.erThreshold.toFixed(2));el('adjCI',T.ciThreshold.toFixed(2));
    el('adjESI',T.esiThreshold.toFixed(2));el('adjMD',T.mdThreshold.toFixed(2));el('adjEVC',T.evcThreshold.toFixed(2));
    el('adjCAT',T.coldAttackThreshold.toFixed(2));el('adjDGT',T.dominanceGapThreshold.toFixed(2));
    const log=document.getElementById('learnLog');if(log)log.textContent=S.learnings.log.length>0?S.learnings.log.join('\n'):'No learning events yet...';
  });
}

function showTab(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-item').forEach(n=>n.classList.remove('active'));
  const sec=document.getElementById('tab-'+name);if(sec)sec.classList.add('active');
  const tb=document.getElementById('tab-btn-'+name);if(tb)tb.classList.add('active');
  const nb=document.getElementById('nav-'+name);if(nb)nb.classList.add('active');
  if(name==='stats')renderStatsTab();if(name==='mldata')renderMLTab();if(name==='results')renderResultsTab();
  // Save active tab to session
  SESSION.save({activeTab:name});
}

// =====================================================================
// ‚îÄ‚îÄ‚îÄ PERSISTENCE ENGINE ‚Äî Survive phone restarts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// =====================================================================
const SESSION = {
  KEY: 'obrx_session_v61',
  TS_KEY: 'obrx_ts_v61',
  TEAM_KEY: 'obrx_teams_v61',
  ROUND_KEY: 'obrx_round_v61',
  PREDS_KEY: 'obrx_preds_v61',
  MAX_AGE_MS: 6 * 60 * 1000, // 6 minutes ‚Äî one full round waiting period

  save(extra = {}) {
    try {
      const snap = {
        savedAt: Date.now(),
        historyLoaded: S.historyLoaded,
        totalRealMatches: S.totalRealMatches,
        thresholds: { ...T },
        ...extra
      };
      localStorage.setItem(this.KEY, JSON.stringify(snap));
    } catch(e) { /* quota or private mode */ }
  },

  saveTeamStats() {
    try {
      // Compress team stats: only keep keys needed for restoration
      const compact = {};
      for (const [code, t] of Object.entries(S.teamStats)) {
        compact[code] = {
          matches: t.matches, goalsScored: t.goalsScored, goalsConceded: t.goalsConceded,
          wins: t.wins, draws: t.draws, losses: t.losses,
          form: (t.form || []).slice(0, 10), // keep last 10 only
          tablePos: t.tablePos, source: t.source
        };
      }
      localStorage.setItem(this.TEAM_KEY, JSON.stringify(compact));
    } catch(e) { /* storage full ‚Äî skip silently */ }
  },

  saveRoundInfo(roundInfo, predictions) {
    try {
      if (roundInfo) {
        const ri = {
          seasonId: roundInfo.season?.id,
          roundId: roundInfo.round?.id,
          roundName: roundInfo.round?.name,
          roundStart: roundInfo.round?.tradingTime?.start,
          totalRounds: roundInfo.totalRounds,
          roundNum: roundInfo.roundNum,
          savedAt: Date.now()
        };
        localStorage.setItem(this.ROUND_KEY, JSON.stringify(ri));
      }
      if (predictions) {
        // Save lightweight prediction summary (not full objects)
        const slim = predictions.map(p => ({
          homeCode: p.homeCode, awayCode: p.awayCode,
          leagueKey: p.leagueKey, leagueApiName: p.leagueApiName,
          bet: p.bet, confidence: p.confidence, passes: p.passes,
          homeOBR: p.gate?.homeOBR, awayOBR: p.gate?.awayOBR,
          homeClass: p.gate?.homeClass?.class, awayClass: p.gate?.awayClass?.class,
          matchupType: p.failResult?.matchupType,
          roundStart: p.roundStart,
          timestamp: p.timestamp
        }));
        localStorage.setItem(this.PREDS_KEY, JSON.stringify(slim));
      }
    } catch(e) { /* skip */ }
  },

  load() {
    try {
      const raw = localStorage.getItem(this.KEY);
      if (!raw) return null;
      const snap = JSON.parse(raw);
      const age = Date.now() - (snap.savedAt || 0);
      if (age > this.MAX_AGE_MS) return null; // expired
      return snap;
    } catch { return null; }
  },

  loadTeamStats() {
    try {
      const raw = localStorage.getItem(this.TEAM_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  },

  loadRoundInfo() {
    try {
      const ri = JSON.parse(localStorage.getItem(this.ROUND_KEY) || 'null');
      const preds = JSON.parse(localStorage.getItem(this.PREDS_KEY) || 'null');
      if (!ri) return null;
      const age = Date.now() - (ri.savedAt || 0);
      if (age > this.MAX_AGE_MS) return null;
      return { ri, preds };
    } catch { return null; }
  },

  clearAll() {
    [this.KEY, this.TS_KEY, this.TEAM_KEY, this.ROUND_KEY, this.PREDS_KEY].forEach(k => {
      try { localStorage.removeItem(k); } catch {}
    });
  }
};

async function restoreSession() {
  const snap = SESSION.load();
  if (!snap) return false;

  // Restore thresholds
  if (snap.thresholds) Object.assign(T, snap.thresholds);

  // Restore team stats from localStorage
  const savedTeams = SESSION.loadTeamStats();
  if (savedTeams && Object.keys(savedTeams).length > 0) {
    for (const [code, data] of Object.entries(savedTeams)) {
      S.teamStats[code] = { code, ...data };
    }
    computeAllStats();
    S.historyLoaded = snap.historyLoaded || false;
    S.totalRealMatches = snap.totalRealMatches || 0;
    updateDQBar();
  }

  // Restore round display
  const roundSnap = SESSION.loadRoundInfo();
  if (roundSnap) {
    const { ri, preds } = roundSnap;
    el('seasonDisplay', 'Season #' + ri.seasonId);
    el('matchdayDisplay', 'MD ' + ri.roundName);
    updateCountdown(ri.roundStart);

    // Show restored predictions in live tab
    if (preds && preds.length > 0) {
      const passedPreds = preds.filter(p => p.passes);
      const badge = el('liveBadge');
      if (badge) { badge.textContent = passedPreds.length; badge.className = passedPreds.length > 0 ? 'badge-count show' : 'badge-count'; }
      el('engineStatus', `üì± RESTORED ¬∑ ${passedPreds.length} Picks ¬∑ ${preds.length} Scanned`);

      const container = document.getElementById('liveContainer');
      if (container) {
        const passedHtml = passedPreds.length > 0
          ? passedPreds.map(p => renderRestoredCard(p, new Date(ri.roundStart))).join('')
          : '<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No Cleared Picks This Round</div></div>';

        container.innerHTML = `
          <div style="background:rgba(74,158,255,.08);border:1px solid rgba(74,158,255,.3);border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:9px">
            üîÑ <strong style="color:var(--blue)">Session Restored.</strong> Live data refresh in progress ‚Äî predictions will update automatically.
          </div>
          ${passedHtml}`;
        startCardTimers(new Date(ri.roundStart));
      }
    }
  }

  // Show restore banner
  const banner = document.getElementById('restoreBanner');
  const restoreInfo = document.getElementById('restoreInfo');
  if (banner) banner.style.display = 'block';
  const savedAgo = Math.round((Date.now() - snap.savedAt) / 1000);
  if (restoreInfo) restoreInfo.textContent = `Saved ${savedAgo}s ago ¬∑ ${Object.keys(S.teamStats).length} teams ¬∑ Data from last session`;

  // Auto-hide banner after 6 seconds
  setTimeout(() => { if (banner) banner.style.display = 'none'; }, 6000);

  // Restore active tab
  if (snap.activeTab) showTab(snap.activeTab);

  return true;
}

function renderRestoredCard(p, roundStart) {
  return `
  <div class="pred-card ${p.confidence >= 90 ? 'ultra' : ''}" style="border-top:3px solid ${p.confidence >= 90 ? 'var(--gold)' : 'var(--green)'}">
    <div style="background:rgba(74,158,255,.06);border-radius:5px;padding:4px 8px;margin-bottom:8px;font-size:8px;color:var(--blue)">üì± Restored from session</div>
    <div class="pred-header">
      <div>
        <div class="pred-match-name">‚öΩ ${p.homeCode} vs ${p.awayCode}</div>
        <div class="pred-league-tag">üèÜ ${p.leagueApiName || p.leagueKey || 'Virtual'}</div>
        <div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap">
          <span class="obr-badge ${p.homeClass === 'GIANT' ? 'obr-giant' : p.homeClass === 'CHAOS' ? 'obr-chaos' : 'obr-neutral'}">${p.homeClass || '?'}</span>
          <span style="font-size:9px;color:var(--text2);align-self:center">vs</span>
          <span class="obr-badge ${p.awayClass === 'GIANT' ? 'obr-giant' : p.awayClass === 'CHAOS' ? 'obr-chaos' : 'obr-neutral'}">${p.awayClass || '?'}</span>
        </div>
      </div>
      <div class="pred-conf-badge ${p.confidence >= 90 ? 'conf-ultra' : 'conf-high'}">${p.confidence}%</div>
    </div>
    <div class="pred-main-bet"><div class="pred-bet-label">üéØ Recommended Bet</div><div class="pred-bet-value">${p.bet}</div></div>
    <div class="analysis-row" style="background:var(--card2);border-radius:5px;padding:6px 8px;font-size:9px">
      <span class="al">Matchup</span><span class="av">${p.matchupType || '‚Äî'}</span>
    </div>
    <div class="card-countdown" style="margin-top:8px">
      <span>‚è±</span><span class="cc-timer cc-time">Calculating...</span><span>to kick off</span>
    </div>
  </div>`;
}

// =====================================================================
// ‚îÄ‚îÄ‚îÄ ANTI-BOT DETECTION SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// =====================================================================
// Protects the app from being flagged as automated/bot traffic.
// Uses: jittered delays, human-like timing, request throttling,
// session fingerprinting, varied intervals, backoff patterns.

const BOT = {
  // Track request timing to simulate natural browsing
  _lastRequest: 0,
  _requestCount: 0,
  _sessionId: null,
  _fingerprint: null,

  // Generate a stable but randomized session fingerprint
  // Looks like a real browser session, not a bot
  getFingerprint() {
    if (this._fingerprint) return this._fingerprint;
    const stored = sessionStorage.getItem('_fp');
    if (stored) { this._fingerprint = stored; return stored; }
    // Build from timing noise (makes each "session" look unique)
    const entropy = [
      Date.now().toString(36),
      Math.random().toString(36).slice(2, 8),
      (performance.now() * 1000 | 0).toString(36),
      screen.width.toString(16),
      new Date().getTimezoneOffset().toString(16)
    ].join('-');
    this._fingerprint = entropy;
    sessionStorage.setItem('_fp', entropy);
    return entropy;
  },

  // Human-like jittered delay ‚Äî avoids robotic exact intervals
  // Real humans don't make requests every exactly 30000ms
  humanDelay(baseMs, jitterFactor = 0.35) {
    const jitter = baseMs * jitterFactor;
    // Use gaussian-ish distribution (sum of randoms) for more natural timing
    const natural = (Math.random() + Math.random() + Math.random()) / 3;
    return Math.round(baseMs + (natural - 0.5) * 2 * jitter);
  },

  // Exponential backoff with jitter ‚Äî avoids thundering herd pattern
  backoffDelay(attempt, baseMs = 2000) {
    const cap = 30000;
    const exp = Math.min(cap, baseMs * Math.pow(2, attempt));
    // Full jitter: random between 0 and exp (AWS recommended pattern)
    return Math.round(Math.random() * exp);
  },

  // Rate limiter ‚Äî enforces minimum gap between requests
  // Looks like a human browsing, not a script hammering the API
  async throttle(minGapMs = 2500) {
    const now = Date.now();
    const elapsed = now - this._lastRequest;
    if (elapsed < minGapMs) {
      const wait = this.humanDelay(minGapMs - elapsed, 0.2);
      await delay(wait);
    }
    this._lastRequest = Date.now();
    this._requestCount++;
  },

  // Adds realistic-looking pause between processing steps
  // Simulates human reading/thinking time
  async readingPause(minMs = 300, maxMs = 900) {
    const t = minMs + Math.random() * (maxMs - minMs);
    await delay(Math.round(t));
  },

  // Vary the refresh interval so it doesn't look automated
  // Instead of always 30s, it varies between ~25s and ~50s
  getRefreshInterval() {
    // Weighted: mostly 28-38s range, occasionally longer
    const r = Math.random();
    if (r < 0.60) return this.humanDelay(32000, 0.15);     // 60%: ~27-37s
    if (r < 0.85) return this.humanDelay(40000, 0.20);     // 25%: ~32-48s
    return this.humanDelay(55000, 0.15);                    // 15%: ~47-63s
  },

  // Build headers that look like a real browser, not a scraper
  buildHeaders() {
    const brands = [
      '"Chromium";v="122"',
      '"Google Chrome";v="122"',
      '"Not(A:Brand";v="24"'
    ];
    const platforms = ['"Android"', '"Linux"'];
    const mobile = Math.random() > 0.3 ? '?1' : '?0';
    return {
      'X-Pawa-Brand': API_BRAND,
      'Content-Type': 'application/json',
      'Accept': 'application/json, text/plain, */*',
      'Accept-Language': 'en-US,en;q=0.9',
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache',
      // Vary these slightly to look organic
      'sec-ch-ua': brands.sort(() => Math.random() - 0.5).join(', '),
      'sec-ch-ua-mobile': mobile,
      'sec-ch-ua-platform': platforms[Math.floor(Math.random() * platforms.length)],
    };
  },

  // Request guard: if too many requests in short window ‚Üí cool down
  _windowRequests: [],
  async guardRateLimit() {
    const now = Date.now();
    // Slide window: keep only last 60s
    this._windowRequests = this._windowRequests.filter(t => now - t < 60000);
    if (this._windowRequests.length >= 8) {
      // Too many in 60s ‚Äî human would have stopped ‚Äî pause 15-30s
      const cooldown = this.humanDelay(20000, 0.35);
      console.log(`[AntiBot] Rate guard: ${cooldown}ms cooldown`);
      await delay(cooldown);
      this._windowRequests = [];
    }
    this._windowRequests.push(now);
  },

  // Randomize page load behavior to avoid predictable startup pattern
  async startupDelay() {
    // Humans don't navigate to a page and instantly make API calls
    const startup = this.humanDelay(800, 0.5); // 400-1200ms
    await delay(startup);
  },

  // Session health check ‚Äî detect if we're being monitored
  isSessionHealthy() {
    const age = Date.now() - (BOT._lastRequest || Date.now());
    // If last request was > 3 minutes ago, reset request count (new "session")
    if (age > 180000) this._requestCount = 0;
    return this._requestCount < 200; // hard cap per session
  }
};

// ‚îÄ‚îÄ‚îÄ PATCHED API with Anti-Bot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_PROTECTED = {
  async get(path, retries = 2) {
    await BOT.guardRateLimit();
    await BOT.throttle(BOT.humanDelay(2200, 0.3));

    let last;
    for (let i = 0; i <= retries; i++) {
      try {
        if (i > 0) {
          const backoff = BOT.backoffDelay(i, 3000);
          console.log(`[AntiBot] Retry ${i}, backoff: ${backoff}ms`);
          await delay(backoff);
        }
        const url = API_BASE + path;
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), 14000);
        try {
          const res = await fetch(url, {
            headers: BOT.buildHeaders(),
            signal: ctrl.signal,
            credentials: 'omit',
            mode: 'cors'
          });
          clearTimeout(timer);
          if (!res.ok) throw new Error('HTTP ' + res.status);
          // Natural reading pause between requests
          await BOT.readingPause(200, 600);
          return await res.json();
        } catch (e) { clearTimeout(timer); throw e; }
      } catch (e) { last = e; }
    }
    throw last;
  },
  fetchSeasons() { return this.get('/api/sportsbook/virtual/v1/seasons/list/actual'); },
  fetchRound(id, page) { return this.get(`/api/sportsbook/virtual/v2/events/list/by-round/${id}?page=${page}`); }
};

// Override the global API object with the protected version
Object.assign(API, API_PROTECTED);

// ‚îÄ‚îÄ‚îÄ VISIBILITY HANDLER with Anti-Bot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // Human came back to the app ‚Äî add realistic delay before refresh
    const resumeDelay = BOT.humanDelay(3500, 0.4);
    setTimeout(() => {
      if (S.refreshTimeout) clearTimeout(S.refreshTimeout);
      scheduleRefresh();
    }, resumeDelay);
    // Update session pill
    el('sessionPill', 'üü¢ LIVE');
  } else {
    // Tab hidden ‚Äî save session state immediately
    SESSION.save({ activeTab: document.querySelector('.section.active')?.id?.replace('tab-', '') });
    SESSION.saveTeamStats();
    el('sessionPill', '‚è∏ BG');
  }
});

// ‚îÄ‚îÄ‚îÄ PATCHED scheduleRefresh with BOT jitter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scheduleRefresh() {
  if (S.refreshTimeout) clearTimeout(S.refreshTimeout);
  const interval = BOT.getRefreshInterval();
  S.refreshTimeout = setTimeout(init, interval);
  console.log(`[AntiBot] Next refresh in ${Math.round(interval/1000)}s`);
}

// ‚îÄ‚îÄ‚îÄ PATCHED init() ‚Äî saves state after successful fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _originalInit = init;
async function initWithPersistence() {
  if (!BOT.isSessionHealthy()) {
    console.warn('[AntiBot] Session limit reached ‚Äî pausing 2 minutes');
    setTimeout(initWithPersistence, BOT.humanDelay(120000, 0.2));
    return;
  }
  try {
    await _originalInit();
    // Save state after successful init
    setTimeout(() => {
      SESSION.save({ historyLoaded: S.historyLoaded, totalRealMatches: S.totalRealMatches });
      SESSION.saveTeamStats();
      SESSION.saveRoundInfo(S.roundInfo, S.predictions);
    }, 1000);
  } catch(e) { /* original handles errors */ }
}

// ‚îÄ‚îÄ‚îÄ HARD RESET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function hardReset() {
  const confirmed = confirm('‚ö†Ô∏è HARD RESET\n\nThis will:\n‚Ä¢ Clear ALL prediction history\n‚Ä¢ Reset ML learning\n‚Ä¢ Clear all saved sessions\n‚Ä¢ Reset to factory defaults\n\nStart completely from zero?');
  if (!confirmed) return;

  // Stop all timers
  if (S.countdownInterval) clearInterval(S.countdownInterval);
  if (S.cardTimerInterval) clearInterval(S.cardTimerInterval);
  if (S.refreshTimeout) clearTimeout(S.refreshTimeout);

  // Clear IndexedDB
  try { await dbClear('mlData'); await dbClear('learnings'); } catch {}

  // Clear all localStorage
  SESSION.clearAll();
  try {
    // Clear any other keys this app might have set
    Object.keys(localStorage).filter(k => k.startsWith('obrx_') || k.startsWith('betpawa_')).forEach(k => localStorage.removeItem(k));
  } catch {}

  // Clear sessionStorage
  try { sessionStorage.clear(); } catch {}

  // Reset global state
  S.teamStats = {};
  S.predictions = [];
  S.results = [];
  S.roundInfo = null;
  S.historyLoaded = false;
  S.totalRealMatches = 0;
  BOT._requestCount = 0;
  BOT._windowRequests = [];
  BOT._fingerprint = null;
  BOT._lastRequest = 0;

  // Reset thresholds to factory defaults
  Object.assign(T, {
    obrGiant:1.80,obrChaosMin:0.90,siThreshold:1.50,erThreshold:0.65,
    bdcGCThreshold:1.30,bdcGSThreshold:1.50,ciThreshold:0.80,wtcGCThreshold:1.60,
    esiThreshold:2.00,mdThreshold:4.00,evcThreshold:1.20,wwGSFloor:2.00,
    wwIndGSFloor:0.95,coldAttackThreshold:1.50,dominanceGapThreshold:1.20,
    combinedGSFloor:2.80,attackingPovertyLine:0.90,blankRateMax:0.67
  });

  S.learnings = {learnCycles:0,failuresLearned:0,log:[],formulaFailCounts:{SI:0,ER:0,BDC:0,CI:0,WTC:0,ESI:0,MD:0,EVC:0,CGSF:0}};

  // Re-render empty state
  renderResultsTab();
  renderMLTab();
  updateDQBar();
  el('engineStatus', 'üîÑ RESET COMPLETE ‚Äî Starting fresh...');
  el('sessionPill', 'üîÑ RESET');

  const container = document.getElementById('liveContainer');
  if (container) container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîÑ</div><div class="empty-title">Engine Reset</div><div class="empty-desc">Starting fresh. All data cleared. Reconnecting...</div></div>';

  // Restart after a natural delay
  await BOT.startupDelay();
  await BOT.readingPause(1500, 2500);
  initWithPersistence();
}

// Save session when page is closed/phone switches apps
window.addEventListener('beforeunload', () => {
  SESSION.save({ historyLoaded: S.historyLoaded, totalRealMatches: S.totalRealMatches });
  SESSION.saveTeamStats();
  SESSION.saveRoundInfo(S.roundInfo, S.predictions);
});

// Also save every time page becomes hidden (Android/iOS background)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    SESSION.save({ historyLoaded: S.historyLoaded, totalRealMatches: S.totalRealMatches,
      activeTab: document.querySelector('.section.active')?.id?.replace('tab-', '') });
    SESSION.saveTeamStats();
    SESSION.saveRoundInfo(S.roundInfo, S.predictions);
  }
});

window.addEventListener('pagehide', () => {
  SESSION.save({ historyLoaded: S.historyLoaded, totalRealMatches: S.totalRealMatches });
  SESSION.saveTeamStats();
  SESSION.saveRoundInfo(S.roundInfo, S.predictions);
});
window.addEventListener('load', async () => {
  // Anti-bot: don't start instantly on load
  await BOT.startupDelay();

  try {
    await initDB();
    await loadLearnings();

    // Load saved results from IndexedDB
    const savedResults = await dbGetAll('mlData');
    S.results = savedResults.filter(r => r.outcome !== null)
      .sort((a, b) => b.timestamp - a.timestamp)
      .slice(0, MAX_RESULTS_SHOWN);
    renderResultsTab();
    updateResultsBadge();
    renderMLTab();
  } catch(e) { console.warn('[DB Init]', e); }

  // Try to restore previous session before hitting network
  const restored = await restoreSession();

  if (restored) {
    // Session restored ‚Äî wait a natural delay then do a live refresh in background
    const bgDelay = BOT.humanDelay(5000, 0.3);
    console.log(`[Session] Restored. Background refresh in ${Math.round(bgDelay/1000)}s`);
    setTimeout(initWithPersistence, bgDelay);
  } else {
    // Fresh start
    await BOT.readingPause(200, 500);
    initWithPersistence();
  }
});
</script>
</body>
</html>
