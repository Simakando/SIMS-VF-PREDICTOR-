<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#050510">
<link rel="manifest" href="manifest.json">
<title>BetPawa Predictor v5.0 ‚Äî OBR Engine</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600;700;900&display=swap');
:root {
  --primary:#1a472a;--primary-light:#00c851;--secondary:#07071a;--accent:#ff6b35;
  --gold:#ffd700;--gold2:#ffaa00;--danger:#ff3547;--bg:#050510;
  --card:#0d0d20;--card2:#13132a;--card3:#18183a;
  --text:#e8e8f5;--text2:#7878a0;--border:#22224a;--green:#00c851;--red:#ff3547;
  --blue:#4a9eff;--orange:#ff9800;--purple:#a855f7;--ml:#00bcd4;
  --giant:#00c851;--chaos:#ff9800;--blanket:#ff3547;--neutral:#7878a0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;font-size:13px;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 0%,rgba(0,200,81,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(255,215,0,.05) 0%,transparent 50%);pointer-events:none;z-index:0;}

/* HEADER */
.header{background:linear-gradient(135deg,#0f0f2a,#07071a);border-bottom:2px solid rgba(255,215,0,.4);padding:10px 15px;text-align:center;position:sticky;top:0;z-index:1000;}
.header-title{font-family:'Rajdhani',sans-serif;font-size:19px;font-weight:700;color:var(--gold);text-transform:uppercase;letter-spacing:3px;}
.header-sub{font-size:9px;color:var(--text2);margin-top:2px;}
.accuracy-badge{display:inline-block;background:linear-gradient(135deg,var(--green),#007a30);color:#000;padding:3px 12px;border-radius:20px;font-size:9px;font-weight:700;margin-top:5px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

/* STATUS BARS */
.data-quality-bar{background:linear-gradient(90deg,#0a0a1f,#0f102a,#0a0a1f);border-bottom:1px solid var(--purple);padding:5px 12px;display:flex;align-items:center;justify-content:space-between;font-size:9px;gap:6px;flex-wrap:wrap;}
.dq-item{display:flex;align-items:center;gap:4px;}
.dq-dot{width:6px;height:6px;border-radius:50%;}
.dq-dot.real{background:var(--green);box-shadow:0 0 6px var(--green);}
.dq-dot.static{background:var(--orange);}
.dq-dot.loading{background:var(--blue);animation:blink .8s infinite;}
.dq-label{color:var(--text2)}.dq-value{color:var(--text);font-weight:700}

.live-status-bar{background:linear-gradient(90deg,#060f06,#0a1a0a,#060f06);border-bottom:1px solid rgba(0,200,81,.3);padding:7px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:blink 1s infinite;}
.live-dot.offline{background:var(--red);animation:none;}
.live-dot.loading{background:var(--blue);animation:blink .5s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.countdown-box{background:rgba(255,215,0,.12);border:1px solid rgba(255,215,0,.4);border-radius:6px;padding:4px 10px;font-size:12px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif;min-width:75px;text-align:center;}
.refresh-btn{background:rgba(0,200,81,.1);border:1px solid var(--green);border-radius:5px;color:var(--green);font-size:9px;font-weight:700;padding:4px 9px;cursor:pointer;transition:all .2s;}
.refresh-btn:hover{background:var(--green);color:#000;}

/* TABS */
.tabs{display:flex;background:var(--secondary);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex:0 0 auto;padding:9px 10px;font-size:9px;font-weight:700;cursor:pointer;color:var(--text2);border-bottom:2px solid transparent;margin-bottom:-1px;text-align:center;text-transform:uppercase;letter-spacing:.5px;transition:all .2s;white-space:nowrap;}
.tab.active{color:var(--primary-light);border-bottom-color:var(--primary-light);background:rgba(0,200,81,.07);}
.badge-count{background:var(--red);color:#fff;font-size:8px;font-weight:900;padding:1px 4px;border-radius:7px;min-width:14px;text-align:center;display:none;}
.badge-count.show{display:inline-block;}

/* SECTIONS */
.section{display:none;padding:10px;padding-bottom:90px;}
.section.active{display:block;}

/* LOADER */
.stats-loader{background:linear-gradient(135deg,rgba(168,85,247,.08),rgba(0,200,81,.04));border:1px solid rgba(168,85,247,.3);border-radius:8px;padding:10px;margin-bottom:10px;display:flex;align-items:center;gap:10px;}
.stats-loader-icon{font-size:20px;}
.stats-loader-title{font-size:11px;font-weight:700;color:var(--purple);margin-bottom:2px;}
.stats-loader-text{font-size:10px;color:var(--text2);}
.stats-progress-bar{height:4px;background:var(--card3);border-radius:2px;margin-top:5px;overflow:hidden;}
.stats-progress-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--green));border-radius:2px;transition:width .5s ease;width:0%;}

/* ALERTS */
.alert{background:rgba(255,53,71,.1);border:1px solid var(--red);border-radius:7px;padding:8px 10px;margin:6px 0;font-size:10px;color:var(--red);}
.alert-warning{background:rgba(255,152,0,.1);border-color:var(--orange);color:var(--orange);}
.alert-success{background:rgba(0,200,81,.1);border-color:var(--green);color:var(--green);}
.alert-info{background:rgba(74,158,255,.1);border-color:var(--blue);color:var(--blue);}
.alert-purple{background:rgba(168,85,247,.1);border-color:var(--purple);color:var(--purple);}
.alert-gold{background:rgba(255,215,0,.08);border-color:rgba(255,215,0,.4);color:var(--gold);}

/* OBR CLASSIFICATION BADGES */
.obr-badge{display:inline-flex;align-items:center;gap:3px;font-size:8px;font-weight:900;padding:2px 7px;border-radius:4px;text-transform:uppercase;}
.obr-giant{background:rgba(0,200,81,.2);color:var(--green);border:1px solid rgba(0,200,81,.3);}
.obr-chaos{background:rgba(255,152,0,.2);color:var(--orange);border:1px solid rgba(255,152,0,.3);}
.obr-blanket{background:rgba(255,53,71,.2);color:var(--red);border:1px solid rgba(255,53,71,.3);}
.obr-neutral{background:rgba(120,120,160,.2);color:var(--text2);border:1px solid rgba(120,120,160,.2);}

/* PREDICTION CARDS */
.pred-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;position:relative;overflow:hidden;}
.pred-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,transparent,var(--green),transparent);}
.pred-card.ultra{border-color:rgba(255,215,0,.5);background:linear-gradient(135deg,rgba(255,215,0,.05),rgba(0,0,0,0));box-shadow:0 0 20px rgba(255,215,0,.1);}
.pred-card.ultra::before{background:linear-gradient(90deg,transparent,var(--gold),transparent);}

.pred-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
.pred-match-name{font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:900;color:var(--gold);}
.pred-league-tag{font-size:9px;color:var(--text2);background:var(--card2);padding:2px 6px;border-radius:4px;margin-top:3px;display:inline-block;}
.pred-conf-badge{font-size:15px;font-weight:900;padding:5px 12px;border-radius:10px;font-family:'Rajdhani',sans-serif;}
.conf-ultra{background:rgba(255,215,0,.15);color:var(--gold);border:1px solid rgba(255,215,0,.3);}
.conf-high{background:rgba(0,200,81,.15);color:var(--green);border:1px solid rgba(0,200,81,.3);}

.gate-banner{border-radius:7px;padding:8px 12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;border:1px solid;}
.gate-pass{border-color:rgba(0,200,81,.5);background:rgba(0,200,81,.06);}
.gate-fail{border-color:rgba(255,53,71,.5);background:rgba(255,53,71,.06);}
.gate-label{font-size:10px;font-weight:900;font-family:'Rajdhani',sans-serif;letter-spacing:1px;text-transform:uppercase;}
.gate-detail{font-size:8px;margin-top:1px;opacity:.8;}

.pred-main-bet{background:linear-gradient(135deg,rgba(0,200,81,.1),rgba(0,100,40,.05));border:1px solid rgba(0,200,81,.3);border-radius:8px;padding:10px 14px;text-align:center;margin-bottom:10px;}
.pred-bet-label{font-size:8px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;}
.pred-bet-value{font-size:20px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif;}

/* OBR PANEL */
.obr-panel{background:linear-gradient(135deg,rgba(74,158,255,.06),rgba(0,200,81,.03));border:1px solid rgba(74,158,255,.25);border-radius:8px;padding:10px;margin-bottom:8px;}
.obr-panel-title{font-size:9px;font-weight:900;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.obr-team-row{display:flex;justify-content:space-between;align-items:center;background:var(--card2);border-radius:6px;padding:7px 10px;margin-bottom:5px;}
.obr-team-name{font-size:11px;font-weight:700;color:var(--gold);font-family:'Rajdhani',sans-serif;}
.obr-stats-row{display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-top:3px;}
.obr-stat-pill{font-size:7.5px;font-weight:700;padding:2px 5px;border-radius:3px;}
.osp-gs{background:rgba(0,200,81,.15);color:var(--green);}
.osp-gc{background:rgba(255,53,71,.15);color:var(--red);}
.osp-obr{background:rgba(255,215,0,.15);color:var(--gold);}
.osp-wr{background:rgba(74,158,255,.15);color:var(--blue);}

/* FAIL STATE PANEL */
.failstate-panel{background:rgba(255,152,0,.06);border:1px solid rgba(255,152,0,.3);border-radius:8px;padding:10px;margin-bottom:8px;}
.failstate-panel.all-clear{background:rgba(0,200,81,.05);border-color:rgba(0,200,81,.3);}
.failstate-title{font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.fs-check{display:flex;align-items:flex-start;gap:7px;padding:5px 0;border-bottom:1px solid rgba(34,34,74,.3);}
.fs-check:last-child{border-bottom:none;}
.fs-icon{font-size:11px;min-width:16px;padding-top:1px;}
.fs-body{flex:1;}
.fs-name{font-size:8px;font-weight:900;text-transform:uppercase;letter-spacing:.5px;}
.fs-formula{font-size:7.5px;color:var(--text2);font-family:monospace;margin:2px 0;word-break:break-all;line-height:1.4;}
.fs-result{font-size:8px;font-weight:700;}
.fs-explanation{font-size:7.5px;line-height:1.4;margin-top:2px;}
.fs-value-pill{font-size:8px;font-weight:900;padding:2px 6px;border-radius:4px;white-space:nowrap;font-family:'Rajdhani',sans-serif;}
.fvp-pass{background:rgba(0,200,81,.15);color:var(--green);border:1px solid rgba(0,200,81,.2);}
.fvp-fail{background:rgba(255,53,71,.15);color:var(--red);border:1px solid rgba(255,53,71,.2);}
.fvp-na{background:rgba(120,120,160,.1);color:var(--text2);}

/* ANALYSIS PANEL */
.analysis-panel{background:linear-gradient(135deg,rgba(74,158,255,.05),rgba(0,200,81,.03));border:1px solid rgba(74,158,255,.25);border-radius:8px;padding:9px;margin-bottom:8px;}
.analysis-title{font-size:9px;font-weight:900;color:var(--blue);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.analysis-row{display:flex;justify-content:space-between;align-items:center;font-size:9px;padding:3px 0;border-bottom:1px solid rgba(34,34,74,.4);}
.analysis-row:last-child{border-bottom:none;}
.al{color:var(--text2);}.av{font-weight:700;color:var(--text);}
.analysis-verdict{border-radius:6px;padding:7px 10px;margin-top:7px;font-size:10px;font-weight:600;line-height:1.5;}
.av-safe{background:rgba(0,200,81,.1);border:1px solid rgba(0,200,81,.3);color:var(--green);}
.av-caution{background:rgba(255,152,0,.1);border:1px solid rgba(255,152,0,.3);color:var(--orange);}
.av-danger{background:rgba(255,53,71,.1);border:1px solid rgba(255,53,71,.3);color:var(--red);}

/* FORM BOXES */
.form-row{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px;}
.form-box{width:18px;height:18px;border-radius:3px;font-size:8px;font-weight:900;display:flex;align-items:center;justify-content:center;}
.fb-over{background:rgba(0,200,81,.3);color:var(--green);}
.fb-under{background:rgba(255,53,71,.3);color:var(--red);}
.fb-na{background:rgba(100,100,130,.3);color:var(--text2);}

/* COUNTDOWN TIMER IN CARD */
.card-countdown{display:flex;align-items:center;justify-content:center;gap:5px;font-size:10px;color:var(--text2);background:var(--card2);border-radius:6px;padding:6px;}
.cc-time{color:var(--orange);font-weight:700;font-family:'Rajdhani',sans-serif;font-size:13px;}
.cc-time.urgent{color:var(--red);animation:pulse 1s infinite;}
.cc-time.live{color:var(--green);animation:pulse 1s infinite;}

/* RESULTS TAB */
.results-summary{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;}
.res-stat{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;}
.res-stat-val{font-size:22px;font-weight:900;font-family:'Rajdhani',sans-serif;}
.res-stat-lbl{font-size:7px;color:var(--text2);text-transform:uppercase;margin-top:2px;}
.res-accuracy-bar{height:8px;background:var(--card3);border-radius:4px;overflow:hidden;margin-bottom:10px;}
.res-accuracy-fill{height:100%;border-radius:4px;transition:width .5s ease;}

.result-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px;position:relative;}
.result-card.correct{border-color:rgba(0,200,81,.4);border-left:4px solid var(--green);}
.result-card.incorrect{border-color:rgba(255,53,71,.4);border-left:4px solid var(--red);}
.result-card.pending{border-color:rgba(255,152,0,.4);border-left:4px solid var(--orange);}
.result-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.result-match{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:900;color:var(--gold);}
.result-outcome-badge{font-size:12px;font-weight:900;padding:3px 10px;border-radius:8px;font-family:'Rajdhani',sans-serif;}
.rob-correct{background:rgba(0,200,81,.2);color:var(--green);border:1px solid rgba(0,200,81,.3);}
.rob-incorrect{background:rgba(255,53,71,.2);color:var(--red);border:1px solid rgba(255,53,71,.3);}
.rob-pending{background:rgba(255,152,0,.2);color:var(--orange);border:1px solid rgba(255,152,0,.3);}
.result-scores{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.score-box{background:var(--card2);border-radius:6px;padding:6px 8px;text-align:center;}
.score-label{font-size:8px;color:var(--text2);text-transform:uppercase;margin-bottom:2px;}
.score-value{font-size:15px;font-weight:900;font-family:'Rajdhani',sans-serif;}
.result-detail{font-size:9px;color:var(--text2);line-height:1.5;}
.failure-insight{font-size:8px;color:var(--orange);background:rgba(255,152,0,.08);border:1px solid rgba(255,152,0,.2);border-radius:5px;padding:5px 8px;margin-top:6px;}

/* TEAM STATS TAB */
.team-stats-table{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;overflow-x:auto;}
.table-title{font-size:11px;font-weight:700;color:var(--purple);margin-bottom:8px;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center;}
table{width:100%;border-collapse:collapse;font-size:10px;}
th{color:var(--text2);font-size:8px;text-transform:uppercase;padding:4px 6px;text-align:center;border-bottom:1px solid var(--border);white-space:nowrap;}
td{padding:5px 6px;text-align:center;border-bottom:1px solid rgba(34,34,74,.5);}
tr:hover td{background:rgba(255,255,255,.02);}
.td-team{text-align:left;font-weight:700;color:var(--gold);font-family:'Rajdhani',sans-serif;}
.td-good{color:var(--green);font-weight:700;}
.td-bad{color:var(--red);font-weight:700;}
.td-mid{color:var(--orange);font-weight:700;}

/* ML TAB */
.ml-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;}
.ml-panel-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;color:var(--ml);text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;}
.ml-stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
.ml-stat{background:var(--card2);border-radius:8px;padding:10px;text-align:center;border:1px solid rgba(0,188,212,.2);}
.ml-stat-value{font-size:22px;font-weight:900;color:var(--ml);font-family:'Rajdhani',sans-serif;}
.ml-stat-label{font-size:8px;color:var(--text2);text-transform:uppercase;margin-top:2px;}
.learn-adj{display:flex;justify-content:space-between;align-items:center;background:var(--card2);border-radius:6px;padding:6px 10px;margin-bottom:5px;}
.learn-adj-name{font-size:10px;color:var(--text2);}
.learn-adj-val{font-size:12px;font-weight:700;font-family:'Rajdhani',sans-serif;}
.learn-log{background:var(--card2);border-radius:6px;padding:8px;max-height:150px;overflow-y:auto;font-size:8px;color:var(--text2);font-family:monospace;line-height:1.5;}
.download-btn{width:100%;padding:11px;background:linear-gradient(135deg,var(--ml),var(--purple));border:none;border-radius:8px;color:#000;font-size:12px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:2px;font-family:'Rajdhani',sans-serif;transition:all .2s;margin-bottom:8px;}
.download-btn:hover{transform:scale(1.02);}
.clear-ml-btn{width:100%;padding:8px;background:rgba(255,53,71,.1);border:1px solid var(--red);border-radius:6px;color:var(--red);font-size:10px;font-weight:700;cursor:pointer;}

/* STRATEGIES TAB */
.strategy-panel{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px;}
.strategy-title{font-size:11px;font-weight:700;color:var(--gold);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;}
.strategy-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.strategy-card{background:var(--card2);padding:8px;border-radius:6px;border-left:3px solid var(--primary-light);}
.strategy-name{font-size:9px;font-weight:700;color:var(--primary-light);margin-bottom:3px;}
.strategy-desc{font-size:8px;color:var(--text2);line-height:1.5;}

/* ACCA */
.acca-panel{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,152,0,.05));border:2px solid rgba(255,215,0,.5);border-radius:12px;padding:12px;margin:10px 0;box-shadow:0 0 20px rgba(255,215,0,.08);}
.acca-title{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:900;color:var(--gold);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px;text-align:center;}
.acca-legs{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
.acca-leg{background:var(--card2);border:1px solid rgba(0,200,81,.3);border-radius:7px;padding:8px;display:flex;justify-content:space-between;align-items:center;}
.acca-leg-match{font-size:12px;font-weight:700;color:var(--gold);font-family:'Rajdhani',sans-serif;}
.acca-leg-bet{font-size:10px;color:var(--green);font-weight:700;}
.acca-totals{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.3);border-radius:8px;padding:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center;}
.acca-total-label{font-size:8px;color:var(--text2);text-transform:uppercase;}
.acca-total-value{font-size:18px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif;}

/* EMPTY STATE */
.empty-state{text-align:center;padding:40px 20px;color:var(--text2);}
.empty-icon{font-size:44px;margin-bottom:12px;}
.empty-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:6px;}
.empty-desc{font-size:11px;line-height:1.6;}

/* BOTTOM NAV */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--secondary);border-top:1px solid var(--border);display:flex;z-index:1000;padding-bottom:env(safe-area-inset-bottom,0);overflow-x:auto;}
.bottom-nav-item{flex:0 0 auto;min-width:65px;display:flex;flex-direction:column;align-items:center;padding:7px 4px;cursor:pointer;color:var(--text2);font-size:7px;transition:all .2s;gap:2px;}
.bottom-nav-item .nav-icon{font-size:16px;}
.bottom-nav-item.active{color:var(--primary-light);background:rgba(0,200,81,.08);}
.loading-spinner{display:inline-block;width:12px;height:12px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:4px;}
@keyframes spin{to{transform:rotate(360deg)}}
.pill{font-size:8px;font-weight:700;padding:2px 6px;border-radius:4px;}
.p-green{background:rgba(0,200,81,.15);color:var(--green);}
.p-red{background:rgba(255,53,71,.15);color:var(--red);}
.p-orange{background:rgba(255,152,0,.15);color:var(--orange);}
.p-blue{background:rgba(74,158,255,.15);color:var(--blue);}
.p-gold{background:rgba(255,215,0,.1);color:var(--gold);}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-title">‚ö° BetPawa Predictor <span style="background:linear-gradient(135deg,var(--purple),#6a0dad);color:#fff;padding:2px 8px;border-radius:10px;font-size:9px;margin-left:5px;">v5.0 OBR</span></div>
  <div class="header-sub">OBR Engine ¬∑ 6 Fail State Formulas ¬∑ Real Data ¬∑ Self-Learning</div>
  <div class="accuracy-badge" id="engineStatus">üß† Initializing OBR Engine...</div>
</div>

<!-- DATA QUALITY BAR -->
<div class="data-quality-bar">
  <div class="dq-item"><div class="dq-dot loading" id="dqDot"></div><span class="dq-label">Data:</span><span class="dq-value" id="dqStatus">Loading...</span></div>
  <div class="dq-item"><span class="dq-label">Teams:</span><span class="dq-value" id="dqTeams">0</span></div>
  <div class="dq-item"><span class="dq-label">Matches:</span><span class="dq-value" id="dqMatches">0</span></div>
  <div class="dq-item"><span class="dq-label">Giants:</span><span class="dq-value" style="color:var(--green)" id="dqGiants">0</span></div>
  <div class="dq-item"><span class="dq-label">Accuracy:</span><span class="dq-value" style="color:var(--gold)" id="dqAccuracy">‚Äî</span></div>
</div>

<!-- LIVE STATUS BAR -->
<div class="live-status-bar">
  <div style="display:flex;align-items:center;gap:5px;font-size:10px;font-weight:700"><div class="live-dot" id="liveDot"></div><span id="liveStatus">Connecting...</span></div>
  <div style="font-size:11px;font-weight:700;color:var(--gold)" id="seasonDisplay">Season --</div>
  <div style="font-size:11px;color:var(--text2)" id="matchdayDisplay">MD --</div>
  <div class="countdown-box" id="countdownDisplay">--:--</div>
  <button class="refresh-btn" onclick="init()">üîÑ Refresh</button>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="showTab('live')" id="tab-btn-live">üî¥ Live <span class="badge-count" id="liveBadge">0</span></div>
  <div class="tab" onclick="showTab('results')" id="tab-btn-results">üìã Results <span class="badge-count" id="resultsBadge">0</span></div>
  <div class="tab" onclick="showTab('stats')" id="tab-btn-stats">üìä OBR Stats</div>
  <div class="tab" onclick="showTab('mldata')" id="tab-btn-mldata">üß† ML</div>
  <div class="tab" onclick="showTab('strategies')" id="tab-btn-strategies">üìö Tips</div>
</div>

<div class="main-content">

<!-- ==================== LIVE TAB ==================== -->
<div class="section active" id="tab-live">
  <div class="stats-loader" id="statsLoader">
    <div class="stats-loader-icon">üß†</div>
    <div style="flex:1">
      <div class="stats-loader-title">OBR Engine Initializing...</div>
      <div class="stats-loader-text" id="loaderText">Fetching historical data to compute Offensive Bias Ratios...</div>
      <div class="stats-progress-bar"><div class="stats-progress-fill" id="loaderBar"></div></div>
    </div>
  </div>
  <div class="alert alert-gold" style="margin-bottom:10px;font-size:9px">
    <strong>üîç HOW THIS WORKS:</strong> Step 1 ‚Üí Only teams with OBR ‚â• 0.90 (Giants & Chaos Engines) are eligible. Step 2 ‚Üí Each eligible matchup runs through 6 Fail State formulas. Step 3 ‚Üí Only matches that pass ALL filters are shown here as Over 2.5 picks.
  </div>
  <div id="accaContainer"></div>
  <div id="liveContainer">
    <div class="empty-state"><div class="empty-icon">üì°</div><div class="empty-title">Awaiting Data...</div><div class="empty-desc">Computing Offensive Bias Ratios from real BetPawa results.</div></div>
  </div>
</div>

<!-- ==================== RESULTS TAB ==================== -->
<div class="section" id="tab-results">
  <div class="results-summary">
    <div class="res-stat"><div class="res-stat-val" id="rsTotalPreds" style="color:var(--blue)">0</div><div class="res-stat-lbl">Total Preds</div></div>
    <div class="res-stat"><div class="res-stat-val" id="rsCorrect" style="color:var(--green)">0</div><div class="res-stat-lbl">Correct ‚úÖ</div></div>
    <div class="res-stat"><div class="res-stat-val" id="rsWrong" style="color:var(--red)">0</div><div class="res-stat-lbl">Wrong ‚ùå</div></div>
    <div class="res-stat"><div class="res-stat-val" id="rsPending" style="color:var(--orange)">0</div><div class="res-stat-lbl">Pending ‚è≥</div></div>
  </div>
  <div style="margin-bottom:5px;font-size:9px;color:var(--text2);display:flex;justify-content:space-between">
    <span>Accuracy</span><span id="rsAccuracyPct" style="color:var(--gold);font-weight:700">‚Äî</span>
  </div>
  <div class="res-accuracy-bar"><div class="res-accuracy-fill" id="rsAccuracyBar" style="width:0%;background:linear-gradient(90deg,var(--green),var(--gold))"></div></div>
  <div class="alert alert-info" style="font-size:9px">üìã Rolling window: Last 20 results shown. Every 5 new results, oldest 5 are archived. Failed predictions auto-tune the OBR thresholds.</div>
  <div id="resultsContainer"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No Results Yet</div><div class="empty-desc">Results will appear here after rounds complete.</div></div></div>
</div>

<!-- ==================== OBR STATS TAB ==================== -->
<div class="section" id="tab-stats">
  <div class="alert alert-purple" style="font-size:9px">
    <strong>üìä OBR Classifications:</strong><br>
    <span style="color:var(--green)">‚≠ê Giant (OBR > 1.80):</span> High GS, low GC ‚Äî Engine programmed to dominate.<br>
    <span style="color:var(--orange)">üí• Chaos (OBR 0.90‚Äì1.80):</span> High GS, high GC ‚Äî Open games, unpredictable score.<br>
    <span style="color:var(--red)">üß± Blanket (OBR &lt; 0.50):</span> Low GS ‚Äî Cannot score. Auto-disqualified.
  </div>
  <div id="obrClassSummary" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px"></div>
  <div class="team-stats-table">
    <div class="table-title">Team OBR Ratings <span style="font-size:9px;color:var(--text2);font-weight:400">From Real Data</span></div>
    <div id="statsTableContent"><div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading...</div></div></div>
  </div>
</div>

<!-- ==================== ML DATA TAB ==================== -->
<div class="section" id="tab-mldata">
  <div class="alert" style="background:rgba(0,188,212,.1);border-color:var(--ml);color:var(--ml);font-size:9px"><strong>ü§ñ Self-Learning Engine</strong> ‚Äî Tracks prediction failures and auto-adjusts OBR thresholds and fail state sensitivities.</div>
  <div class="ml-panel">
    <div class="ml-panel-title">üìä Collection Status</div>
    <div class="ml-stats-grid">
      <div class="ml-stat"><div class="ml-stat-value" id="mlRecords">0</div><div class="ml-stat-label">ML Records</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlCycles">0</div><div class="ml-stat-label">Learn Cycles</div></div>
      <div class="ml-stat"><div class="ml-stat-value" id="mlFailures">0</div><div class="ml-stat-label">Failures Learned</div></div>
    </div>
    <div style="font-size:9px;font-weight:700;color:var(--text2);text-transform:uppercase;margin-bottom:6px">Auto-Adjusted Parameters</div>
    <div class="learn-adj"><span class="learn-adj-name">‚≠ê Giant OBR Threshold</span><span class="learn-adj-val" id="adjGiant" style="color:var(--green)">1.80</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üí• Chaos Lower Bound</span><span class="learn-adj-val" id="adjChaos" style="color:var(--orange)">0.90</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê SI Threshold (Formula 1)</span><span class="learn-adj-val" id="adjSI" style="color:var(--blue)">1.50</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê ER Threshold (Formula 2)</span><span class="learn-adj-val" id="adjER" style="color:var(--blue)">0.50</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê ESI Threshold (Formula 4)</span><span class="learn-adj-val" id="adjESI" style="color:var(--blue)">2.00</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê MD Threshold (Formula 5)</span><span class="learn-adj-val" id="adjMD" style="color:var(--blue)">5.00</span></div>
    <div class="learn-adj"><span class="learn-adj-name">üìê EVC Threshold (Formula 6)</span><span class="learn-adj-val" id="adjEVC" style="color:var(--blue)">0.80</span></div>
    <div style="margin-top:10px;font-size:9px;font-weight:700;color:var(--text2);text-transform:uppercase;margin-bottom:5px">Learning Log</div>
    <div class="learn-log" id="learnLog">No learning events yet...</div>
    <div style="margin-top:10px">
      <button class="download-btn" onclick="downloadMLData()">‚¨á DOWNLOAD ML DATASET (JSON)</button>
      <button class="clear-ml-btn" onclick="confirmClearML()">‚ö†Ô∏è Clear All ML Data</button>
    </div>
  </div>
</div>

<!-- ==================== STRATEGIES TAB ==================== -->
<div class="section" id="tab-strategies">
  <div class="strategy-panel" style="border-color:rgba(255,215,0,.3);background:linear-gradient(135deg,rgba(255,215,0,.04),transparent)">
    <div class="strategy-title" style="color:var(--gold)">‚≠ê OBR ENGINE ‚Äî How Teams Are Classified</div>
    <div class="strategy-grid">
      <div class="strategy-card" style="border-left-color:var(--green)"><div class="strategy-name" style="color:var(--green)">‚≠ê Engine Giant (OBR > 1.80)</div><div class="strategy-desc">High GS_avg + low GC_avg. Engine programmed to dominate. Wins 3-0, 4-1. Best Over 3.5 candidates. ELIGIBLE for predictions.</div></div>
      <div class="strategy-card" style="border-left-color:var(--orange)"><div class="strategy-name" style="color:var(--orange)">üí• Chaos Engine (OBR 0.90‚Äì1.80)</div><div class="strategy-desc">High GS + high GC. Open entertaining games. 3-2, 2-3 type results. Good Over 2.5. ELIGIBLE for predictions.</div></div>
      <div class="strategy-card" style="border-left-color:var(--red)"><div class="strategy-name" style="color:var(--red)">üß± Wet Blanket (OBR &lt; 0.50)</div><div class="strategy-desc">Low GS_avg ‚Äî can't score. Always 1-0, 0-0. Automatically DISQUALIFIES any match they appear in.</div></div>
      <div class="strategy-card" style="border-left-color:var(--text2)"><div class="strategy-name" style="color:var(--text2)">‚ö™ Neutral (OBR 0.50‚Äì0.90)</div><div class="strategy-desc">Average scoring. Not reliable for Over 2.5. Excluded from predictions. Possible Under 2.5 candidates.</div></div>
    </div>
  </div>
  <div class="strategy-panel">
    <div class="strategy-title">üî¨ THE 6 FAIL STATE FORMULAS</div>
    <div style="font-size:9px;color:var(--text2);margin-bottom:8px">Even if both teams are eligible (OBR ‚â• 0.90), a match must pass ALL applicable fail state checks to be posted as a pick.</div>
    <div class="strategy-grid">
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">1. Stalemate Index ‚Äî Strong vs Strong</div><div class="strategy-desc">SI = ((H_odds + A_odds)/2) √ó (2.5/((H_form+A_form)/6)). FAIL if SI > 1.50. Two strong teams cancel each other ‚Üí tactical low score.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">2. Efficiency Ratio ‚Äî Strong vs Balanced</div><div class="strategy-desc">ER = H_form/3 - (Fav_odds √ó 0.5). FAIL if ER &lt; 0.50. Favorite goals choked ‚Üí 1-0 or 2-0 scripted scoreline.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">3. Compassion Index ‚Äî Strong vs Weak</div><div class="strategy-desc">CI = Weak_form_avg + Last_Match_Margin. FAIL if CI &lt; 0.50. After heavy defeat, engine shows mercy ‚Üí controlled 2-0 not 5-0.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">4. Entropy Index ‚Äî Balanced vs Balanced</div><div class="strategy-desc">ESI = (1/|odds diff|) √ó (1/draw_odds) √ó (5/(form+1)). FAIL if ESI > 2.0. Perfect equilibrium ‚Üí 0-0 or 1-1 stalemate.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">5. Motivation Deficit ‚Äî Balanced vs Weak</div><div class="strategy-desc">MD = Table_Pos_Diff √ó (Season_Progress%). FAIL if MD > 5.0. Late season with safe mid-table ‚Üí going through motions.</div></div>
      <div class="strategy-card" style="border-left-color:var(--blue)"><div class="strategy-name" style="color:var(--blue)">6. Error Variance ‚Äî Weak vs Weak</div><div class="strategy-desc">EVC = (H_form + A_form) / (G_avg √ó 2). FAIL if EVC &lt; 0.80. Both teams poor attackers ‚Üí messy goalless draw.</div></div>
    </div>
  </div>
  <div class="strategy-panel">
    <div class="strategy-title">üí° BETTING GUIDE</div>
    <div class="strategy-grid">
      <div class="strategy-card"><div class="strategy-name">Giant vs Weak (Best)</div><div class="strategy-desc">OBR > 1.80 vs Wet Blanket = contradiction. Giant auto-wins. BUT if Weak team passes gate (OBR ‚â• 0.90), expect 3+ goals.</div></div>
      <div class="strategy-card"><div class="strategy-name">Giant vs Giant</div><div class="strategy-desc">Both OBR > 1.80 = Stalemate Index runs. If SI &lt; 1.50, it passes. High chance of 3-2, 2-3 explosive game.</div></div>
      <div class="strategy-card"><div class="strategy-name">Self-Learning Impact</div><div class="strategy-desc">After failures, thresholds auto-tighten. Over time, predictions become more conservative and accurate.</div></div>
      <div class="strategy-card"><div class="strategy-name">Acca Building Rule</div><div class="strategy-desc">Only picks with 85%+ confidence AND all fail states cleared qualify for Acca. 2-5 legs max for safety.</div></div>
    </div>
  </div>
</div>

</div><!-- end main-content -->

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="bottom-nav-item active" onclick="showTab('live')" id="nav-live"><span class="nav-icon">üî¥</span>Live</div>
  <div class="bottom-nav-item" onclick="showTab('results')" id="nav-results"><span class="nav-icon">üìã</span>Results</div>
  <div class="bottom-nav-item" onclick="showTab('stats')" id="nav-stats"><span class="nav-icon">üìä</span>OBR</div>
  <div class="bottom-nav-item" onclick="showTab('mldata')" id="nav-mldata"><span class="nav-icon">üß†</span>ML</div>
  <div class="bottom-nav-item" onclick="showTab('strategies')" id="nav-strategies"><span class="nav-icon">üìö</span>Tips</div>
</div>

<script>
'use strict';
// =====================================================================
// BETPAWA VIRTUAL FOOTBALL PREDICTOR v5.0 ‚Äî OBR ENGINE
// =====================================================================

// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LEAGUE_AVG_GOALS  = 2.5;
const OBR_GIANT         = 1.80;   // will be adjusted by self-learner
const OBR_CHAOS_MIN     = 0.90;
const OBR_BLANKET_MAX   = 0.50;
const MIN_REAL_MATCHES  = 5;      // minimum matches before we trust OBR
const RESULTS_PAGE_SIZE = 5;      // clear oldest after every 5 new results
const MAX_RESULTS_SHOWN = 20;
const API_BASE          = 'https://betpawa-proxy-production.up.railway.app';
const API_BRAND         = 'betpawa-zambia';

// ‚îÄ‚îÄ‚îÄ THRESHOLDS (auto-adjusted by self-learner) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let T = {
  obrGiant       : 1.80,
  obrChaosMin    : 0.90,
  siThreshold    : 1.50,   // Formula 1: SI > this ‚Üí FAIL
  erThreshold    : 0.50,   // Formula 2: ER < this ‚Üí FAIL
  ciThreshold    : 0.50,   // Formula 3: CI < this ‚Üí FAIL
  esiThreshold   : 2.00,   // Formula 4: ESI > this ‚Üí FAIL
  mdThreshold    : 5.00,   // Formula 5: MD > this ‚Üí FAIL
  evcThreshold   : 0.80,   // Formula 6: EVC < this ‚Üí FAIL
};

// ‚îÄ‚îÄ‚îÄ GLOBAL STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  teamStats      : {},     // code ‚Üí computed stats
  predictions    : [],     // current live predictions
  results        : [],     // all prediction results (persistent)
  roundInfo      : null,   // current round metadata
  historyLoaded  : false,
  totalRealMatches: 0,
  countdownInterval: null,
  cardTimerInterval: null,
  refreshTimeout : null,
  db             : null,
  learnings      : {
    learnCycles  : 0,
    failuresLearned: 0,
    log          : [],
    formulaFailCounts: { SI:0, ER:0, CI:0, ESI:0, MD:0, EVC:0 }
  }
};

// ‚îÄ‚îÄ‚îÄ FALLBACK STATIC DATA (used when real data unavailable) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STATIC = {
  england: {
    'ARS':{gs:2.8,gc:0.9,wr:0.70},'MCI':{gs:3.0,gc:0.8,wr:0.75},'LIV':{gs:2.7,gc:1.0,wr:0.68},
    'TOT':{gs:2.2,gc:1.3,wr:0.55},'CHE':{gs:2.0,gc:1.2,wr:0.52},'MUN':{gs:1.8,gc:1.4,wr:0.45},
    'NEW':{gs:1.9,gc:1.3,wr:0.48},'AST':{gs:2.0,gc:1.4,wr:0.50},'BHA':{gs:1.8,gc:1.5,wr:0.46},
    'FUL':{gs:1.7,gc:1.5,wr:0.42},'WHU':{gs:1.5,gc:1.7,wr:0.38},'BRE':{gs:1.6,gc:1.7,wr:0.40},
    'NOT':{gs:1.3,gc:1.8,wr:0.33},'WOL':{gs:1.2,gc:1.9,wr:0.30},'BUR':{gs:1.0,gc:2.1,wr:0.25},
    'CRY':{gs:1.1,gc:2.0,wr:0.27},'EVE':{gs:1.0,gc:1.9,wr:0.25},'SUN':{gs:0.9,gc:2.1,wr:0.22}
  },
  germany: {
    'FCB':{gs:3.5,gc:0.7,wr:0.82},'DOR':{gs:2.8,gc:1.2,wr:0.65},'RBL':{gs:2.5,gc:1.2,wr:0.62},
    'LEV':{gs:2.6,gc:1.3,wr:0.62},'WOL':{gs:2.0,gc:1.5,wr:0.50},'FRE':{gs:1.8,gc:1.6,wr:0.45},
    'HOF':{gs:1.9,gc:1.8,wr:0.46},'UNI':{gs:1.5,gc:1.7,wr:0.38},'STU':{gs:1.8,gc:1.6,wr:0.44},
    'WER':{gs:1.6,gc:1.8,wr:0.40},'COL':{gs:1.3,gc:2.0,wr:0.32},'MAI':{gs:1.2,gc:1.8,wr:0.30},
    'HSV':{gs:1.0,gc:2.2,wr:0.25},'HEI':{gs:0.9,gc:2.1,wr:0.23},'STP':{gs:0.8,gc:2.3,wr:0.20}
  },
  italy: {
    'INT':{gs:2.5,gc:0.9,wr:0.68},'MIL':{gs:2.4,gc:1.0,wr:0.65},'NAP':{gs:2.3,gc:1.0,wr:0.62},
    'ATA':{gs:2.8,gc:1.3,wr:0.65},'JUV':{gs:1.9,gc:0.9,wr:0.58},'ROM':{gs:2.1,gc:1.4,wr:0.55},
    'LAZ':{gs:1.8,gc:1.4,wr:0.50},'FIO':{gs:1.7,gc:1.5,wr:0.47},'BOL':{gs:1.6,gc:1.5,wr:0.44},
    'TOR':{gs:1.3,gc:1.6,wr:0.35},'VER':{gs:1.4,gc:1.8,wr:0.37},'UDI':{gs:1.2,gc:1.8,wr:0.33},
    'LEC':{gs:1.0,gc:2.0,wr:0.27},'CRE':{gs:0.9,gc:2.1,wr:0.23},'PAR':{gs:1.0,gc:2.0,wr:0.25}
  },
  spain: {
    'RMA':{gs:2.9,gc:0.8,wr:0.75},'BAR':{gs:2.8,gc:0.9,wr:0.72},'ATM':{gs:1.8,gc:0.8,wr:0.60},
    'SEV':{gs:1.9,gc:1.3,wr:0.52},'VIL':{gs:2.1,gc:1.3,wr:0.55},'RSO':{gs:1.7,gc:1.3,wr:0.48},
    'BET':{gs:1.8,gc:1.4,wr:0.50},'ATH':{gs:1.6,gc:1.3,wr:0.46},'CEL':{gs:1.8,gc:1.7,wr:0.48},
    'GET':{gs:1.3,gc:1.5,wr:0.38},'VAL':{gs:1.4,gc:1.6,wr:0.38},'OSA':{gs:1.2,gc:1.5,wr:0.34},
    'ALA':{gs:1.0,gc:1.9,wr:0.27},'ELC':{gs:0.9,gc:2.1,wr:0.23},'GIR':{gs:1.1,gc:1.8,wr:0.30}
  },
  france: {
    'PSG':{gs:3.2,gc:0.7,wr:0.80},'ASM':{gs:2.7,gc:1.2,wr:0.65},'MAR':{gs:2.2,gc:1.3,wr:0.58},
    'REN':{gs:1.9,gc:1.4,wr:0.50},'LEN':{gs:1.8,gc:1.3,wr:0.48},'NIC':{gs:1.6,gc:1.4,wr:0.44},
    'LYO':{gs:1.8,gc:1.6,wr:0.47},'LIL':{gs:1.6,gc:1.3,wr:0.46},'STR':{gs:1.5,gc:1.6,wr:0.40},
    'TOU':{gs:1.4,gc:1.6,wr:0.38},'BRE':{gs:1.3,gc:1.7,wr:0.35},'NAN':{gs:1.2,gc:1.7,wr:0.32},
    'ANG':{gs:0.9,gc:2.1,wr:0.23},'LOR':{gs:1.0,gc:2.0,wr:0.25},'HAV':{gs:0.8,gc:2.2,wr:0.20}
  }
};

// ‚îÄ‚îÄ‚îÄ INDEXEDDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open('BetpawaPredictorV5', 2);
    req.onerror = () => rej(req.error);
    req.onsuccess = () => { S.db = req.result; res(); };
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('mlData')) {
        const s = db.createObjectStore('mlData', { keyPath: 'id', autoIncrement: true });
        s.createIndex('roundId', 'roundId');
      }
      if (!db.objectStoreNames.contains('learnings'))
        db.createObjectStore('learnings', { keyPath: 'key' });
      if (!db.objectStoreNames.contains('results')) {
        const r = db.createObjectStore('results', { keyPath: 'id', autoIncrement: true });
        r.createIndex('roundId', 'roundId');
      }
    };
  });
}
function dbGet(store, key) {
  return new Promise(r => { if (!S.db) return r(null); const tx = S.db.transaction(store, 'readonly'); const req = tx.objectStore(store).get(key); req.onsuccess = () => r(req.result); req.onerror = () => r(null); });
}
function dbPut(store, val) {
  return new Promise(r => { if (!S.db) return r(false); const tx = S.db.transaction(store, 'readwrite'); tx.objectStore(store).put(val); tx.oncomplete = () => r(true); tx.onerror = () => r(false); });
}
function dbAdd(store, val) {
  return new Promise(r => { if (!S.db) return r(false); const tx = S.db.transaction(store, 'readwrite'); tx.objectStore(store).add(val); tx.oncomplete = () => r(true); tx.onerror = () => r(false); });
}
function dbGetAll(store) {
  return new Promise(r => { if (!S.db) return r([]); const tx = S.db.transaction(store, 'readonly'); const req = tx.objectStore(store).getAll(); req.onsuccess = () => r(req.result || []); req.onerror = () => r([]); });
}
function dbCount(store) {
  return new Promise(r => { if (!S.db) return r(0); const tx = S.db.transaction(store, 'readonly'); const req = tx.objectStore(store).count(); req.onsuccess = () => r(req.result); req.onerror = () => r(0); });
}
function dbClear(store) {
  return new Promise(r => { if (!S.db) return r(false); const tx = S.db.transaction(store, 'readwrite'); tx.objectStore(store).clear(); tx.oncomplete = () => r(true); tx.onerror = () => r(false); });
}

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = {
  async fetchWithTimeout(url, opts = {}, ms = 14000) {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, { ...opts, signal: ctrl.signal });
      clearTimeout(timer);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    } catch (e) { clearTimeout(timer); throw e; }
  },
  async get(path, retries = 2) {
    let last;
    for (let i = 0; i <= retries; i++) {
      try {
        if (i > 0) await delay(2000 * i);
        return await this.fetchWithTimeout(API_BASE + path, {
          headers: { 'X-Pawa-Brand': API_BRAND, 'Content-Type': 'application/json' }
        });
      } catch (e) { last = e; }
    }
    throw last;
  },
  fetchSeasons() { return this.get('/api/sportsbook/virtual/v1/seasons/list/actual'); },
  fetchRound(id, page) { return this.get(`/api/sportsbook/virtual/v2/events/list/by-round/${id}?page=${page}`); }
};

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚îÄ‚îÄ‚îÄ PARSE RESULT SCORE FROM EVENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseScore(event) {
  try {
    const parts = event.participants || [];
    const home = parts.find(p => p.position === 0);
    const away = parts.find(p => p.position === 1);
    if (!home || !away) return null;
    const pp = event.results?.participantPeriodResults;
    if (!pp) return null;
    function getGoals(id) {
      const pd = pp.find(p => p.participant?.id === String(id));
      if (!pd) return null;
      const ft = pd.periodResults?.find(r => r.period?.slug === 'FULL_TIME_EXCLUDING_OVERTIME' && r.type === 'SCORE');
      if (ft) return parseInt(ft.result, 10);
      let tot = 0, found = false;
      for (const r of (pd.periodResults || [])) {
        if ((r.period?.slug === 'FIRST_HALF' || r.period?.slug === 'SECOND_HALF') && r.type === 'SCORE') {
          tot += parseInt(r.result || '0', 10); found = true;
        }
      }
      return found ? tot : null;
    }
    const hg = getGoals(home.id), ag = getGoals(away.id);
    if (hg === null || ag === null) return null;
    return { homeCode: home.name, awayCode: away.name, homeGoals: hg, awayGoals: ag, totalGoals: hg + ag };
  } catch { return null; }
}

// ‚îÄ‚îÄ‚îÄ TEAM STATS ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initTeamStats(code) {
  if (!S.teamStats[code]) {
    S.teamStats[code] = {
      code, matches: 0, goalsScored: 0, goalsConceded: 0,
      wins: 0, draws: 0, losses: 0,
      form: [],        // [{scored, conceded, totalGoals, margin}]
      tablePos: 10,
      source: 'static'
    };
  }
}

function recordMatch(homeCode, homeGoals, awayCode, awayGoals) {
  initTeamStats(homeCode); initTeamStats(awayCode);
  const h = S.teamStats[homeCode], a = S.teamStats[awayCode];
  const total = homeGoals + awayGoals;
  // Home team
  h.matches++; h.goalsScored += homeGoals; h.goalsConceded += awayGoals;
  if (homeGoals > awayGoals) h.wins++;
  else if (homeGoals === awayGoals) h.draws++;
  else h.losses++;
  h.form.unshift({ scored: homeGoals, conceded: awayGoals, totalGoals: total, margin: homeGoals - awayGoals });
  if (h.form.length > 15) h.form.pop();
  // Away team
  a.matches++; a.goalsScored += awayGoals; a.goalsConceded += homeGoals;
  if (awayGoals > homeGoals) a.wins++;
  else if (awayGoals === homeGoals) a.draws++;
  else a.losses++;
  a.form.unshift({ scored: awayGoals, conceded: homeGoals, totalGoals: total, margin: awayGoals - homeGoals });
  if (a.form.length > 15) a.form.pop();
}

function computeAllStats() {
  const codes = Object.keys(S.teamStats);
  // Compute derived stats
  for (const code of codes) {
    const t = S.teamStats[code];
    if (t.matches < 1) continue;
    t.gsAvg = t.goalsScored / t.matches;
    t.gcAvg = t.goalsConceded / t.matches;
    t.winRate = t.wins / t.matches;
    t.drawRate = t.draws / t.matches;
    // OBR
    t.obr = (t.gsAvg / (t.gcAvg + 0.1)) + (t.gsAvg / LEAGUE_AVG_GOALS);
    t.obrClass = classifyTeam(t.obr);
    // Form stats
    const last3 = t.form.slice(0, 3);
    t.lastThreeScored = last3.reduce((s, g) => s + g.scored, 0);
    t.lastThreeConceded = last3.reduce((s, g) => s + g.conceded, 0);
    const last10 = t.form.slice(0, 10);
    t.overRate10 = last10.length > 0 ? last10.filter(g => g.totalGoals > 2).length / last10.length : 0;
    t.lastMatchMargin = t.form.length > 0 ? t.form[0].margin : 0;
    t.source = t.matches >= MIN_REAL_MATCHES ? 'real' : 'static';
  }
  // Compute table positions (by win rate descending)
  const sorted = [...codes].sort((a, b) => (S.teamStats[b].winRate || 0) - (S.teamStats[a].winRate || 0));
  sorted.forEach((code, i) => { S.teamStats[code].tablePos = i + 1; });
}

function getEffectiveStats(code, leagueKey) {
  const real = S.teamStats[code];
  if (real && real.matches >= MIN_REAL_MATCHES) return real;
  // Fallback to static
  const staticData = leagueKey && STATIC[leagueKey] ? STATIC[leagueKey][code] : null;
  if (!staticData) return real || { gsAvg: 1.2, gcAvg: 1.5, winRate: 0.35, drawRate: 0.25, obr: 0.6, obrClass: { class: 'NEUTRAL', label: '‚ö™ Neutral', color: 'var(--text2)', eligible: false }, lastThreeScored: 3, lastMatchMargin: 0, form: [], tablePos: 10, source: 'static', code, matches: 0 };
  const gs = staticData.gs, gc = staticData.gc, wr = staticData.wr;
  const obr = (gs / (gc + 0.1)) + (gs / LEAGUE_AVG_GOALS);
  return {
    code, gsAvg: gs, gcAvg: gc, winRate: wr, drawRate: 0.25, obr,
    obrClass: classifyTeam(obr), lastThreeScored: Math.round(gs * 3),
    lastMatchMargin: wr >= 0.5 ? 1 : -1, form: [], tablePos: Math.round((1 - wr) * 15) + 1,
    source: 'static', matches: 0
  };
}

// ‚îÄ‚îÄ‚îÄ OBR CLASSIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function classifyTeam(obr) {
  if (obr > T.obrGiant)    return { class: 'GIANT',   label: '‚≠ê Engine Giant',   color: 'var(--giant)',   eligible: true,  badgeClass: 'obr-giant'  };
  if (obr >= T.obrChaosMin) return { class: 'CHAOS',   label: 'üí• Chaos Engine',  color: 'var(--chaos)',   eligible: true,  badgeClass: 'obr-chaos'  };
  if (obr <= OBR_BLANKET_MAX) return { class: 'BLANKET', label: 'üß± Wet Blanket', color: 'var(--blanket)', eligible: false, badgeClass: 'obr-blanket' };
  return                           { class: 'NEUTRAL',  label: '‚ö™ Neutral',       color: 'var(--neutral)', eligible: false, badgeClass: 'obr-neutral' };
}

// ‚îÄ‚îÄ‚îÄ ESTIMATE ODDS FROM STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function estimateOdds(hStats, aStats) {
  const hw = Math.max(0.12, Math.min(0.85, (hStats.winRate || 0.5) * 1.08));
  const dr = Math.max(0.10, Math.min(0.40, ((hStats.drawRate || 0.25) + (aStats.drawRate || 0.25)) / 2));
  const aw = Math.max(0.08, 1 - hw - dr);
  const mg = 1.09;
  return {
    homeOdds: Math.round((mg / hw) * 100) / 100,
    drawOdds: Math.round((mg / dr) * 100) / 100,
    awayOdds: Math.round((mg / aw) * 100) / 100
  };
}

// ‚îÄ‚îÄ‚îÄ MATCHUP TYPE CLASSIFICATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function strengthLabel(winRate) {
  if (winRate > 0.60) return 'STRONG';
  if (winRate >= 0.38) return 'BALANCED';
  return 'WEAK';
}

function getMatchupType(hStats, aStats) {
  const hs = strengthLabel(hStats.winRate || 0.5);
  const as_ = strengthLabel(aStats.winRate || 0.5);
  return { homeStrength: hs, awayStrength: as_, type: `${hs}_vs_${as_}` };
}

// ‚îÄ‚îÄ‚îÄ HIGH SCORER GATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function passHighScorerGate(hStats, aStats) {
  const hOBR = hStats.obr || 0;
  const aOBR = aStats.obr || 0;
  const hClass = classifyTeam(hOBR);
  const aClass = classifyTeam(aOBR);
  return {
    passes    : hClass.eligible && aClass.eligible,
    homeOBR   : hOBR, awayOBR: aOBR,
    homeClass : hClass, awayClass: aClass,
    reason    : !hClass.eligible && !aClass.eligible ? 'Both teams ineligible'
                : !hClass.eligible ? `Home OBR too low (${hOBR.toFixed(2)} < ${T.obrChaosMin})`
                : !aClass.eligible ? `Away OBR too low (${aOBR.toFixed(2)} < ${T.obrChaosMin})` : ''
  };
}

// ‚îÄ‚îÄ‚îÄ FAIL STATE BATTERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function runFailStateBattery(homeCode, awayCode, leagueKey, roundNum, totalRounds) {
  const hStats = getEffectiveStats(homeCode, leagueKey);
  const aStats = getEffectiveStats(awayCode, leagueKey);
  const odds = estimateOdds(hStats, aStats);
  const { homeOdds, drawOdds, awayOdds } = odds;
  const H_form = hStats.lastThreeScored || Math.round((hStats.gsAvg || 1.2) * 3);
  const A_form = aStats.lastThreeScored || Math.round((aStats.gsAvg || 1.2) * 3);
  const G_avg = LEAGUE_AVG_GOALS;
  const { homeStrength, awayStrength } = getMatchupType(hStats, aStats);
  const seasonProgress = Math.min(100, ((roundNum || 10) / (totalRounds || 30)) * 100);

  const checks = [];
  let anyFailed = false;

  // ‚îÄ‚îÄ Formula 1: Strong vs Strong ‚Äî Stalemate Index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (homeStrength === 'STRONG' && awayStrength === 'STRONG') {
    const denom = ((H_form + A_form) / 6) || 0.01;
    const SI = ((homeOdds + awayOdds) / 2) * (2.5 / denom);
    const fail = SI > T.siThreshold;
    if (fail) anyFailed = true;
    checks.push({
      id: 'SI', name: '1. Stalemate Index ‚Äî Strong vs Strong',
      formula: `SI = ((${homeOdds.toFixed(2)} + ${awayOdds.toFixed(2)}) / 2) √ó (2.5 / ((${H_form} + ${A_form}) / 6))`,
      value: SI.toFixed(3), threshold: `> ${T.siThreshold} = FAIL`, fail,
      explanation: fail
        ? `‚ö†Ô∏è FAIL: SI=${SI.toFixed(3)} exceeds ${T.siThreshold}. Two strong teams in equilibrium ‚Üí engine scripts tactical low-score draw or 1-0.`
        : `‚úÖ PASS: SI=${SI.toFixed(3)} ‚â§ ${T.siThreshold}. No gridlock pattern detected.`
    });
  }

  // ‚îÄ‚îÄ Formula 2: Strong vs Balanced ‚Äî Efficiency Ratio ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if ((homeStrength === 'STRONG' && awayStrength === 'BALANCED') ||
      (homeStrength === 'BALANCED' && awayStrength === 'STRONG')) {
    const favOdds = homeStrength === 'STRONG' ? homeOdds : awayOdds;
    const favForm = homeStrength === 'STRONG' ? H_form : A_form;
    const ER = (favForm / 3) - (favOdds * 0.5);
    const fail = ER < T.erThreshold;
    if (fail) anyFailed = true;
    checks.push({
      id: 'ER', name: '2. Efficiency Ratio ‚Äî Strong vs Balanced',
      formula: `ER = ${favForm}/3 - (${favOdds.toFixed(2)} √ó 0.5) = ${ER.toFixed(3)}`,
      value: ER.toFixed(3), threshold: `< ${T.erThreshold} = FAIL`, fail,
      explanation: fail
        ? `‚ö†Ô∏è FAIL: ER=${ER.toFixed(3)} < ${T.erThreshold}. Favorite goals will be choked. Expect tight win (1-0 or 2-0) not an open game.`
        : `‚úÖ PASS: ER=${ER.toFixed(3)} ‚â• ${T.erThreshold}. Efficiency ratio supports goals.`
    });
  }

  // ‚îÄ‚îÄ Formula 3: Strong vs Weak ‚Äî Compassion Index ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if ((homeStrength === 'STRONG' && awayStrength === 'WEAK') ||
      (homeStrength === 'WEAK' && awayStrength === 'STRONG')) {
    const weakCode  = homeStrength === 'WEAK' ? homeCode : awayCode;
    const weakStats = getEffectiveStats(weakCode, leagueKey);
    const weakForm  = homeStrength === 'WEAK' ? H_form : A_form;
    const prevMargin = Math.abs(weakStats.lastMatchMargin || 0);
    const weakAvg = (weakForm / 3) || 0;
    const CI = weakAvg + prevMargin;
    const fail = CI < T.ciThreshold;
    if (fail) anyFailed = true;
    checks.push({
      id: 'CI', name: '3. Compassion Index ‚Äî Strong vs Weak',
      formula: `CI = ${weakAvg.toFixed(2)} + ${prevMargin} = ${CI.toFixed(3)} (weak_avg_scored + last_match_margin)`,
      value: CI.toFixed(3), threshold: `< ${T.ciThreshold} = FAIL`, fail,
      explanation: fail
        ? `‚ö†Ô∏è FAIL: CI=${CI.toFixed(3)} < ${T.ciThreshold}. Weak team just conceded heavily and barely scores. Engine scripts mercy mode ‚Üí controlled 2-0, NOT 5-0.`
        : `‚úÖ PASS: CI=${CI.toFixed(3)} ‚â• ${T.ciThreshold}. Compassion index OK. Goals expected.`
    });
  }

  // ‚îÄ‚îÄ Formula 4: Balanced vs Balanced ‚Äî Entropy/ESI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (homeStrength === 'BALANCED' && awayStrength === 'BALANCED') {
    const oddsDiff = Math.abs(homeOdds - awayOdds);
    const ESI = (1 / (oddsDiff + 0.1)) * (1 / drawOdds) * ((G_avg * 2) / (H_form + A_form + 1));
    const fail = ESI > T.esiThreshold;
    if (fail) anyFailed = true;
    checks.push({
      id: 'ESI', name: '4. Equilibrium Stagnation Index ‚Äî Balanced vs Balanced',
      formula: `ESI = (1/(|${homeOdds.toFixed(2)}-${awayOdds.toFixed(2)}|+0.1)) √ó (1/${drawOdds.toFixed(2)}) √ó (5/(${H_form}+${A_form}+1))`,
      value: ESI.toFixed(3), threshold: `> ${T.esiThreshold} = FAIL`, fail,
      explanation: fail
        ? `‚ö†Ô∏è FAIL: ESI=${ESI.toFixed(3)} > ${T.esiThreshold}. Perfect balance + low recent goals = stagnation. Engine scripts 0-0 or 1-1.`
        : `‚úÖ PASS: ESI=${ESI.toFixed(3)} ‚â§ ${T.esiThreshold}. Some dynamism present.`
    });
  }

  // ‚îÄ‚îÄ Formula 5: Balanced vs Weak ‚Äî Motivation Deficit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if ((homeStrength === 'BALANCED' && awayStrength === 'WEAK') ||
      (homeStrength === 'WEAK' && awayStrength === 'BALANCED')) {
    const balancedCode  = homeStrength === 'BALANCED' ? homeCode : awayCode;
    const weakCode2     = homeStrength === 'WEAK' ? homeCode : awayCode;
    const balStats      = getEffectiveStats(balancedCode, leagueKey);
    const wkStats       = getEffectiveStats(weakCode2, leagueKey);
    const tablePosDiff  = Math.abs((balStats.tablePos || 8) - (wkStats.tablePos || 16));
    const MD = tablePosDiff * (seasonProgress / 100);
    const fail = MD > T.mdThreshold;
    if (fail) anyFailed = true;
    checks.push({
      id: 'MD', name: '5. Motivation Deficit ‚Äî Balanced vs Weak',
      formula: `MD = ${tablePosDiff} √ó (${seasonProgress.toFixed(0)}% / 100) = ${MD.toFixed(3)}`,
      value: MD.toFixed(3), threshold: `> ${T.mdThreshold} = FAIL`, fail,
      explanation: fail
        ? `‚ö†Ô∏è FAIL: MD=${MD.toFixed(3)} > ${T.mdThreshold}. Late season + large table gap = mid-table team going through motions. Under 2.5 expected.`
        : `‚úÖ PASS: MD=${MD.toFixed(3)} ‚â§ ${T.mdThreshold}. Sufficient motivation.`
    });
  }

  // ‚îÄ‚îÄ Formula 6: Weak vs Weak ‚Äî Error Variance Check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (homeStrength === 'WEAK' && awayStrength === 'WEAK') {
    const EVC = (H_form + A_form) / (G_avg * 2);
    const fail = EVC < T.evcThreshold;
    if (fail) anyFailed = true;
    checks.push({
      id: 'EVC', name: '6. Error Variance Check ‚Äî Weak vs Weak',
      formula: `EVC = (${H_form} + ${A_form}) / (${G_avg} √ó 2) = ${EVC.toFixed(3)}`,
      value: EVC.toFixed(3), threshold: `< ${T.evcThreshold} = FAIL`, fail,
      explanation: fail
        ? `‚ö†Ô∏è FAIL: EVC=${EVC.toFixed(3)} < ${T.evcThreshold}. Both teams have been terrible in front of goal. Expect messy 0-0 or 1-0.`
        : `‚úÖ PASS: EVC=${EVC.toFixed(3)} ‚â• ${T.evcThreshold}. Enough recent attack intent.`
    });
  }

  // If no formula applied (shouldn't happen) just add a note
  if (checks.length === 0) {
    checks.push({ id: 'NA', name: 'No applicable formula', formula: 'N/A', value: 'N/A', threshold: 'N/A', fail: false, explanation: 'Matchup type did not trigger any specific fail state formula.' });
  }

  return { anyFailed, checks, matchupType: `${homeStrength} vs ${awayStrength}`, odds };
}

// ‚îÄ‚îÄ‚îÄ CONFIDENCE CALCULATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calculateConfidence(hStats, aStats, gateResult, failResult) {
  let conf = 65; // base
  const avgOBR = ((hStats.obr || 0) + (aStats.obr || 0)) / 2;
  // OBR contribution
  if (avgOBR > 2.5) conf += 18;
  else if (avgOBR > 2.0) conf += 14;
  else if (avgOBR > 1.5) conf += 10;
  else if (avgOBR > 1.0) conf += 5;
  // Form contribution (recent over rate)
  const avgOver10 = ((hStats.overRate10 || 0) + (aStats.overRate10 || 0)) / 2;
  conf += Math.round(avgOver10 * 15);
  // Both Giants?
  if (gateResult.homeClass.class === 'GIANT' && gateResult.awayClass.class === 'GIANT') conf += 5;
  // All fail states cleared?
  const clearedCount = failResult.checks.filter(c => !c.fail).length;
  conf += clearedCount * 2;
  // Cap
  conf = Math.min(96, Math.max(60, conf));
  return conf;
}

// ‚îÄ‚îÄ‚îÄ GENERATE PREDICTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generatePrediction(homeCode, awayCode, leagueKey, roundNum, totalRounds, roundId, season, roundInfo) {
  const hStats = getEffectiveStats(homeCode, leagueKey);
  const aStats = getEffectiveStats(awayCode, leagueKey);
  // Step 1: High Scorer Gate
  const gate = passHighScorerGate(hStats, aStats);
  // Step 2: Fail State Battery
  const failResult = runFailStateBattery(homeCode, awayCode, leagueKey, roundNum, totalRounds);
  // Confidence
  const conf = gate.passes && !failResult.anyFailed ? calculateConfidence(hStats, aStats, gate, failResult) : 0;
  // Determine bet
  const avgOBR = ((hStats.obr || 0) + (aStats.obr || 0)) / 2;
  const bet = avgOBR > 2.5 && conf >= 88 ? 'OVER 3.5 + BTTS' : conf >= 85 ? 'OVER 2.5 + BTTS' : 'OVER 2.5';
  return {
    homeCode, awayCode, leagueKey,
    gate, failResult, confidence: conf,
    bet, hStats, aStats,
    passes: gate.passes && !failResult.anyFailed,
    roundId, season, roundInfo,
    timestamp: Date.now(), outcome: null, actualScore: null
  };
}

// ‚îÄ‚îÄ‚îÄ FETCH & PROCESS DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setProgress(pct, text) {
  const bar = document.getElementById('loaderBar');
  const txt = document.getElementById('loaderText');
  if (bar) bar.style.width = pct + '%';
  if (txt) txt.textContent = text;
}

async function loadHistoricalData(currentRoundId) {
  try {
    setProgress(5, 'Fetching season list...');
    const sd = await API.fetchSeasons();
    const seasons = sd.items || [];
    let pastRounds = [];
    for (const season of seasons) {
      for (const round of (season.rounds || [])) {
        const rStart = new Date(round.tradingTime?.start);
        if (rStart < new Date() && round.id !== currentRoundId)
          pastRounds.push({ seasonId: season.id, roundId: round.id, roundNum: round.name, totalRounds: season.rounds.length });
      }
    }
    pastRounds = pastRounds.slice(-40).reverse();
    if (pastRounds.length === 0) throw new Error('No past rounds found');
    setProgress(10, `Found ${pastRounds.length} past rounds. Parsing match data...`);
    let processed = 0, totalMatches = 0;
    for (let i = 0; i < Math.min(pastRounds.length, 30); i++) {
      const { roundId } = pastRounds[i];
      try {
        const data = await API.fetchRound(roundId, 'resulted');
        for (const event of (data.items || [])) {
          const parsed = parseScore(event);
          if (parsed) { recordMatch(parsed.homeCode, parsed.homeGoals, parsed.awayCode, parsed.awayGoals); totalMatches++; }
        }
        processed++;
        setProgress(10 + Math.round((processed / Math.min(pastRounds.length, 30)) * 80), `Processed ${processed} rounds ¬∑ ${totalMatches} matches...`);
        await delay(200 + Math.random() * 300);
      } catch { /* continue */ }
    }
    computeAllStats();
    S.historyLoaded = true;
    S.totalRealMatches = totalMatches;
    setProgress(100, `‚úÖ ${totalMatches} matches processed ¬∑ OBR computed for ${Object.keys(S.teamStats).length} teams.`);
    updateDQBar();
    setTimeout(() => { const l = document.getElementById('statsLoader'); if (l) l.style.display = 'none'; }, 2000);
    renderStatsTab();
  } catch (e) {
    console.warn('[History]', e.message);
    setProgress(100, `‚ö° Using static OBR data (API unavailable). All formulas active.`);
    // Seed from static
    seedFromStatic();
    computeAllStats();
    setTimeout(() => { const l = document.getElementById('statsLoader'); if (l) l.style.display = 'none'; }, 3000);
    renderStatsTab();
  }
}

function seedFromStatic() {
  for (const [leagueKey, teams] of Object.entries(STATIC)) {
    for (const [code, data] of Object.entries(teams)) {
      initTeamStats(code);
      const t = S.teamStats[code];
      t.matches = 10; // fake min matches
      t.goalsScored = data.gs * 10;
      t.goalsConceded = data.gc * 10;
      t.wins = Math.round(data.wr * 10);
      t.draws = 2;
      t.losses = 10 - t.wins - 2;
      t.lastThreeScored = Math.round(data.gs * 3);
      t.lastMatchMargin = data.wr >= 0.5 ? 1 : -1;
      t.form = Array(10).fill(null).map((_, i) => ({
        scored: data.gs + (Math.random() - 0.5),
        conceded: data.gc + (Math.random() - 0.5),
        totalGoals: data.gs + data.gc + (Math.random() - 0.5),
        margin: data.wr >= 0.5 ? 1 : -1
      }));
    }
  }
}

function updateDQBar() {
  const codes = Object.keys(S.teamStats);
  const giants = codes.filter(c => S.teamStats[c].obrClass?.class === 'GIANT').length;
  el('dqTeams', codes.length);
  el('dqMatches', S.totalRealMatches || codes.length * 10);
  el('dqGiants', giants);
  el('dqDot').className = 'dq-dot ' + (S.historyLoaded ? 'real' : 'static');
  el('dqStatus', S.historyLoaded ? 'Real Data' : 'Static');
}

// ‚îÄ‚îÄ‚îÄ MAIN FETCH & PREDICT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _retryCount = 0;
async function init() {
  const liveDot = el('liveDot'), statusEl = el('liveStatus');
  liveDot.className = 'live-dot loading';
  statusEl.textContent = 'Connecting...';
  try {
    const sd = await API.fetchSeasons();
    _retryCount = 0;
    const now = new Date();
    let targetSeason = null, targetRound = null;
    for (const season of (sd.items || [])) {
      for (const round of (season.rounds || [])) {
        const rs = new Date(round.tradingTime?.start);
        if (rs > now) {
          if (!targetRound || rs < new Date(targetRound.tradingTime.start)) {
            targetSeason = season; targetRound = round;
          }
        }
      }
    }
    if (!targetRound) {
      const s = sd.items[0]; const rounds = s.rounds || [];
      for (let i = rounds.length - 1; i >= 0; i--) {
        if (new Date(rounds[i].tradingTime?.start) <= now) { targetSeason = s; targetRound = rounds[i]; break; }
      }
    }
    if (!targetRound) throw new Error('No target round');
    const evData = await API.fetchRound(targetRound.id, 'upcoming');
    const totalRounds = targetSeason.rounds?.length || 30;
    const roundNum = parseInt(targetRound.name) || 15;
    S.roundInfo = { season: targetSeason, round: targetRound, totalRounds, roundNum };
    liveDot.className = 'live-dot';
    statusEl.textContent = 'LIVE';
    statusEl.style.color = 'var(--green)';
    el('seasonDisplay', 'Season #' + targetSeason.id);
    el('matchdayDisplay', 'MD ' + targetRound.name);
    updateCountdown(targetRound.tradingTime.start);
    // Load history if needed
    if (!S.historyLoaded) await loadHistoricalData(targetRound.id);
    // Generate predictions for this round
    await processUpcomingRound(evData.items || [], targetSeason, targetRound, roundNum, totalRounds);
    // Check if previous round has results
    scheduleResultCheck(targetSeason, targetRound.id, totalRounds);
    scheduleRefresh();
  } catch (e) {
    console.error('[Init]', e.message);
    liveDot.className = 'live-dot offline';
    statusEl.textContent = 'Offline ‚Äî Static Mode';
    statusEl.style.color = 'var(--orange)';
    _retryCount++;
    if (_retryCount <= 3) setTimeout(init, _retryCount * 10000);
    else { staticFallbackMode(); _retryCount = 0; }
  }
}

function staticFallbackMode() {
  if (!S.historyLoaded) { seedFromStatic(); computeAllStats(); }
  const now = new Date();
  const fakeRoundNum = Math.floor(now.getMinutes() / 3) + 1;
  const nextRound = new Date(now.getTime() + (3 * 60 * 1000 - now.getTime() % (3 * 60 * 1000)));
  const allCodes = Object.keys(S.teamStats);
  const shuffled = [...allCodes].sort(() => Math.sin(Date.now()) - 0.5);
  const fakeEvents = [];
  for (let i = 0; i + 1 < shuffled.length && fakeEvents.length < 8; i += 2) {
    fakeEvents.push({ homeCode: shuffled[i], awayCode: shuffled[i + 1] });
  }
  el('seasonDisplay', 'Static Mode');
  el('matchdayDisplay', 'MD ' + fakeRoundNum);
  el('dqDot').className = 'dq-dot static';
  el('dqStatus', 'Static');
  updateCountdown(nextRound.toISOString());
  const fakeSeason = { id: 'STATIC' };
  const fakeRound = { id: 'static_' + Date.now(), name: fakeRoundNum, tradingTime: { start: nextRound.toISOString() } };
  S.roundInfo = { season: fakeSeason, round: fakeRound, totalRounds: 30, roundNum: fakeRoundNum };
  processStaticRound(fakeEvents, fakeSeason, fakeRound, fakeRoundNum, 30);
  renderStatsTab();
}

async function processUpcomingRound(events, season, round, roundNum, totalRounds) {
  const preds = [];
  for (const event of events) {
    if (!event.participants || event.participants.length < 2) continue;
    const homeCode = event.participants.find(p => p.position === 0)?.name;
    const awayCode = event.participants.find(p => p.position === 1)?.name;
    if (!homeCode || !awayCode) continue;
    const leagueApiName = event.competition?.name || '';
    const leagueKey = detectLeague(leagueApiName);
    const pred = generatePrediction(homeCode, awayCode, leagueKey, roundNum, totalRounds, round.id, season, round);
    pred.leagueApiName = leagueApiName;
    pred.roundStart = new Date(round.tradingTime.start);
    preds.push(pred);
    if (pred.passes) await storePrediction(pred);
  }
  S.predictions = preds;
  renderLiveTab(preds, new Date(round.tradingTime.start));
}

function processStaticRound(events, season, round, roundNum, totalRounds) {
  const preds = [];
  for (const ev of events) {
    const { homeCode, awayCode } = ev;
    const leagueKey = detectLeagueFromCode(homeCode);
    const pred = generatePrediction(homeCode, awayCode, leagueKey, roundNum, totalRounds, round.id, season, round);
    pred.leagueApiName = leagueKey ? leagueKey.charAt(0).toUpperCase() + leagueKey.slice(1) : 'Virtual League';
    pred.roundStart = new Date(round.tradingTime.start);
    preds.push(pred);
  }
  S.predictions = preds;
  renderLiveTab(preds, new Date(round.tradingTime.start));
}

function detectLeague(apiName) {
  const n = (apiName || '').toLowerCase();
  if (n.includes('english') || n.includes('england')) return 'england';
  if (n.includes('german') || n.includes('bundesliga')) return 'germany';
  if (n.includes('italian') || n.includes('serie') || n.includes('italy')) return 'italy';
  if (n.includes('spanish') || n.includes('la liga') || n.includes('spain')) return 'spain';
  if (n.includes('french') || n.includes('ligue') || n.includes('france')) return 'france';
  return 'england';
}

function detectLeagueFromCode(code) {
  for (const [key, teams] of Object.entries(STATIC)) { if (teams[code]) return key; }
  return 'england';
}

function scheduleRefresh() {
  if (S.refreshTimeout) clearTimeout(S.refreshTimeout);
  S.refreshTimeout = setTimeout(init, 30000 + Math.random() * 10000);
}

// ‚îÄ‚îÄ‚îÄ RESULT CHECKING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scheduleResultCheck(season, currentRoundId, totalRounds) {
  // Check if there's a recently completed round
  setTimeout(() => checkPreviousRoundResults(season, currentRoundId, totalRounds), 5000);
}

async function checkPreviousRoundResults(season, currentRoundId, totalRounds) {
  try {
    const seasons = (await API.fetchSeasons()).items || [];
    for (const s of seasons) {
      const rounds = s.rounds || [];
      const currentIdx = rounds.findIndex(r => r.id === currentRoundId);
      if (currentIdx > 0) {
        const prevRound = rounds[currentIdx - 1];
        const data = await API.fetchRound(prevRound.id, 'resulted');
        const resultMap = {};
        for (const event of (data.items || [])) {
          const parsed = parseScore(event);
          if (parsed) resultMap[`${parsed.homeCode}_${parsed.awayCode}`] = parsed;
        }
        await matchResultsToPredictions(resultMap, prevRound.id);
        break;
      }
    }
  } catch (e) { console.warn('[ResultCheck]', e.message); }
}

async function matchResultsToPredictions(resultMap, roundId) {
  const allPreds = await dbGetAll('mlData');
  let updatedCount = 0;
  for (const pred of allPreds) {
    if (pred.roundId !== roundId || pred.outcome !== null) continue;
    const key = `${pred.homeCode}_${pred.awayCode}`;
    const actual = resultMap[key];
    if (!actual) continue;
    const wasOver = actual.totalGoals > 2;
    const predictedOver = pred.bet.includes('OVER 2.5') || pred.bet.includes('OVER 3.5');
    pred.outcome = predictedOver === wasOver ? 'correct' : 'incorrect';
    pred.actualScore = `${actual.homeGoals} - ${actual.awayGoals}`;
    pred.actualGoals = actual.totalGoals;
    await dbPut('mlData', pred);
    updatedCount++;
    // Add to results display
    S.results.unshift({ ...pred, resolvedAt: Date.now() });
  }
  if (updatedCount > 0) {
    pruneResultsWindow();
    renderResultsTab();
    await runSelfLearning();
    updateResultsBadge();
  }
}

function pruneResultsWindow() {
  // Keep rolling window: max MAX_RESULTS_SHOWN, clear oldest every RESULTS_PAGE_SIZE
  if (S.results.length > MAX_RESULTS_SHOWN) {
    S.results = S.results.slice(0, MAX_RESULTS_SHOWN);
  }
}

// ‚îÄ‚îÄ‚îÄ SELF-LEARNING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runSelfLearning() {
  const allPreds = await dbGetAll('mlData');
  const completed = allPreds.filter(p => p.outcome !== null);
  if (completed.length < 5) return;
  const wrong = completed.filter(p => p.outcome === 'incorrect');
  const correct = completed.filter(p => p.outcome === 'correct');
  const accuracy = correct.length / completed.length;
  const notes = [];
  // If accuracy is below 60%, tighten OBR threshold
  if (accuracy < 0.60 && completed.length >= 10) {
    T.obrGiant = Math.min(2.20, T.obrGiant + 0.05);
    T.obrChaosMin = Math.min(1.10, T.obrChaosMin + 0.05);
    notes.push(`[${ts()}] Accuracy ${(accuracy * 100).toFixed(0)}% < 60% ‚Üí OBR Giant threshold ‚Üë to ${T.obrGiant.toFixed(2)}`);
  }
  // If accuracy is high, can slightly relax
  if (accuracy > 0.80 && completed.length >= 10) {
    T.obrGiant = Math.max(1.60, T.obrGiant - 0.02);
    notes.push(`[${ts()}] Accuracy ${(accuracy * 100).toFixed(0)}% > 80% ‚Üí OBR Giant threshold ‚Üì to ${T.obrGiant.toFixed(2)}`);
  }
  // Check which fail state formulas were active in wrong predictions
  const formulaFailCounts = { SI: 0, ER: 0, CI: 0, ESI: 0, MD: 0, EVC: 0 };
  for (const p of wrong) {
    if (p.checks) {
      for (const c of p.checks) {
        if (!c.fail && formulaFailCounts[c.id] !== undefined) formulaFailCounts[c.id]++;
      }
    }
  }
  // Tighten whichever formula passed most frequently in wrong predictions
  if (formulaFailCounts.SI >= 2) { T.siThreshold = Math.max(1.20, T.siThreshold - 0.05); notes.push(`[${ts()}] SI false passes ‚Üí threshold tightened to ${T.siThreshold.toFixed(2)}`); }
  if (formulaFailCounts.ER >= 2) { T.erThreshold = Math.min(0.80, T.erThreshold + 0.05); notes.push(`[${ts()}] ER false passes ‚Üí threshold tightened to ${T.erThreshold.toFixed(2)}`); }
  if (formulaFailCounts.ESI >= 2) { T.esiThreshold = Math.max(1.60, T.esiThreshold - 0.10); notes.push(`[${ts()}] ESI false passes ‚Üí threshold tightened to ${T.esiThreshold.toFixed(2)}`); }
  if (formulaFailCounts.MD >= 2) { T.mdThreshold = Math.max(3.50, T.mdThreshold - 0.25); notes.push(`[${ts()}] MD false passes ‚Üí threshold tightened to ${T.mdThreshold.toFixed(2)}`); }
  if (formulaFailCounts.EVC >= 2) { T.evcThreshold = Math.min(1.10, T.evcThreshold + 0.05); notes.push(`[${ts()}] EVC false passes ‚Üí threshold tightened to ${T.evcThreshold.toFixed(2)}`); }
  S.learnings.learnCycles++;
  S.learnings.failuresLearned += wrong.length;
  S.learnings.log = [...notes, ...S.learnings.log].slice(0, 80);
  await dbPut('learnings', { key: 'thresholds', T, learnings: S.learnings, updated: Date.now() });
  renderMLTab();
  notes.forEach(n => console.log(n));
}

function ts() { return new Date().toLocaleTimeString(); }

async function loadLearnings() {
  const saved = await dbGet('learnings', 'thresholds');
  if (saved) {
    if (saved.T) Object.assign(T, saved.T);
    if (saved.learnings) Object.assign(S.learnings, saved.learnings);
  }
}

// ‚îÄ‚îÄ‚îÄ ML DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function storePrediction(pred) {
  await dbAdd('mlData', {
    timestamp: pred.timestamp, roundId: pred.roundId,
    homeCode: pred.homeCode, awayCode: pred.awayCode,
    leagueKey: pred.leagueKey, bet: pred.bet, confidence: pred.confidence,
    homeOBR: pred.hStats?.obr || 0, awayOBR: pred.aStats?.obr || 0,
    homeClass: pred.gate?.homeClass?.class, awayClass: pred.gate?.awayClass?.class,
    matchupType: pred.failResult?.matchupType,
    checks: pred.failResult?.checks || [],
    outcome: null, actualScore: null, actualGoals: null
  });
}

async function downloadMLData() {
  const records = await dbGetAll('mlData');
  if (!records.length) { alert('No data yet!'); return; }
  const blob = new Blob([JSON.stringify({ exportDate: new Date().toISOString(), version: '5.0', engine: 'OBR + 6 Fail State Formulas', thresholds: T, totalRecords: records.length, data: records }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `betpawa_obr_v5_${records.length}records_${Date.now()}.json`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
async function confirmClearML() {
  if (confirm('Delete ALL ML data?')) { await dbClear('mlData'); renderMLTab(); alert('Cleared.'); }
}

// ‚îÄ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCountdown(isoStart) {
  if (S.countdownInterval) clearInterval(S.countdownInterval);
  function tick() {
    const diff = new Date(isoStart) - new Date();
    const cdEl = el('countdownDisplay');
    if (diff <= 0) { cdEl.textContent = 'LIVE'; cdEl.style.color = 'var(--red)'; return; }
    const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
    cdEl.textContent = m + ':' + String(s).padStart(2, '0');
    cdEl.style.color = m < 2 ? 'var(--red)' : m < 5 ? 'var(--orange)' : 'var(--gold)';
  }
  tick();
  S.countdownInterval = setInterval(tick, 1000);
}

function startCardTimers(roundStart) {
  function update() {
    document.querySelectorAll('.cc-timer').forEach(el => {
      const diff = roundStart - new Date();
      if (diff <= 0) { el.textContent = 'LIVE NOW'; el.className = 'cc-time live'; return; }
      const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
      el.textContent = `${m}m ${String(s).padStart(2, '0')}s`;
      el.className = m < 2 ? 'cc-time urgent' : 'cc-time';
    });
  }
  update();
  if (S.cardTimerInterval) clearInterval(S.cardTimerInterval);
  S.cardTimerInterval = setInterval(update, 1000);
}

// ‚îÄ‚îÄ‚îÄ RENDERERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function el(id, val) {
  const e = typeof id === 'string' ? document.getElementById(id) : id;
  if (!e) return null;
  if (val === undefined) return e;
  if (typeof val === 'string' && !val.includes('<')) e.textContent = val;
  else e.innerHTML = val;
  return e;
}

function renderLiveTab(preds, roundStart) {
  const passedPreds = preds.filter(p => p.passes).sort((a, b) => b.confidence - a.confidence);
  const totalEligible = preds.filter(p => p.gate?.passes).length;
  const badge = el('liveBadge');
  if (badge) { badge.textContent = passedPreds.length; badge.className = passedPreds.length > 0 ? 'badge-count show' : 'badge-count'; }
  el('engineStatus', `üõ°Ô∏è ${passedPreds.length} Cleared ¬∑ ${preds.length - passedPreds.length} Filtered Out ¬∑ ${preds.length} Total Scanned`);
  // Acca builder
  buildAndRenderAcca(passedPreds);
  // Main container
  const container = document.getElementById('liveContainer');
  if (!container) return;
  if (preds.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No Matches This Round</div><div class="empty-desc">Auto-refresh active every 30s.</div></div>`;
    return;
  }
  // Show all predictions (sorted: passed first, then filtered)
  const sorted = [...preds].sort((a, b) => (b.passes ? 1 : 0) - (a.passes ? 1 : 0) || b.confidence - a.confidence);
  let html = '';
  // Summary bar
  html += `<div style="background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;font-size:9px">
    <span style="color:var(--text2)">Scanned: <strong style="color:var(--text)">${preds.length}</strong></span>
    <span style="color:var(--text2)">Gate Pass: <strong style="color:var(--orange)">${totalEligible}</strong></span>
    <span style="color:var(--text2)">Posted: <strong style="color:var(--green)">${passedPreds.length}</strong></span>
    <span style="color:var(--text2)">Filtered: <strong style="color:var(--red)">${preds.length - passedPreds.length}</strong></span>
  </div>`;
  sorted.forEach(pred => { html += renderPredCard(pred, roundStart); });
  container.innerHTML = html;
  startCardTimers(roundStart);
}

function renderPredCard(pred, roundStart) {
  const passed = pred.passes;
  const isUltra = pred.confidence >= 90;
  const gateClass = pred.gate?.passes ? 'gate-pass' : 'gate-fail';
  const gateIcon = pred.gate?.passes ? '‚úÖ' : 'üö´';
  const failIcon = !pred.failResult?.anyFailed ? '‚úÖ' : 'üö®';
  const confColor = pred.confidence >= 88 ? 'var(--gold)' : pred.confidence >= 75 ? 'var(--green)' : 'var(--text2)';

  const formHtml = (form) => {
    if (!form || form.length === 0) return '<span style="font-size:8px;color:var(--text2)">No history</span>';
    return form.slice(0, 5).map(g => {
      const cls = g.totalGoals > 2 ? 'fb-over' : 'fb-under';
      return `<div class="form-box ${cls}">${g.totalGoals}</div>`;
    }).join('');
  };

  return `
  <div class="pred-card ${isUltra && passed ? 'ultra' : ''}" style="border-top:3px solid ${passed ? (isUltra ? 'var(--gold)' : 'var(--green)') : 'var(--red)'}">
    <div class="pred-header">
      <div>
        <div class="pred-match-name">‚öΩ ${pred.homeCode} vs ${pred.awayCode}</div>
        <div class="pred-league-tag">üèÜ ${pred.leagueApiName || pred.leagueKey || 'Virtual'}</div>
        <div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap">
          <span class="obr-badge ${pred.gate?.homeClass?.badgeClass || 'obr-neutral'}">${pred.gate?.homeClass?.label || '?'}</span>
          <span style="font-size:9px;color:var(--text2);align-self:center">vs</span>
          <span class="obr-badge ${pred.gate?.awayClass?.badgeClass || 'obr-neutral'}">${pred.gate?.awayClass?.label || '?'}</span>
        </div>
      </div>
      <div style="text-align:right">
        ${passed ? `<div class="pred-conf-badge ${isUltra ? 'conf-ultra' : 'conf-high'}">${pred.confidence}%</div>` : '<div style="font-size:11px;color:var(--red);font-weight:700;padding:4px">FILTERED</div>'}
      </div>
    </div>

    <!-- GATE BANNER -->
    <div class="gate-banner ${gateClass}" style="margin-bottom:8px">
      <div>
        <div class="gate-label" style="color:${pred.gate?.passes ? 'var(--green)' : 'var(--red)'}">${gateIcon} HIGH SCORER GATE: ${pred.gate?.passes ? 'PASSED' : 'FAILED'}</div>
        <div class="gate-detail" style="color:${pred.gate?.passes ? 'var(--green)' : 'var(--red)'}">
          Home OBR: ${(pred.gate?.homeOBR || 0).toFixed(2)} (${pred.gate?.homeClass?.label || '?'}) ¬∑ Away OBR: ${(pred.gate?.awayOBR || 0).toFixed(2)} (${pred.gate?.awayClass?.label || '?'})
          ${!pred.gate?.passes ? `<br>‚ùå ${pred.gate?.reason}` : ''}
        </div>
      </div>
      <span style="font-size:9px;font-weight:700;color:${pred.gate?.passes ? 'var(--green)' : 'var(--red)'}">OBR ‚â• ${T.obrChaosMin}</span>
    </div>

    ${passed ? `
    <!-- BET RECOMMENDATION -->
    <div class="pred-main-bet">
      <div class="pred-bet-label">üéØ Recommended Bet</div>
      <div class="pred-bet-value">${pred.bet}</div>
    </div>
    ` : ''}

    <!-- OBR PANEL -->
    <div class="obr-panel">
      <div class="obr-panel-title">üìä OBR Analysis ‚Äî Offensive Bias Ratio</div>
      ${[{ code: pred.homeCode, stats: pred.hStats, cls: pred.gate?.homeClass }, { code: pred.awayCode, stats: pred.aStats, cls: pred.gate?.awayClass }].map(t => `
      <div class="obr-team-row">
        <div>
          <div class="obr-team-name">${t.code}</div>
          <div class="obr-stats-row">
            <span class="obr-stat-pill osp-gs">GS: ${(t.stats?.gsAvg || 0).toFixed(2)}</span>
            <span class="obr-stat-pill osp-gc">GC: ${(t.stats?.gcAvg || 0).toFixed(2)}</span>
            <span class="obr-stat-pill osp-obr">OBR: ${(t.stats?.obr || 0).toFixed(2)}</span>
            <span class="obr-stat-pill osp-wr">W%: ${((t.stats?.winRate || 0) * 100).toFixed(0)}%</span>
            <span style="font-size:8px;color:var(--text2)">${t.stats?.source === 'real' ? '‚≠ê Real' : 'üìã Static'}</span>
          </div>
          <div class="form-row">${t.stats?.form?.length ? t.stats.form.slice(0,5).map(f=>`<div class="form-box ${f.totalGoals>2?'fb-over':'fb-under'}">${f.totalGoals}</div>`).join('') : '<span style="font-size:8px;color:var(--text2)">No form data</span>'}</div>
        </div>
        <span class="obr-badge ${t.cls?.badgeClass || 'obr-neutral'}">${t.cls?.label || '?'}</span>
      </div>`).join('')}
    </div>

    <!-- FAIL STATE PANEL -->
    <div class="failstate-panel ${!pred.failResult?.anyFailed ? 'all-clear' : ''}">
      <div class="failstate-title">
        <span style="color:${pred.failResult?.anyFailed ? 'var(--orange)' : 'var(--green)'}">
          ${failIcon} FAIL STATE BATTERY ‚Äî ${pred.failResult?.matchupType || 'Unknown'} Matchup
        </span>
        <span style="font-size:8px;color:var(--text2)">${pred.failResult?.checks?.length || 0} formula(s) applied</span>
      </div>
      ${(pred.failResult?.checks || []).map(c => `
      <div class="fs-check">
        <div class="fs-icon">${c.fail ? '‚ö†Ô∏è' : '‚úÖ'}</div>
        <div class="fs-body">
          <div class="fs-name" style="color:${c.fail ? 'var(--red)' : 'var(--green)'}">${c.name}</div>
          <div class="fs-formula">${c.formula}</div>
          <div class="fs-explanation" style="color:${c.fail ? 'var(--orange)' : 'var(--text2)'}">${c.explanation}</div>
        </div>
        <span class="fs-value-pill ${c.fail ? 'fvp-fail' : c.id === 'NA' ? 'fvp-na' : 'fvp-pass'}">${c.fail ? '‚úó FAIL' : c.id === 'NA' ? 'N/A' : '‚úì PASS'}</span>
      </div>`).join('')}
      ${!pred.failResult?.anyFailed && pred.gate?.passes ? '<div style="background:rgba(0,200,81,.08);border-radius:5px;padding:6px 8px;margin-top:6px;font-size:9px;color:var(--green);font-weight:700">‚úÖ ALL FAIL STATE CHECKS CLEARED ‚Äî Match approved for Over 2.5</div>' : ''}
      ${pred.failResult?.anyFailed ? '<div style="background:rgba(255,152,0,.08);border-radius:5px;padding:6px 8px;margin-top:6px;font-size:9px;color:var(--orange)">‚ö†Ô∏è One or more fail states triggered. Do NOT bet Over 2.5 on this match.</div>' : ''}
    </div>

    ${passed ? generateAnalysisPanel(pred) : ''}

    <!-- COUNTDOWN -->
    <div class="card-countdown">
      <span>‚è±</span><span class="cc-timer cc-time">Calculating...</span><span>to kick off</span>
    </div>
  </div>`;
}

function generateAnalysisPanel(pred) {
  const conf = pred.confidence;
  const avgOBR = ((pred.hStats?.obr || 0) + (pred.aStats?.obr || 0)) / 2;
  const verdictClass = conf >= 88 ? 'av-safe' : conf >= 75 ? 'av-caution' : 'av-danger';
  const verdictText = conf >= 88
    ? `üü¢ STRONG PICK: ${conf}% confidence ¬∑ Both teams are OBR ${avgOBR.toFixed(2)} average ¬∑ All fail states cleared. Recommended bet: ${pred.bet}.`
    : conf >= 75
    ? `üü° MODERATE PICK: ${conf}% confidence. Bet carefully (2-3% bankroll).`
    : `üîµ LOW CONFIDENCE: Marginal pick.`;
  return `
  <div class="analysis-panel">
    <div class="analysis-title">üî¨ Match Analysis</div>
    <div class="analysis-row"><span class="al">Matchup Type</span><span class="av">${pred.failResult?.matchupType || '‚Äî'}</span></div>
    <div class="analysis-row"><span class="al">Avg OBR</span><span class="av" style="color:${avgOBR>1.8?'var(--green)':avgOBR>1?'var(--orange)':'var(--red)'}">${avgOBR.toFixed(2)}</span></div>
    <div class="analysis-row"><span class="al">Formulas Applied</span><span class="av">${pred.failResult?.checks?.length || 0}</span></div>
    <div class="analysis-row"><span class="al">Formulas Cleared</span><span class="av" style="color:var(--green)">${(pred.failResult?.checks || []).filter(c=>!c.fail).length}</span></div>
    <div class="analysis-row"><span class="al">Home Win Rate</span><span class="av">${((pred.hStats?.winRate || 0)*100).toFixed(0)}%</span></div>
    <div class="analysis-row"><span class="al">Away Win Rate</span><span class="av">${((pred.aStats?.winRate || 0)*100).toFixed(0)}%</span></div>
    <div class="analysis-row"><span class="al">Est. Odds (H/D/A)</span><span class="av">${pred.failResult?.odds?.homeOdds || '‚Äî'} / ${pred.failResult?.odds?.drawOdds || '‚Äî'} / ${pred.failResult?.odds?.awayOdds || '‚Äî'}</span></div>
    <div class="analysis-row"><span class="al">Data Source</span><span class="av" style="color:var(--purple)">${pred.hStats?.source === 'real' ? 'Real Data' : 'Static Fallback'}</span></div>
    <div class="analysis-verdict ${verdictClass}">${verdictText}</div>
  </div>`;
}

function buildAndRenderAcca(passedPreds) {
  const eligible = passedPreds.filter(p => p.confidence >= 85).sort((a, b) => b.confidence - a.confidence);
  const container = document.getElementById('accaContainer');
  if (!container) return;
  if (eligible.length < 2) {
    container.innerHTML = ''; return;
  }
  function confToOdds(c) { return Math.round((100 / c) * 1.08 * 100) / 100; }
  let best = null;
  for (let legs = 2; legs <= Math.min(5, eligible.length); legs++) {
    const sel = eligible.slice(0, legs);
    const co = sel.reduce((p, pr) => p * confToOdds(pr.confidence), 1.0);
    if (co >= 2.50 && (!best || co > best.combinedOdds)) {
      best = { legs: sel, combinedOdds: Math.round(co * 100) / 100, avgConf: Math.round(sel.reduce((s, p) => s + p.confidence, 0) / sel.length) };
    }
  }
  if (!best) { container.innerHTML = ''; return; }
  const legsHtml = best.legs.map(p => `
    <div class="acca-leg">
      <div>
        <div class="acca-leg-match">‚öΩ ${p.homeCode} vs ${p.awayCode}</div>
        <div class="acca-leg-bet">üéØ ${p.bet}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:14px;font-weight:900;color:var(--gold);font-family:'Rajdhani',sans-serif">@${confToOdds(p.confidence).toFixed(2)}</div>
        <div style="font-size:8px;color:var(--text2)">${p.confidence}%</div>
      </div>
    </div>`).join('');
  container.innerHTML = `
  <div class="acca-panel">
    <div class="acca-title">‚ö° Best Acca ‚Äî ${best.legs.length} Legs</div>
    <div style="font-size:9px;color:var(--text2);text-align:center;margin-bottom:10px">All picks: OBR Gate ‚úÖ ¬∑ All Fail States Cleared ‚úÖ ¬∑ 85%+ Confidence</div>
    <div class="acca-legs">${legsHtml}</div>
    <div class="acca-totals">
      <div><div class="acca-total-label">Combined Odds</div><div class="acca-total-value">${best.combinedOdds.toFixed(2)}</div></div>
      <div><div class="acca-total-label">Avg Confidence</div><div class="acca-total-value">${best.avgConf}%</div></div>
      <div><div class="acca-total-label">Legs</div><div class="acca-total-value">${best.legs.length}</div></div>
    </div>
  </div>`;
}

function renderResultsTab() {
  const total = S.results.length;
  const correct = S.results.filter(r => r.outcome === 'correct').length;
  const wrong = S.results.filter(r => r.outcome === 'incorrect').length;
  const pending = S.results.filter(r => r.outcome === null || r.outcome === 'pending').length;
  const accuracy = (total - pending) > 0 ? Math.round((correct / (total - pending)) * 100) : null;
  el('rsTotalPreds', total);
  el('rsCorrect', correct);
  el('rsWrong', wrong);
  el('rsPending', pending);
  el('rsAccuracyPct', accuracy !== null ? accuracy + '%' : '‚Äî');
  el('dqAccuracy', accuracy !== null ? accuracy + '%' : '‚Äî');
  const bar = document.getElementById('rsAccuracyBar');
  if (bar) { bar.style.width = (accuracy || 0) + '%'; bar.style.background = accuracy >= 70 ? 'linear-gradient(90deg,var(--green),var(--gold))' : accuracy >= 50 ? 'linear-gradient(90deg,var(--orange),var(--gold))' : 'var(--red)'; }
  const container = document.getElementById('resultsContainer');
  if (!container) return;
  if (S.results.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">No Results Yet</div><div class="empty-desc">Results populate automatically after rounds complete.</div></div>`;
    return;
  }
  container.innerHTML = S.results.map(r => {
    const isCorrect = r.outcome === 'correct', isWrong = r.outcome === 'incorrect', isPending = !r.outcome || r.outcome === 'pending';
    const cardClass = isCorrect ? 'correct' : isWrong ? 'incorrect' : 'pending';
    const badgeClass = isCorrect ? 'rob-correct' : isWrong ? 'rob-incorrect' : 'rob-pending';
    const badgeText = isCorrect ? '‚úÖ CORRECT' : isWrong ? '‚ùå WRONG' : '‚è≥ PENDING';
    const goalsColor = r.actualGoals > 2 ? 'var(--green)' : 'var(--red)';
    const predCorrect = r.bet?.includes('OVER') ? 'Over 2.5' : 'Under 2.5';
    const actualResult = r.actualGoals !== null ? (r.actualGoals > 2 ? 'Over 2.5' : 'Under 2.5') : '‚Äî';
    return `
    <div class="result-card ${cardClass}">
      <div class="result-header">
        <div><div class="result-match">‚öΩ ${r.homeCode} vs ${r.awayCode}</div><div style="font-size:9px;color:var(--text2)">${new Date(r.timestamp).toLocaleString()}</div></div>
        <span class="result-outcome-badge ${badgeClass}">${badgeText}</span>
      </div>
      <div class="result-scores">
        <div class="score-box"><div class="score-label">Our Prediction</div><div class="score-value" style="color:var(--gold)">${r.bet || '‚Äî'}</div></div>
        <div class="score-box"><div class="score-label">Actual Score</div><div class="score-value" style="color:${goalsColor}">${r.actualScore || '‚Äî'}</div></div>
      </div>
      <div class="result-detail">
        Confidence: <strong>${r.confidence}%</strong> ¬∑ OBR: Home ${(r.homeOBR || 0).toFixed(2)} vs Away ${(r.awayOBR || 0).toFixed(2)} ¬∑ Matchup: ${r.matchupType || '‚Äî'}
        ${r.actualGoals !== null ? ` ¬∑ Total Goals: <strong style="color:${goalsColor}">${r.actualGoals}</strong>` : ''}
        ${r.outcome ? ` ¬∑ Predicted: ${predCorrect} ‚Üí Actual: ${actualResult}` : ''}
      </div>
      ${isWrong ? `<div class="failure-insight">üß† Failure logged ‚Üí Self-learning engine will tighten OBR/formula thresholds to prevent repeat. Current accuracy: ${accuracy || '‚Äî'}%</div>` : ''}
    </div>`;
  }).join('');
}

function updateResultsBadge() {
  const newResults = S.results.filter(r => r.outcome !== null && r.outcome !== 'pending').length;
  const badge = el('resultsBadge');
  if (badge) { badge.textContent = newResults; badge.className = newResults > 0 ? 'badge-count show' : 'badge-count'; }
}

function renderStatsTab() {
  const codes = Object.keys(S.teamStats);
  if (codes.length === 0) {
    el('statsTableContent', '<div class="empty-state"><div class="empty-icon">‚è≥</div><div class="empty-title">Loading data...</div></div>');
    return;
  }
  computeAllStats();
  const giants = codes.filter(c => S.teamStats[c].obrClass?.class === 'GIANT');
  const chaos = codes.filter(c => S.teamStats[c].obrClass?.class === 'CHAOS');
  const blankets = codes.filter(c => S.teamStats[c].obrClass?.class === 'BLANKET');
  const neutral = codes.filter(c => S.teamStats[c].obrClass?.class === 'NEUTRAL');
  const summary = document.getElementById('obrClassSummary');
  if (summary) summary.innerHTML = [
    { label: '‚≠ê Giants', count: giants.length, color: 'var(--green)', desc: 'OBR > ' + T.obrGiant.toFixed(2) },
    { label: 'üí• Chaos', count: chaos.length, color: 'var(--orange)', desc: `OBR ${T.obrChaosMin.toFixed(2)}‚Äì${T.obrGiant.toFixed(2)}` },
    { label: 'üß± Blankets', count: blankets.length, color: 'var(--red)', desc: 'OBR < 0.50' }
  ].map(item => `
  <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center">
    <div style="font-size:20px;font-weight:900;color:${item.color};font-family:'Rajdhani',sans-serif">${item.count}</div>
    <div style="font-size:9px;font-weight:700;color:${item.color};margin-top:2px">${item.label}</div>
    <div style="font-size:7px;color:var(--text2);margin-top:2px">${item.desc}</div>
  </div>`).join('');
  const sorted = codes.sort((a, b) => (S.teamStats[b].obr || 0) - (S.teamStats[a].obr || 0));
  const rows = sorted.map(code => {
    const t = S.teamStats[code];
    const cls = t.obrClass || { class: 'NEUTRAL', badgeClass: 'obr-neutral', label: '‚ö™ Neutral' };
    const obrColor = cls.class === 'GIANT' ? 'td-good' : cls.class === 'CHAOS' ? 'td-mid' : cls.class === 'BLANKET' ? 'td-bad' : '';
    const form5 = (t.form || []).slice(0, 5).map(f => f.totalGoals > 2 ? '‚úÖ' : '‚ùå').join('') || '‚Äî';
    return `<tr>
      <td class="td-team">${code}</td>
      <td><span class="obr-badge ${cls.badgeClass}" style="font-size:7px">${cls.label.split(' ').slice(0,2).join(' ')}</span></td>
      <td>${t.matches || '‚Äî'}</td>
      <td class="td-good">${(t.gsAvg || 0).toFixed(2)}</td>
      <td class="td-bad">${(t.gcAvg || 0).toFixed(2)}</td>
      <td class="${obrColor}">${(t.obr || 0).toFixed(2)}</td>
      <td>${((t.winRate || 0)*100).toFixed(0)}%</td>
      <td style="font-size:9px">${form5}</td>
      <td style="font-size:8px;color:var(--text2)">${t.source || 'static'}</td>
    </tr>`;
  }).join('');
  el('statsTableContent', `<table>
    <thead><tr><th>Team</th><th>Class</th><th>G</th><th>GS</th><th>GC</th><th>OBR</th><th>W%</th><th>Form</th><th>Src</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`);
}

function renderMLTab() {
  dbCount('mlData').then(count => {
    el('mlRecords', count.toLocaleString());
    el('mlCycles', S.learnings.learnCycles);
    el('mlFailures', S.learnings.failuresLearned);
    el('adjGiant', T.obrGiant.toFixed(2));
    el('adjChaos', T.obrChaosMin.toFixed(2));
    el('adjSI', T.siThreshold.toFixed(2));
    el('adjER', T.erThreshold.toFixed(2));
    el('adjESI', T.esiThreshold.toFixed(2));
    el('adjMD', T.mdThreshold.toFixed(2));
    el('adjEVC', T.evcThreshold.toFixed(2));
    const log = document.getElementById('learnLog');
    if (log) log.textContent = S.learnings.log.length > 0 ? S.learnings.log.join('\n') : 'No learning events yet...';
  });
}

// ‚îÄ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
  const sec = document.getElementById('tab-' + name);
  if (sec) sec.classList.add('active');
  const tb = document.getElementById('tab-btn-' + name);
  if (tb) tb.classList.add('active');
  const nb = document.getElementById('nav-' + name);
  if (nb) nb.classList.add('active');
  if (name === 'stats') renderStatsTab();
  if (name === 'mldata') renderMLTab();
  if (name === 'results') renderResultsTab();
}

// ‚îÄ‚îÄ‚îÄ PAGE VISIBILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) { if (S.refreshTimeout) clearTimeout(S.refreshTimeout); scheduleRefresh(); }
});

function scheduleRefresh() {
  if (S.refreshTimeout) clearTimeout(S.refreshTimeout);
  S.refreshTimeout = setTimeout(init, 32000 + Math.random() * 8000);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  try {
    await initDB();
    await loadLearnings();
    // Load saved results
    const savedResults = await dbGetAll('mlData');
    S.results = savedResults.filter(r => r.outcome !== null).sort((a, b) => b.timestamp - a.timestamp).slice(0, MAX_RESULTS_SHOWN);
    renderResultsTab();
    updateResultsBadge();
    renderMLTab();
  } catch (e) { console.warn('[DB Init]', e); }
  init();
});
</script>
</body>
</html>
